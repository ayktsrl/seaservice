<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Visas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#f6f8fb}
    .cardish{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.06)}
    .required::after{content:" *";color:#dc3545}
  </style>
</head>
<body class="p-4">
  <div class="container">

    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
      <h4 class="mb-0 fw-bold">Visas</h4>
      <button class="btn btn-success" id="addBtn">+ Add Visa</button>
    </div>

    <div class="cardish p-3">
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle mb-0">
          <thead class="table-primary text-center">
            <tr>
              <th style="width:130px">Actions</th>
              <th>Visa For</th>
              <th>Type</th>
              <th>Number</th>
              <th>Issued</th>
              <th>Expiry</th>
              <th>Place of Issue</th>
              <th>Remarks</th>
            </tr>
          </thead>
          <tbody id="visaList">
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                No visas added yet. Click <b>+ Add Visa</b> to create one.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="alert alert-light border small mt-3">
      <b>Tip:</b> Birden fazla vize ekleyebilirsin. Ülke listesi <code>/options/options-countries.html</code>’dan yüklenir. 
      Vize türleri için opsiyonel olarak <code>/options/options-visa-types.html</code> dosyası ekleyebilirsin.
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal fade" id="visaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="visaForm" novalidate>
          <div class="modal-header">
            <h5 class="modal-title" id="visaModalTitle">Add Visa</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label required">Visa For</label>
                <select id="visaFor" class="form-select" required>
                  <option value="" selected disabled>Select Country / Region</option>
                  <!-- country options injected -->
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label required">Type of Visa</label>
                <input id="visaType" list="dl-visa-types" class="form-control" placeholder="e.g., C1/D, Tourist, Business" required>
                <datalist id="dl-visa-types"></datalist>
              </div>

              <div class="col-md-4">
                <label class="form-label required">Number</label>
                <input id="number" class="form-control" placeholder="e.g., A1234567" required>
              </div>
              <div class="col-md-4">
                <label class="form-label required">Issued</label>
                <input id="issued" type="date" class="form-control" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">Expiry</label>
                <input id="expiry" type="date" class="form-control">
                <div class="form-check mt-1">
                  <input id="noExpiry" class="form-check-input" type="checkbox">
                  <label class="form-check-label" for="noExpiry">No expiry</label>
                </div>
              </div>

              <div class="col-md-6">
                <label class="form-label">Place of Issue</label>
                <input id="place" class="form-control" placeholder="e.g., Istanbul">
              </div>
              <div class="col-md-6">
                <label class="form-label">Remarks</label>
                <input id="remarks" class="form-control" placeholder="Notes (optional)">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" id="saveBtn">Save</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    // yalnız seafarer
    if ((localStorage.getItem('role')||'').toLowerCase()!=='seafarer') window.top.location.href='/index.html';

    import { auth, db } from '/firebase-config.js';
    import {
      collection, addDoc, updateDoc, deleteDoc, getDocs, doc, query, orderBy
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    // DOM
    const visaList   = document.getElementById('visaList');
    const addBtn     = document.getElementById('addBtn');
    const visaForm   = document.getElementById('visaForm');
    const visaModal  = new bootstrap.Modal(document.getElementById('visaModal'));
    const modalTitle = document.getElementById('visaModalTitle');

    const visaFor    = document.getElementById('visaFor');
    const visaType   = document.getElementById('visaType');
    const number     = document.getElementById('number');
    const issued     = document.getElementById('issued');
    const expiry     = document.getElementById('expiry');
    const noExpiry   = document.getElementById('noExpiry');
    const place      = document.getElementById('place');
    const remarks    = document.getElementById('remarks');
    const dlTypes    = document.getElementById('dl-visa-types');

    function esc(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    let uid=null, editId=null;

    // Ülke seçenekleri (options-countries.html varsa onu kullan)
    async function loadCountryOptions(){
      const paths = [
        '/options/options-countries.html',
        '/options-countries.html',
        '/assets/options-countries.html'
      ];
      for (const p of paths) {
        try {
          const r=await fetch(p,{cache:'no-store'});
          if(r.ok){
            const html=await r.text();
            if (html.toLowerCase().includes('select country')) {
              visaFor.innerHTML = html;  // içinde placeholder varsa aynen kullan
            } else {
              visaFor.innerHTML = '<option value="" disabled selected>Select Country / Region</option>' + html;
            }
            // Ek yaygın bölge kısayolları
            visaFor.insertAdjacentHTML('beforeend', `
              <option value="Schengen Area">Schengen Area</option>
              <option value="Multiple Countries">Multiple Countries</option>
            `);
            return;
          }
        } catch {}
      }
      // Fallback kısa liste
      visaFor.innerHTML = `
        <option value="" disabled selected>Select Country / Region</option>
        <option value="Türkiye">Türkiye</option>
        <option value="Greece">Greece</option>
        <option value="Italy">Italy</option>
        <option value="United Kingdom">United Kingdom</option>
        <option value="United States">United States</option>
        <option value="Schengen Area">Schengen Area</option>
      `;
    }

    // Vize tipi önerileri (opsiyonel dosya; yoksa fallback)
    async function loadVisaTypeOptions(){
      const paths = [
        '/options/options-visa-types.html',
        '/options-visa-types.html',
        '/assets/options-visa-types.html'
      ];
      for (const p of paths) {
        try{
          const r=await fetch(p,{cache:'no-store'});
          if(r.ok){ dlTypes.innerHTML = await r.text(); return; }
        }catch{}
      }
      // Fallback yaygın tipler
      dlTypes.innerHTML = `
        <option value="C1/D"></option>
        <option value="Tourist"></option>
        <option value="Business"></option>
        <option value="Transit"></option>
        <option value="Work"></option>
        <option value="Multiple Entry"></option>
        <option value="Schengen"></option>
      `;
    }

    loadCountryOptions();
    loadVisaTypeOptions();

    // Expiry toggle
    noExpiry.addEventListener('change',()=>{
      expiry.disabled = noExpiry.checked;
      if(noExpiry.checked) expiry.value='';
    });

    // Add/Edit aç
    addBtn.addEventListener('click',()=>openModal());
    function openModal(data=null, id=null){
      visaForm.reset();
      noExpiry.checked=false; expiry.disabled=false;
      editId=id;
      modalTitle.textContent = id ? 'Edit Visa' : 'Add Visa';
      if(data){
        visaFor.value  = data.visaFor || '';
        visaType.value = data.visaType || '';
        number.value   = data.number || '';
        issued.value   = data.issued || '';
        if(!data.expiry){ noExpiry.checked=true; expiry.disabled=true; }
        expiry.value   = data.expiry || '';
        place.value    = data.place || '';
        remarks.value  = data.remarks || '';
      }
      visaModal.show();
    }

    // Kaydet
    visaForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!visaForm.checkValidity()){ visaForm.reportValidity(); return; }
      if(!noExpiry.checked && expiry.value && issued.value && expiry.value < issued.value){
        alert('Expiry cannot be before Issued.'); expiry.focus(); return;
      }
      const payload = {
        visaFor:  visaFor.value,
        visaType: visaType.value.trim(),
        number:   number.value.trim(),
        issued:   issued.value,
        expiry:   noExpiry.checked ? '' : (expiry.value || ''),
        place:    place.value.trim(),
        remarks:  remarks.value.trim()
      };
      const base = collection(db, `seafarers/${uid}/cv/visas/items`);
      try{
        if(editId) await updateDoc(doc(base, editId), payload);
        else await addDoc(base, payload);
        await render();
        visaModal.hide();
      }catch(err){ console.error(err); alert('Save failed.'); }
    });

    // Sil
    async function delItem(id){
      if(!confirm('Delete this visa?')) return;
      try{
        const base = collection(db, `seafarers/${uid}/cv/visas/items`);
        await deleteDoc(doc(base,id));
        await render();
      }catch(err){ console.error(err); alert('Delete failed.'); }
    }

    // Listele
    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href='/index.html';
      uid=user.uid; await render();
    });

    async function render(){
      visaList.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">Loading…</td></tr>';
      try{
        const base = collection(db, `seafarers/${uid}/cv/visas/items`);
        const snap = await getDocs(query(base, orderBy('issued','desc'))); // tek orderBy -> index gerekmez

        const rows = [];
        snap.forEach(s => rows.push({ id: s.id, ...s.data() }));

        // İstemci tarafında: önce visaFor A→Z, sonra issued yeni→eski
        rows.sort((a,b)=>
          (a.visaFor||'').localeCompare(b.visaFor||'') ||
          (b.issued||'').localeCompare(a.issued||'')
        );

        if(!rows.length){
          visaList.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No visas added yet. Click <b>+ Add Visa</b> to create one.</td></tr>';
          return;
        }

        visaList.innerHTML='';
        rows.forEach(d=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `
            <td class="text-center">
              <button class="btn btn-sm btn-outline-secondary me-1" data-act="edit">Edit</button>
              <button class="btn btn-sm btn-outline-danger" data-act="del">Delete</button>
            </td>
            <td>${esc(d.visaFor||'')}</td>
            <td>${esc(d.visaType||'')}</td>
            <td>${esc(d.number||'')}</td>
            <td>${esc(d.issued||'')}</td>
            <td>${d.expiry ? esc(d.expiry) : '—'}</td>
            <td>${esc(d.place||'')}</td>
            <td>${esc(d.remarks||'')}</td>
          `;
          tr.querySelector('[data-act="edit"]').addEventListener('click',()=>openModal(d, d.id));
          tr.querySelector('[data-act="del"]').addEventListener('click',()=>delItem(d.id));
          visaList.appendChild(tr);
        });
      }catch(err){
        console.error(err);
        visaList.innerHTML = '<tr><td colspan="8" class="text-danger text-center py-4">Load failed.</td></tr>';
      }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
