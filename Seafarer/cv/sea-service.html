<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Sea Service</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    .form-slide{background:#fff;border-radius:12px;box-shadow:0 1px 12px rgba(0,0,0,.06);display:none;margin-top:12px}
    .form-slide.active{display:block}
    .add-btn{width:40px;height:40px}
    @media (max-width: 992px){ .table{font-size:.9rem} }
  </style>
</head>
<body class="bg-light p-4">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h4 class="fw-bold">Sea Service History</h4>
      <button class="btn btn-success rounded-circle add-btn" onclick="openForm()">+</button>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle">
        <thead class="table-primary text-center">
          <tr>
            <th style="width:110px">Actions</th>
            <th>Rank</th>
            <th>Joined</th>
            <th>Signed Off</th>
            <th>Period (days)</th>
            <th>Vessel</th>
            <th>IMO</th>
            <th>Type</th>
            <th>Flag</th>
            <th>DWT</th>
            <th>GRT</th>
            <th>Engine (kW)</th>
            <th>Main Engine</th>
            <th>Reason</th>
            <th>Owner / Manager</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
        <tfoot><tr><td colspan="15" class="text-center text-muted small">Add your previous sea services.</td></tr></tfoot>
      </table>
    </div>

    <!-- Add/Edit panel -->
    <div id="panel" class="form-slide">
      <form id="form" class="p-3" novalidate>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Rank <span class="text-danger">*</span></label>
            <select id="rank" class="form-select" required>
              <option value="" disabled selected>- Select value -</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Joined <span class="text-danger">*</span></label>
            <input id="joined" type="date" class="form-control" required>
          </div>

          <div class="col-md-4">
            <label class="form-label">Signed Off <span class="text-danger">*</span></label>
            <input id="signed" type="date" class="form-control" required>
          </div>

          <div class="col-md-6">
            <label class="form-label">Vessel name <span class="text-danger">*</span></label>
            <input id="vessel" class="form-control" required placeholder="e.g., M/T Example">
          </div>

          <div class="col-md-3">
            <label class="form-label">IMO number</label>
            <input id="imo" class="form-control" inputmode="numeric" placeholder="e.g., 9234567">
          </div>

          <div class="col-md-3">
            <label class="form-label">Period (days)</label>
            <input id="period" class="form-control" disabled>
          </div>

          <div class="col-md-4">
            <label class="form-label">Type</label>
            <input id="type" class="form-control" list="dl-vtypes" placeholder="e.g., Oil/Chemical Tanker">
            <datalist id="dl-vtypes"></datalist>
          </div>

          <div class="col-md-4">
            <label class="form-label">Flag</label>
            <input id="flag" class="form-control" list="dl-flags" placeholder="e.g., Panama">
            <datalist id="dl-flags"></datalist>
          </div>

          <div class="col-md-4">
            <label class="form-label">Engine (kW)</label>
            <input id="kw" class="form-control" inputmode="numeric" placeholder="e.g., 9800">
          </div>

          <div class="col-md-6">
            <label class="form-label">Main Engine</label>
            <input id="me" class="form-control" placeholder="e.g., MAN B&W 6S50ME-B9">
          </div>

          <div class="col-md-6">
            <label class="form-label">Owner / Manager</label>
            <input id="owner" class="form-control" placeholder="e.g., Navios Tankers Management">
          </div>

          <div class="col-md-6">
            <label class="form-label">Reason for leaving</label>
            <select id="reasonCode" class="form-select">
              <option value="">- Select value -</option>
              <option>End of Contract</option>
              <option>Mutual Agreement</option>
              <option>Resignation</option>
              <option>Early Relief / Family</option>
              <option>Medical</option>
              <option>Performance / Dismissal</option>
              <option>Vessel Sold / Project Completed</option>
              <option>Other</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Details (optional)</label>
            <input id="reasonNotes" class="form-control" placeholder="Short note if needed">
          </div>

          <div class="col-12">
            <label class="form-label">Remarks</label>
            <textarea id="remarks" rows="2" class="form-control" placeholder="Notes (optional)"></textarea>
          </div>
        </div>

        <div class="text-end mt-3">
          <button class="btn btn-primary" id="submitBtn">Add</button>
          <button type="button" class="btn btn-secondary" onclick="closeForm()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { auth, db } from '/firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { collection, addDoc, updateDoc, deleteDoc, getDocs, doc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const rows=document.getElementById('rows');
    const panel=document.getElementById('panel');
    const form=document.getElementById('form');
    const submit=document.getElementById('submitBtn');

    const rank=document.getElementById('rank');
    const joined=document.getElementById('joined');
    const signed=document.getElementById('signed');
    const vessel=document.getElementById('vessel');
    const imo=document.getElementById('imo');
    const type=document.getElementById('type');
    const flag=document.getElementById('flag');
    const dwt=document.getElementById('dwt');
    const grt=document.getElementById('grt');
    const kw=document.getElementById('kw');
    const me=document.getElementById('me');
    const owner=document.getElementById('owner');
    const period=document.getElementById('period');
    const remarks=document.getElementById('remarks');
    const reasonCode=document.getElementById('reasonCode');
    const reasonNotes=document.getElementById('reasonNotes');

    function esc(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',\"'\":'&#39;'}[m])); }
    let userId=null, editId=null;

    window.openForm=(id=null,data=null)=>{
      form.reset(); editId=id; period.value='';
      submit.textContent=id?'Save':'Add';
      panel.classList.add('active');
      if(data){
        rank.value=data.rank||'';
        joined.value=data.joined||'';
        signed.value=data.signed||'';
        vessel.value=data.vessel||'';
        imo.value=data.imo||'';
        type.value=data.type||'';
        flag.value=data.flag||'';
        dwt.value=data.dwt||'';
        grt.value=data.grt||'';
        kw.value=data.kw||'';
        me.value=data.me||'';
        owner.value=data.owner||'';
        remarks.value=data.remarks||'';
        reasonCode.value=data.reasonCode||'';
        reasonNotes.value=data.reasonNotes||'';
      }
    };
    window.closeForm=()=>{panel.classList.remove('active');editId=null;};

    onAuthStateChanged(auth,async user=>{
      if(!user) return location.href='/index.html';
      userId=user.uid;
      await render();
    });

    form.addEventListener('submit',async e=>{
      e.preventDefault();
      if(!form.checkValidity()){form.reportValidity();return;}
      const payload={
        rank:rank.value,
        joined:joined.value,
        signed:signed.value,
        vessel:vessel.value.trim(),
        imo:imo.value.trim(),
        type:type.value.trim(),
        flag:flag.value.trim(),
        dwt:dwt.value.trim(),
        grt:grt.value.trim(),
        kw:kw.value.trim(),
        me:me.value.trim(),
        owner:owner.value.trim(),
        period:period.value||'',
        remarks:remarks.value.trim(),
        reasonCode:reasonCode.value,
        reasonNotes:reasonNotes.value.trim()
      };
      const base=collection(db,`seafarers/${userId}/cv/seaService/items`);
      try{
        if(editId) await updateDoc(doc(base,editId),payload);
        else await addDoc(base,payload);
        await render(); closeForm();
      }catch(err){console.error(err);alert('Save failed.');}
    });

    async function render(){
      rows.innerHTML='<tr><td colspan=\"15\" class=\"text-center text-muted py-4\">Loading…</td></tr>';
      const base=collection(db,`seafarers/${userId}/cv/seaService/items`);
      const snap=await getDocs(base);
      const data=[]; snap.forEach(s=>data.push({id:s.id,...s.data()}));
      if(!data.length){rows.innerHTML='<tr><td colspan=\"15\" class=\"text-center text-muted py-4\">No sea service yet. Click <b>+</b> to add.</td></tr>';return;}
      data.sort((a,b)=>(b.joined||'').localeCompare(a.joined||''));
      rows.innerHTML='';
      for(const d of data){
        const reasonTxt=[d.reasonCode,d.reasonNotes].filter(Boolean).join(' — ');
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class=\"text-center\">
            <button class=\"btn btn-sm btn-outline-secondary me-1\" onclick='openForm(\"${d.id}\", ${JSON.stringify(d).replace(/\"/g,\"&quot;\")})'>Edit</button>
            <button class=\"btn btn-sm btn-outline-danger\" onclick='delItem(\"${d.id}\")'>Delete</button>
          </td>
          <td>${esc(d.rank||'')}</td>
          <td>${esc(d.joined||'')}</td>
          <td>${esc(d.signed||'')}</td>
          <td>${esc(d.period||'')}</td>
          <td>${esc(d.vessel||'')}</td>
          <td>${esc(d.imo||'')}</td>
          <td>${esc(d.type||'')}</td>
          <td>${esc(d.flag||'')}</td>
          <td>${esc(d.dwt||'')}</td>
          <td>${esc(d.grt||'')}</td>
          <td>${esc(d.kw||'')}</td>
          <td>${esc(d.me||'')}</td>
          <td>${esc(reasonTxt||d.remarks||'')}</td>
          <td>${esc(d.owner||'')}</td>
        `;
        rows.appendChild(tr);} }

    window.delItem=async id=>{if(!confirm('Delete item?'))return;
      try{await deleteDoc(doc(db,`seafarers/${userId}/cv/seaService/items/${id}`));await render();}
      catch(err){console.error(err);alert('Delete failed.');}};
  </script>
</body>
</html>
