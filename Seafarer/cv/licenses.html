<!DOCTYPE html>.value
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Licenses</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    @media(max-width:768px){
      .table{font-size:.9rem}
      .btn,.form-control,.form-select,.form-check-label{font-size:.9rem}
      .add-btn{width:40px;height:40px}
    }
    .form-slide{background:#fff;border-radius:10px;box-shadow:0 1px 10px #e3e7ee;margin-bottom:18px;display:none}
    .form-slide.active{display:block}
  </style>
</head>
<body class="bg-light p-4">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h4 class="fw-bold">Licenses</h4>
      <button class="btn btn-success rounded-circle add-btn" onclick="openForm()">+</button>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle">
        <thead class="table-primary text-center">
          <tr>
            <th style="width:100px">Actions</th>
            <th>Type</th>
            <th>Capacity</th>
            <th>Rank</th>
            <th>Number</th>
            <th>Issued</th>
            <th>Expiry</th>
            <th>Place</th>
            <th>Authority</th>
<th>Limitation</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody id="licenseList"></tbody>
        <tfoot><tr><td colspan="11" class="text-center text-muted small">List of all valid licenses.</td></tr></tfoot>
      </table>
    </div>

    <!-- Add/Edit panel -->
    <div id="licenseForm" class="form-slide">
      <form id="form" class="p-3" novalidate>
        <div class="row g-3">
          <!-- License Type -->
          <div class="col-md-6">
            <label class="form-label">License Type <span class="text-danger">*</span></label>
            <select id="licenseType" class="form-select" required>
              <option value="" selected disabled>Select…</option>
              <option value="CERTIFICATE OF COMPETENCY">CERTIFICATE OF COMPETENCY</option>
              <option value="CERTIFICATE OF ENDORSEMENT">CERTIFICATE OF ENDORSEMENT</option>
            </select>
          </div>

          <!-- Capacity (select + other) -->
          <div class="col-md-6">
            <label class="form-label">Capacity <span class="text-danger">*</span></label>
            <select id="capacity" class="form-select" required>
              <option value="" selected disabled>- Select value -</option>
              <!-- options will be injected -->
            </select>
            <input id="capacityOther" class="form-control mt-2 d-none" placeholder="Enter custom capacity">
          </div>

          <!-- Rank (select + other) -->
          <div class="col-md-6">
            <label class="form-label">Rank</label>
            <select id="rank" class="form-select">
              <option value="" selected>- Select value -</option>
              <!-- options will be injected -->
            </select>
            <input id="rankOther" class="form-control mt-2 d-none" placeholder="Enter custom rank">
          </div>

          <div class="col-md-6">
            <label class="form-label">Number</label>
            <input id="number" class="form-control" placeholder="e.g., TR-123456">
          </div>

          <div class="col-md-6">
            <label class="form-label">Issued</label>
            <input id="issued" type="date" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label">Expiry</label>
            <input id="expiry" type="date" class="form-control">
            <div class="form-check mt-1">
              <input id="noExpiry" type="checkbox" class="form-check-input">
              <label class="form-check-label" for="noExpiry">No expiry date</label>
            </div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Place of Issue</label>
            <input id="place" class="form-control" placeholder="e.g., Istanbul">
          </div>

          <div class="col-md-6">
            <label class="form-label">Authority</label>
            <input id="authority" class="form-control" placeholder="e.g., Turkish Maritime Administration">
          </div>
          <div class="col-md-6">
            <label class="form-label">Limitation</label>
            <input id="limitation" class="form-control" placeholder="e.g., —">
          </div>
          <div class="col-12">
            <label class="form-label">Remarks</label>
            <textarea id="remarks" class="form-control" rows="2" placeholder="Notes (optional)"></textarea>
          </div>
        </div>

        <div class="text-end mt-3">
          <button class="btn btn-primary" id="submitBtn">Add</button>
          <button type="button" class="btn btn-secondary" onclick="closeForm()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    // only seafarer
    if ((localStorage.getItem('role')||'').toLowerCase()!=='seafarer') window.top.location.href='/index.html';

    import { auth, db } from '/firebase-config.js';
    import { collection, addDoc, updateDoc, deleteDoc, getDocs, doc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    // DOM
    const list         = document.getElementById('licenseList');
    const formBox      = document.getElementById('licenseForm');
    const form         = document.getElementById('form');
    const submitBtn    = document.getElementById('submitBtn');

    const licenseType  = document.getElementById('licenseType');
    const capacity     = document.getElementById('capacity');
    const capacityOther= document.getElementById('capacityOther');
    const rank         = document.getElementById('rank');
    const rankOther    = document.getElementById('rankOther');
    const number       = document.getElementById('number');
    const issued       = document.getElementById('issued');
    const expiry       = document.getElementById('expiry');
    const noExpiry     = document.getElementById('noExpiry');
    const place        = document.getElementById('place');
    const authority    = document.getElementById('authority');
    const limitation  = document.getElementById('limitation');
    const remarks      = document.getElementById('remarks');

    function esc(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    let userId=null, editId=null;

    // Load Capacity options
    async function loadCapacityOptions() {
      const paths = [
        '/options/options-license-capacity.html',
        '/options-license-capacity.html',
        '/assets/options-license-capacity.html'
      ];
      for (const p of paths){
        try{
          const r = await fetch(p, {cache:'no-store'});
          if(r.ok){
            const html = await r.text();
            if (html.toLowerCase().includes('select value')) {
              capacity.innerHTML = html;
            } else {
              capacity.innerHTML = '<option value="" disabled selected>- Select value -</option>' + html;
            }
            break;
          }
        }catch{}
      }
      // Always add "Other"
      capacity.insertAdjacentHTML('beforeend','<option value="__OTHER__">Other (type manually)</option>');
    }

    // Load Rank options
    async function loadRankOptions() {
      const paths = [
        '/options/options-license-rank.html',
        '/options-license-rank.html',
        '/options/options-ranks.html',      // eski isim
        '/options-ranks.html',
        '/assets/options-license-rank.html'
      ];
      for (const p of paths){
        try{
          const r = await fetch(p, {cache:'no-store'});
          if(r.ok){
            const html = await r.text();
            if (html.toLowerCase().includes('select value')) {
              rank.innerHTML = html;
            } else {
              rank.innerHTML = '<option value="">- Select value -</option>' + html;
            }
            break;
          }
        }catch{}
      }
      // Optional "Other"
      rank.insertAdjacentHTML('beforeend','<option value="__OTHER__">Other (type manually)</option>');
    }

    // Toggle helper for "Other" fields
    function toggleOther(selectEl, otherEl){
      const isOther = selectEl.value === '__OTHER__';
      otherEl.classList.toggle('d-none', !isOther);
      otherEl.required = isOther;
      if(isOther) otherEl.focus();
    }
    capacity.addEventListener('change', ()=>toggleOther(capacity, capacityOther));
    rank.addEventListener('change', ()=>toggleOther(rank, rankOther));
    noExpiry.addEventListener('change', ()=>{ expiry.disabled = noExpiry.checked; if(noExpiry.checked) expiry.value=''; });

    // Read helper (select or other)
    function readValue(selectEl, otherEl){
      return (selectEl.value === '__OTHER__') ? (otherEl.value.trim()) : (selectEl.value);
    }

    // Open/Close form
    window.openForm = (id=null, data=null) => {
      form.reset(); editId=id;
      capacityOther.classList.add('d-none'); capacityOther.required=false; capacityOther.value='';
      rankOther.classList.add('d-none'); rankOther.required=false; rankOther.value='';
      expiry.disabled=false; noExpiry.checked=false;

      submitBtn.textContent = id ? 'Save' : 'Add';
      formBox.classList.add('active');

      if(data){
        // Backward compatibility: prefer licenseType, fallback to type
        const _type = data.licenseType || data.type || '';
        licenseType.value = _type || '';

        // Capacity (select or other)
        setTimeout(()=>{ setSelectOrOther(capacity, capacityOther, data.capacity || ''); }, 0);

        // Rank (select or other)
        setTimeout(()=>{ setSelectOrOther(rank, rankOther, data.rank || ''); }, 0);

        number.value    = data.number    || '';
        issued.value    = data.issued    || '';
        expiry.value    = data.expiry    || '';
        place.value     = data.place     || '';
        authority.value = data.authority || '';
        limitation.value = data.limitation || '';
        remarks.value   = data.remarks   || '';

        if(!data.expiry){ noExpiry.checked=true; expiry.disabled=true; }
      }
    };
    window.closeForm = ()=>{ formBox.classList.remove('active'); editId=null; };

    // Set select or other
    function setSelectOrOther(selectEl, otherEl, value){
      const has = [...selectEl.options].some(o => o.value === value);
      if(value && has){
        selectEl.value = value;
        otherEl.classList.add('d-none'); otherEl.required=false; otherEl.value='';
      }else if(value){
        selectEl.value = '__OTHER__';
        otherEl.classList.remove('d-none'); otherEl.required=true; otherEl.value=value;
      }else{
        selectEl.value = '';
        otherEl.classList.add('d-none'); otherEl.required=false; otherEl.value='';
      }
    }

    // Auth & initial loads
    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href='/index.html';
      await Promise.all([loadCapacityOptions(), loadRankOptions()]);
      userId=user.uid; await render();
    });

    // Save
    form.addEventListener('submit', async e=>{
      e.preventDefault();
      if(!form.checkValidity()){ form.reportValidity(); return; }
      if(!noExpiry.checked && expiry.value && issued.value && expiry.value < issued.value){
        alert('Expiry date cannot be before Issued.'); expiry.focus(); return;
      }

      const payload = {
        licenseType : licenseType.value,                     // new field
        type        : licenseType.value,                     // backward compat
        capacity    : readValue(capacity, capacityOther),    // select or other
        rank        : readValue(rank, rankOther),            // select or other (can be empty)
        number      : number.value.trim(),
        issued      : issued.value,
        expiry      : noExpiry.checked ? '' : (expiry.value || ''),
        place       : place.value.trim(),
        authority   : authority.value.trim(),
        limitation  : limitation.value.trim(),
        remarks     : remarks.value.trim()
      };

      const base = collection(db,`seafarers/${userId}/cv/licenses/items`);
      try{
        if(editId) await updateDoc(doc(base,editId), payload);
        else await addDoc(base, payload);
        await render(); closeForm();
      }catch(err){ console.error(err); alert('Save failed.'); }
    });

    // Render list
    async function render(){
      list.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">Loading…</td></tr>';
      const base = collection(db,`seafarers/${userId}/cv/licenses/items`);
      const snap = await getDocs(base);
      const rows = [];
      snap.forEach(s => rows.push({ id:s.id, ...s.data() }));

      if(!rows.length){
        list.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">No licenses yet. Click <b>+</b> to add.</td></tr>';
        return;
      }

      list.innerHTML='';
      rows.forEach(d=>{
        const typeText = d.licenseType || d.type || '';
        const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="text-center">
        <button class="btn btn-sm btn-outline-secondary me-1"
        onclick='openForm("${d.id}", ${JSON.stringify(d).replace(/"/g,"&quot;")})'>Edit</button>
        <button class="btn btn-sm btn-outline-danger" onclick='delItem("${d.id}")'>Delete</button>
        </td>
        <td>${esc(typeText)}</td>
        <td>${esc(d.capacity||'')}</td>
        <td>${esc(d.rank||'')}</td>
        <td>${esc(d.number||'')}</td>
        <td>${esc(d.issued||'')}</td>
        <td>${d.expiry ? esc(d.expiry) : '—'}</td>
        <td>${esc(d.place||'')}</td>
        <td>${esc(d.authority||'')}</td>
        <td>${esc(d.limitation||'')}</td>       <!-- NEW -->
        <td>${esc(d.remarks||'')}</td>
        `;

        list.appendChild(tr);
      });
    }

    // Delete
    window.delItem = async id => {
      if(!confirm('Delete item?')) return;
      try{
        await deleteDoc(doc(db,`seafarers/${userId}/cv/licenses/items/${id}`));
        await render();
      }catch(err){ console.error(err); alert('Delete failed.'); }
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
