<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Special Skills - Seafarer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="../../style.css"/>
  <style>
    @media (max-width:768px){
      h4{font-size:1.3rem;text-align:center}
      .table{font-size:.9rem}
      .btn,.form-control,.form-check-label{font-size:.9rem}
      .add-btn{width:40px;height:40px;font-size:1.2rem;padding:0}
      .form-slide{padding:15px}
    }
    .form-slide{background:#fff;border-radius:10px;box-shadow:0 1px 10px #e3e7ee;margin-top:12px;display:none}
    .form-slide.active{display:block}
  </style>
</head>
<body class="p-4 bg-light">
  <div class="container bg-white p-3 p-md-4 rounded shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
      <h4 class="fw-bold m-0">Special Skills</h4>
      <button class="btn btn-success rounded-circle add-btn" onclick="openForm()">+</button>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle">
        <thead class="table-primary text-center">
          <tr>
            <th style="width:90px">Actions</th>
            <th>Skill Type</th>
            <th>Vessel</th>
            <th>Rank</th>
            <th>Period</th>
            <th>Charterer / Voyage Info</th>
            <th>Cargo</th>
            <th>Equipment</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody id="skillsList"></tbody>
      </table>
    </div>

    <div id="skillsForm" class="form-slide">
      <form id="form">
        <div class="row g-3">
          <div class="col-md-6"><label class="form-label">Skill Type</label><input id="skillType" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Vessel</label><input id="vessel" class="form-control"></div>
          <div class="col-md-6"><label class="form-label">Rank</label><input id="rank" class="form-control"></div>
          <div class="col-md-6"><label class="form-label">Period</label><input id="period" class="form-control" placeholder="e.g. 2023-01 → 2023-07"></div>
          <div class="col-md-6"><label class="form-label">Charterer / Voyage Info</label><input id="charterer" class="form-control"></div>
          <div class="col-md-6"><label class="form-label">Cargo</label><input id="cargo" class="form-control"></div>
          <div class="col-md-6"><label class="form-label">Equipment</label><input id="equipment" class="form-control"></div>
          <div class="col-12"><label class="form-label">Remarks</label><textarea id="remarks" class="form-control"></textarea></div>
        </div>
        <div class="d-flex justify-content-end gap-2 mt-3">
          <button class="btn btn-primary" id="submitBtn">Add</button>
          <button type="button" class="btn btn-secondary" onclick="closeForm()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:11">
    <div id="toastMsg" class="toast text-bg-primary border-0" role="alert"><div class="d-flex">
      <div class="toast-body" id="toastBody">Saved</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div></div>
  </div>

  <script type="module">
    if ((localStorage.getItem('role')||'').toLowerCase()!=='seafarer') window.top.location.href='../../index.html';

    import { auth, db } from '/firebase-config.js';
    import { collection, addDoc, updateDoc, deleteDoc, getDocs, doc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    let userId=null, editId=null;
    const list=document.getElementById('skillsList');
    const formBox=document.getElementById('skillsForm');
    const form=document.getElementById('form');
    const submitBtn=document.getElementById('submitBtn');
    const toast = new bootstrap.Toast(document.getElementById('toastMsg'));
    const toastBody=document.getElementById('toastBody');

    onAuthStateChanged(auth, async user=>{
      if(!user) return window.location.href='../../index.html';
      userId=user.uid; await render();
    });

    window.openForm=(id=null,data=null)=>{
      formBox.classList.add('active'); submitBtn.textContent=id?'Save':'Add'; editId=id; form.reset();
      if(data){ for(const k in data){ if(form[k]) form[k].value=data[k]||''; } }
    };
    window.closeForm=()=>{ formBox.classList.remove('active'); editId=null; };

    form.addEventListener('submit', async e=>{
      e.preventDefault();
      const data={ skillType:form.skillType.value, vessel:form.vessel.value, rank:form.rank.value, period:form.period.value,
                   charterer:form.charterer.value, cargo:form.cargo.value, equipment:form.equipment.value, remarks:form.remarks.value };
      const base=collection(db,`seafarers/${userId}/cv/specialSkills/items`);
      if(editId) await updateDoc(doc(base,editId),data); else await addDoc(base,data);
      await render(); closeForm(); toastBody.textContent= editId?'Skill updated ✅':'Skill added ✅'; toast.show();
    });

    async function render(){
      list.innerHTML=''; const base=collection(db,`seafarers/${userId}/cv/specialSkills/items`);
      const snap=await getDocs(base);
      snap.forEach(s=>{
        const d=s.data();
        const safe = JSON.stringify(d).replace(/"/g,'&quot;');
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="text-center">
            <button class="btn btn-sm btn-outline-secondary me-1" onclick='openForm("${s.id}", JSON.parse("${safe}"))'>✏️</button>
            <button class="btn btn-sm btn-outline-danger" onclick='del("${s.id}")'>❌</button>
          </td>
          <td>${d.skillType||''}</td><td>${d.vessel||''}</td><td>${d.rank||''}</td><td>${d.period||''}</td>
          <td>${d.charterer||''}</td><td>${d.cargo||''}</td><td>${d.equipment||''}</td><td>${d.remarks||''}</td>`;
        list.appendChild(tr);
      });
    }
    window.del = async id => { if(!confirm('Delete item?')) return; await deleteDoc(doc(db,`seafarers/${userId}/cv/specialSkills/items/${id}`)); await render();
      toastBody.textContent='Skill deleted ❌'; toast.show(); };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
