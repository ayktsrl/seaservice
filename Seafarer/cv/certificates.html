<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Certificates</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#f6f8fb}
    .cardish{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.06)}
    .required::after{content:" *";color:#dc3545}
  </style>
</head>
<body class="p-4">
  <div class="container">

    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
      <h4 class="mb-0 fw-bold">Certificates</h4>
      <button class="btn btn-success" id="addBtn">+ Add</button>
    </div>

    <!-- Liste -->
    <div class="cardish p-3 mb-3">
      <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle mb-0">
          <thead class="table-primary text-center">
            <tr>
              <th style="width:130px">Actions</th>
              <th>Certificate</th>
              <th>STCW Code / Ref.</th>
              <th>Issue</th>
              <th>Expiry</th>
            </tr>
          </thead>
          <tbody id="certList">
            <tr><td colspan="5" class="text-center text-muted py-4">No certificates added yet.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Form -->
    <div id="certForm" class="cardish p-3 d-none">
      <form id="form" novalidate>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label required">Certificate Name</label>
            <input id="name" list="dl-cert-names" class="form-control"
                   placeholder="e.g., Personal Survival Techniques" required>
            <datalist id="dl-cert-names"></datalist>
          </div>
          <div class="col-md-6">
            <label class="form-label required">STCW Code / Reference</label>
            <input id="stcw" class="form-control" placeholder="e.g., A-VI/1-1" required>
          </div>
          <div class="col-md-6">
            <label class="form-label required">Issue Date</label>
            <input id="issue" type="date" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Expiry Date</label>
            <input id="expiry" type="date" class="form-control">
            <div class="form-check mt-1">
              <input id="noExpiry" class="form-check-input" type="checkbox">
              <label class="form-check-label" for="noExpiry">No expiry date</label>
            </div>
          </div>
        </div>
        <div class="text-end mt-3">
          <button class="btn btn-primary" id="submitBtn">Add</button>
          <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
        </div>
      </form>
    </div>

    <div class="alert alert-light border small mt-3">
      <b>Tip:</b> Sertifikaları tek tek ekleyip “Edit” ile güncelleyebilir, “Delete” ile kaldırabilirsin.
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    // yalnızca seafarer girebilsin
    if ((localStorage.getItem('role')||'').toLowerCase()!=='seafarer') window.top.location.href='/index.html';

    import { auth, db } from '/firebase-config.js';
    import {
      collection, addDoc, updateDoc, deleteDoc, getDocs, doc, query, orderBy
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    // DOM
    const list=document.getElementById('certList');
    const formBox=document.getElementById('certForm');
    const form=document.getElementById('form');
    const addBtn=document.getElementById('addBtn');
    const submitBtn=document.getElementById('submitBtn');
    const cancelBtn=document.getElementById('cancelBtn');
    const noExpiry=document.getElementById('noExpiry');
    const expiryInput=document.getElementById('expiry');
    const nameInput=document.getElementById('name');
    const stcwInput=document.getElementById('stcw');
    const dl=document.getElementById('dl-cert-names');

    // helpers
    function esc(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    let uid=null, editId=null;

    // === options-stcw.html'den datalist'i yükle ve auto-fill yap ===
    fetch('/options-stcw.html')
      .then(r=>r.text())
      .then(html=>{ dl.innerHTML=html; })
      .catch(()=>{}); // sessiz

    nameInput.addEventListener('change', ()=>{
      const val = nameInput.value.trim().toLowerCase();
      const opt = Array.from(dl.options).find(o => o.value.trim().toLowerCase() === val);
      if (opt?.dataset?.stcw) stcwInput.value = opt.dataset.stcw;
    });

    // UI events
    addBtn.addEventListener('click', ()=> openForm());
    cancelBtn.addEventListener('click', ()=> closeForm());
    noExpiry.addEventListener('change',()=>{ expiryInput.disabled = noExpiry.checked; if(noExpiry.checked) expiryInput.value=''; });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!form.checkValidity()){ form.reportValidity(); return; }
      if(!noExpiry.checked && form.expiry.value && form.issue.value && form.expiry.value < form.issue.value){
        alert('Expiry date cannot be before issue date.'); form.expiry.focus(); return;
      }
      const data = {
        name: form.name.value.trim(),
        stcw: form.stcw.value.trim(),
        issue: form.issue.value,
        expiry: noExpiry.checked ? '' : (form.expiry.value || '')
      };
      const base=collection(db, `seafarers/${uid}/cv/certificates/items`);
      try{
        if(editId) await updateDoc(doc(base,editId),data); else await addDoc(base,data);
        await render(); closeForm();
      }catch(err){ console.error(err); alert('Save failed.'); }
    });

    function openForm(id=null,data=null){
      form.reset(); noExpiry.checked=false; expiryInput.disabled=false;
      submitBtn.textContent=id?'Save':'Add'; editId=id;
      if(data){ form.name.value=data.name||''; form.stcw.value=data.stcw||''; form.issue.value=data.issue||''; form.expiry.value=data.expiry||''; if(!data.expiry){ noExpiry.checked=true; expiryInput.disabled=true; } }
      formBox.classList.remove('d-none');
      window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    }
    function closeForm(){ formBox.classList.add('d-none'); editId=null; }

    function bindRowActions(tr, id, data){
      tr.querySelector('[data-act="edit"]').addEventListener('click',()=>openForm(id,data));
      tr.querySelector('[data-act="del"]').addEventListener('click',()=>delItem(id));
    }
    async function delItem(id){
      if(!confirm('Delete this certificate?')) return;
      const base=collection(db, `seafarers/${uid}/cv/certificates/items`);
      try{ await deleteDoc(doc(base,id)); await render(); }catch(err){ console.error(err); alert('Delete failed.'); }
    }

    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href='/index.html';
      uid=user.uid; await render();
    });

    async function render(){
      list.innerHTML='<tr><td colspan="5" class="text-center text-muted py-4">Loading…</td></tr>';
      const base=collection(db, `seafarers/${uid}/cv/certificates/items`);
      const snap=await getDocs(query(base, orderBy('issue','desc')));
      if(snap.empty){ list.innerHTML='<tr><td colspan="5" class="text-center text-muted py-4">No certificates added yet.</td></tr>'; return; }
      list.innerHTML='';
      snap.forEach(s=>{
        const d=s.data();
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="text-center">
            <button class="btn btn-sm btn-outline-secondary me-1" data-act="edit">Edit</button>
            <button class="btn btn-sm btn-outline-danger" data-act="del">Delete</button>
          </td>
          <td>${esc(d.name||'')}</td>
          <td>${esc(d.stcw||'')}</td>
          <td>${esc(d.issue||'')}</td>
          <td>${d.expiry ? esc(d.expiry) : '—'}</td>
        `;
        bindRowActions(tr, s.id, d);
        list.appendChild(tr);
      });
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
