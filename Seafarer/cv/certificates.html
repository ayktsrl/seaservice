<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Certificates</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#f6f8fb}
    .form-slide{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.06);margin:18px 0;display:none}
    .form-slide.active{display:block}
    .required::after{content:" *";color:#dc3545}
    .ocr-box{background:#0b5ed7;color:#fff}
    .ocr-progress{height:6px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; max-height: 220px; overflow:auto; background:#f2f4f8; padding:.75rem; border-radius:8px;}
    .detected li{border:1px solid #e7ebf3;border-radius:10px;padding:.6rem .75rem;margin:.5rem 0;background:#fff}
    .detected code{background:#eef2ff;padding:.1rem .35rem;border-radius:.4rem}
  </style>
</head>
<body class="p-4">
  <div class="container">

    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
      <h4 class="mb-0 fw-bold">Certificates</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-secondary" id="scanBtn">Scan from Photo</button>
        <button class="btn btn-success" id="addBtn">+ Add</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle">
        <thead class="table-primary text-center">
          <tr>
            <th style="width:130px">Actions</th>
            <th>Certificate</th>
            <th>STCW Code / Ref.</th>
            <th>Issue</th>
            <th>Expiry</th>
          </tr>
        </thead>
        <tbody id="certList">
          <tr><td colspan="5" class="text-center text-muted py-4">No certificates added yet.</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Editor -->
    <div id="certForm" class="form-slide p-3">
      <form id="form" novalidate>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label required">Certificate Name</label>
            <input id="name" class="form-control" placeholder="e.g., Personal Survival Techniques" required>
          </div>
          <div class="col-md-6">
            <label class="form-label required">STCW Code / Reference</label>
            <input id="stcw" class="form-control" placeholder="e.g., A-VI/1-1" required>
          </div>
          <div class="col-md-6">
            <label class="form-label required">Issue Date</label>
            <input id="issue" type="date" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Expiry Date</label>
            <input id="expiry" type="date" class="form-control">
            <div class="form-check mt-1">
              <input id="noExpiry" class="form-check-input" type="checkbox">
              <label class="form-check-label" for="noExpiry">No expiry date</label>
            </div>
          </div>
        </div>
        <div class="text-end mt-3">
          <button class="btn btn-primary" id="submitBtn">Add</button>
          <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
        </div>
      </form>
    </div>

    <!-- OCR UI -->
    <input id="ocrInput" type="file" accept="image/*" class="d-none">
    <div id="ocrPane" class="form-slide p-3 d-none">
      <div class="p-3 rounded ocr-box">
        <div class="d-flex justify-content-between align-items-center">
          <strong>OCR • Scan from Photo</strong>
          <button class="btn btn-sm btn-light" id="ocrCloseBtn">Close</button>
        </div>
        <div class="progress bg-white mt-2 ocr-progress">
          <div id="ocrProgress" class="progress-bar" role="progressbar" style="width:0%"></div>
        </div>
        <div id="ocrStatus" class="small mt-2">Waiting for image…</div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-md-6">
          <img id="ocrPreview" class="img-fluid rounded border" alt="Preview">
        </div>
        <div class="col-md-6">
          <label class="form-label">Extracted text (for verification)</label>
          <div id="ocrText" class="mono small">—</div>
        </div>
      </div>

      <div id="detectedBox" class="mt-3 d-none">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-2">Detected items</h6>
          <div class="d-flex gap-2">
            <button id="addSelectedBtn" class="btn btn-sm btn-primary">Add selected</button>
            <button id="clearDetectedBtn" class="btn btn-sm btn-outline-secondary">Clear</button>
          </div>
        </div>
        <ul id="detectedList" class="list-unstyled detected"></ul>
        <div class="text-muted small">Tip: “Fill” ile forma atıp düzenleyebilir veya birden fazla satırı seçip “Add selected” ile toplu kaydedebilirsin.</div>
      </div>
    </div>

    <div class="alert alert-light border small mt-3">
      <b>Scan tips:</b> good light, flat document, fill the frame, avoid blur. If the code is misread (<code>A-VI/1</code> → <code>A-V1/1</code> gibi), formda düzeltip kaydedebilirsin.
    </div>
  </div>

  <!-- Firebase & App -->
  <script type="module">
    if ((localStorage.getItem('role')||'').toLowerCase()!=='seafarer') window.top.location.href='/index.html';

    import { auth, db } from '/firebase-config.js';
    import {
      collection, addDoc, updateDoc, deleteDoc, getDocs, doc, query, orderBy
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    let userId=null, editId=null;
    const list=document.getElementById('certList');
    const formBox=document.getElementById('certForm');
    const form=document.getElementById('form');
    const submitBtn=document.getElementById('submitBtn');
    const cancelBtn=document.getElementById('cancelBtn');
    const addBtn=document.getElementById('addBtn');
    const noExpiry=document.getElementById('noExpiry');
    const expiryInput=document.getElementById('expiry');

    // OCR elements
    const scanBtn=document.getElementById('scanBtn');
    const ocrInput=document.getElementById('ocrInput');
    const ocrPane=document.getElementById('ocrPane');
    const ocrCloseBtn=document.getElementById('ocrCloseBtn');
    const ocrPreview=document.getElementById('ocrPreview');
    const ocrText=document.getElementById('ocrText');
    const ocrStatus=document.getElementById('ocrStatus');
    const ocrProgress=document.getElementById('ocrProgress');
    const detectedBox=document.getElementById('detectedBox');
    const detectedList=document.getElementById('detectedList');
    const addSelectedBtn=document.getElementById('addSelectedBtn');
    const clearDetectedBtn=document.getElementById('clearDetectedBtn');

    // UX
    noExpiry.addEventListener('change',()=>{ expiryInput.disabled = noExpiry.checked; if(noExpiry.checked) expiryInput.value=''; });
    addBtn.addEventListener('click', ()=> openForm());
    cancelBtn.addEventListener('click', ()=> closeForm());

    // OCR triggers
    scanBtn.addEventListener('click', ()=> ocrInput.click());
    ocrCloseBtn.addEventListener('click', ()=> ocrPane.classList.add('d-none'));
    ocrInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      await runOCR(file);
    });

    // Save
    form.addEventListener('submit', async e=>{
      e.preventDefault();
      if(!form.checkValidity()){ form.reportValidity(); return; }
      if(!noExpiry.checked && form.expiry.value && form.issue.value && form.expiry.value < form.issue.value){
        alert('Expiry date cannot be before issue date.'); form.expiry.focus(); return;
      }
      const data = {
        name: form.name.value.trim(),
        stcw: form.stcw.value.trim(),
        issue: form.issue.value,
        expiry: noExpiry.checked ? '' : (form.expiry.value || '')
      };
      const base=collection(db, `seafarers/${userId}/cv/certificates/items`);
      try{
        if(editId) await updateDoc(doc(base,editId),data); else await addDoc(base,data);
        await render(); closeForm();
      }catch(err){ console.error(err); alert('Save failed.'); }
    });

    // Edit/Delete
    function bindRowActions(tr, id, data){
      tr.querySelector('[data-act="edit"]').addEventListener('click',()=>openForm(id,data));
      tr.querySelector('[data-act="del"]').addEventListener('click',()=>delItem(id));
    }
    async function delItem(id){
      if(!confirm('Delete this certificate?')) return;
      const base=collection(db, `seafarers/${userId}/cv/certificates/items`);
      try{ await deleteDoc(doc(base,id)); await render(); }catch(err){ console.error(err); alert('Delete failed.'); }
    }

    // Auth & render
    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href='/index.html';
      userId=user.uid; await render();
    });

    async function render(){
      list.innerHTML='<tr><td colspan="5" class="text-center text-muted py-4">Loading…</td></tr>';
      const base=collection(db, `seafarers/${userId}/cv/certificates/items`);
      const snap=await getDocs(query(base, orderBy('issue','desc')));
      if(snap.empty){ list.innerHTML='<tr><td colspan="5" class="text-center text-muted py-4">No certificates added yet.</td></tr>'; return; }
      list.innerHTML='';
      snap.forEach(s=>{
        const d=s.data();
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="text-center">
            <button class="btn btn-sm btn-outline-secondary me-1" data-act="edit">Edit</button>
            <button class="btn btn-sm btn-outline-danger" data-act="del">Delete</button>
          </td>
          <td>${esc(d.name||'')}</td>
          <td>${esc(d.stcw||'')}</td>
          <td>${esc(d.issue||'')}</td>
          <td>${d.expiry ? esc(d.expiry) : '—'}</td>
        `;
        bindRowActions(tr, s.id, d);
        list.appendChild(tr);
      });
    }

    // Editor open/close
    function openForm(id=null,data=null){
      form.reset(); noExpiry.checked=false; expiryInput.disabled=false;
      submitBtn.textContent=id?'Save':'Add'; editId=id;
      if(data){ form.name.value=data.name||''; form.stcw.value=data.stcw||''; form.issue.value=data.issue||''; form.expiry.value=data.expiry||''; if(!data.expiry){ noExpiry.checked=true; expiryInput.disabled=true; } }
      formBox.classList.add('active'); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    }
    function closeForm(){ formBox.classList.remove('active'); editId=null; }

    // Utils
    function esc(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  </script>

  <!-- Tesseract (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script>
    // --- OCR runner (blob URL + recognize) ---
    async function runOCR(file){
      const url = URL.createObjectURL(file);

      const ocrPane = document.getElementById('ocrPane');
      const ocrPreview = document.getElementById('ocrPreview');
      const ocrText = document.getElementById('ocrText');
      const ocrStatus = document.getElementById('ocrStatus');
      const ocrProgress = document.getElementById('ocrProgress');

      ocrPane.classList.remove('d-none');
      ocrPane.classList.add('active');

      ocrPreview.src = url;
      ocrStatus.textContent = 'Recognizing…';
      ocrProgress.style.width = '0%';

      try {
        const { data:{ text } } = await Tesseract.recognize(
          url,
          // Türkçe + İngilizce
          'eng+tur',
          {
            logger: m => {
              if (m.status && m.progress != null) {
                ocrStatus.textContent = `${m.status}… ${(m.progress*100|0)}%`;
                ocrProgress.style.width = `${m.progress*100}%`;
              }
            }
          }
        );
        ocrText.textContent = text || '—';
        ocrStatus.textContent = 'Done. Parsed fields were applied below.';

        // Çoklu satır çıkar
        const rows = extractCertificates(text || '');
        renderDetected(rows);

      } catch (err) {
        console.error(err);
        ocrStatus.textContent = 'OCR failed. Please try another photo.';
      } finally {
        document.getElementById('ocrInput').value = '';
        setTimeout(()=>URL.revokeObjectURL(url), 30000);
      }
    }

    // --- Detected list UI & actions ---
    function renderDetected(items){
      const box = document.getElementById('detectedBox');
      const list = document.getElementById('detectedList');
      list.innerHTML = '';
      if (!items.length){
        box.classList.add('d-none');
        return;
      }
      items.forEach((it, idx)=>{
        const li = document.createElement('li');
        const id = 'pick_' + idx;
        li.innerHTML = `
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="${id}" checked>
                <label for="${id}" class="form-check-label">
                  <b>${esc(it.name || '(name?)')}</b>
                  <div class="text-muted small mt-1">
                    <code>${esc(it.stcw || '(stcw?)')}</code> •
                    Issue: <code>${esc(it.issue || '—')}</code> •
                    Expiry: <code>${esc(it.expiry || '—')}</code>
                  </div>
                </label>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary">Fill</button>
            </div>
          </div>
        `;
        li.querySelector('button').addEventListener('click', ()=>{
          // Forma at
          applyFieldsToForm(it);
          document.getElementById('addBtn').click();
        });
        list.appendChild(li);
      });

      box.classList.remove('d-none');

      // Add selected
      document.getElementById('addSelectedBtn').onclick = async ()=>{
        const picks = [...list.querySelectorAll('input[type="checkbox"]')];
        const selected = picks
          .map((cb,i)=> cb.checked ? items[i] : null)
          .filter(Boolean)
          // minimum doğrulama
          .map(x=>({
            name: x.name || '',
            stcw: x.stcw || '',
            issue: x.issue || '',
            expiry: x.expiry || ''
          }));
        if (!selected.length) return;
        try{
          const uid = (await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js'))
          // sadece mevcut userId üstünden yazıyoruz (userId globalden geliyor)
          const base=collection(db, `seafarers/${userId}/cv/certificates/items`);
          for (const d of selected){ await addDoc(base, d); }
          await (async ()=>{
            // listeyi yenile
            const { getDocs, query, orderBy } =
              await import('https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js');
            list.innerHTML='';
          })();
          // sayfadaki mevcut render() fonksiyonu global scope'ta
          if (typeof render === 'function') render();
          alert('Selected items added.');
        }catch(e){ console.error(e); alert('Bulk add failed.'); }
      };

      document.getElementById('clearDetectedBtn').onclick = ()=>{
        list.innerHTML=''; document.getElementById('detectedBox').classList.add('d-none');
      };
    }

    // --- Parsing helpers ---
    function extractCertificates(raw){
      // normalize whitespaces
      const text = raw.replace(/\r/g,'').replace(/[|]+/g,' ').replace(/\s{2,}/g,' ');
      // find all date pairs (dd.mm.yyyy / dd-mm-yyyy / yyyy.mm.dd)
      const date = '(?:\\d{2}[./-]\\d{2}[./-]\\d{4}|\\d{4}[./-]\\d{2}[./-]\\d{2})';
      const pairRe = new RegExp(`${date}\\s+${date}`, 'g');

      // cut text into blocks between consecutive date pairs
      const blocks = [];
      let m, lastIndex = 0, starts = [];
      while ((m = pairRe.exec(text)) !== null) { starts.push({i:m.index, s:m[0]}); }
      for (let i=0;i<starts.length;i++){
        const start = starts[i].i;
        const end   = (i+1<starts.length) ? starts[i+1].i : text.length;
        blocks.push(text.slice(start, end).trim());
      }

      const items = blocks.map(b => parseBlock(b)).filter(x=>x);
      return items;
    }

    function parseBlock(block){
      // dates
      const ds = findDates(block);
      if (ds.length < 1) return null;
      const issue = toISO(ds[0]) || '';
      const expiry = ds[1] ? toISO(ds[1]) : '';

      // stcw
      const stcw = findSTCW(block);

      // name: between second date and stcw text (or end)
      let nameZone = block;
      if (ds[1]) {
        const afterSecondDate = block.indexOf(ds[1]);
        nameZone = block.slice(afterSecondDate + ds[1].length);
      } else if (ds[0]) {
        const afterFirstDate = block.indexOf(ds[0]);
        nameZone = block.slice(afterFirstDate + ds[0].length);
      }
      if (stcw){
        const stIdx = nameZone.toUpperCase().indexOf(stcw.toUpperCase());
        if (stIdx > 0) nameZone = nameZone.slice(0, stIdx);
      }
      // try to take English half if bilingual like "…/PERSONAL SURVIVAL TECHNIQUES TRAINING CERTIFICATE"
      let name = nameZone.split('/').pop().trim();
      // drop register / numbers / certificate word
      name = name.replace(/\(\d+\)/g,'')
                 .replace(/\b(CERTIFICATE|BELGESI)\b/ig,'')
                 .replace(/\s{2,}/g,' ')
                 .trim();
      // upper-case tighten
      if (name.length < 6) name = nameZone.trim();

      return { name, stcw, issue, expiry };
    }

    function findDates(s){
      const re = /\b(\d{2}[./-]\d{2}[./-]\d{4}|\d{4}[./-]\d{2}[./-]\d{2})\b/g;
      const out = []; let m;
      while ((m = re.exec(s)) !== null) out.push(m[1]);
      return out.slice(0, 4); // safety
    }
    function toISO(d){
      // dd.mm.yyyy or yyyy-mm-dd → ISO yyyy-mm-dd
      const p = d.split(/[./-]/).map(x=>parseInt(x,10));
      let y,m,dd;
      if (p[0] > 1900) { y=p[0]; m=p[1]; dd=p[2]; }
      else if (p[2] > 1900) { y=p[2]; m=p[1]; dd=p[0]; }
      else return '';
      if (m<1||m>12||dd<1||dd>31) return '';
      return `${y}-${String(m).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
      }

    function findSTCW(s){
      const t = s.replace(/\s+/g,' ');
      // prefer A-VI/… or A-V/… ; also accept "Reg. VI/5", "Table A-V/5"
      const rx1 = /\bA-[IVX]{1,3}\/\d+(?:-\d+)?\b/i;
      const rx2 = /\bReg\.?\s*([IVX]{1,3}\/\d+(?:-\d+)?)/i;
      const rx3 = /\bTable\s*A-([IVX]{1,3}\/\d+(?:-\d+)?)/i;

      const m1 = t.match(rx1);
      if (m1) return m1[0].toUpperCase();

      const m2 = t.match(rx2);
      if (m2) return ('A-'+m2[1]).toUpperCase();

      const m3 = t.match(rx3);
      if (m3) return ('A-'+m3[1]).toUpperCase();

      // common OCR fixes: V1 → VI
      const fixed = t.replace(/V1/g,'VI').replace(/A- ?V1/g,'A-VI');
      const f1 = fixed.match(rx1);
      if (f1) return f1[0].toUpperCase();

      return '';
    }

    // Fill editor quickly
    function applyFieldsToForm(f){
      const form = document.getElementById('form');
      if(f.name) form.name.value = f.name;
      if(f.stcw) form.stcw.value = f.stcw;
      if(f.issue) form.issue.value = f.issue;
      const noExp = document.getElementById('noExpiry');
      const expIn = document.getElementById('expiry');
      if(f.expiry){
        expIn.value = f.expiry;
        noExp.checked=false; expIn.disabled=false;
      } else {
        noExp.checked=true; expIn.value=''; expIn.disabled=true;
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
