<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Certificates</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#f6f8fb}
    .form-slide{background:#fff;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.06);margin:18px 0;display:none}
    .form-slide.active{display:block}
    .required::after{content:" *";color:#dc3545}
    .ocr-box{background:#0b5ed7;color:#fff}
    .ocr-progress{height:6px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space: pre-wrap; max-height: 220px; overflow:auto; background:#f2f4f8; padding:.75rem; border-radius:8px;}
    .detected li{border:1px solid #e7ebf3;border-radius:10px;padding:.6rem .75rem;margin:.5rem 0;background:#fff}
    .detected code{background:#eef2ff;padding:.1rem .35rem;border-radius:.4rem}
  </style>
</head>
<body class="p-4">
  <div class="container">

    <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
      <h4 class="mb-0 fw-bold">Certificates</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-secondary" id="scanBtn">Scan from Photo</button>
        <button class="btn btn-success" id="addBtn">+ Add</button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-striped align-middle">
        <thead class="table-primary text-center">
          <tr>
            <th style="width:130px">Actions</th>
            <th>Certificate</th>
            <th>STCW Code / Ref.</th>
            <th>Issue</th>
            <th>Expiry</th>
          </tr>
        </thead>
        <tbody id="certList">
          <tr><td colspan="5" class="text-center text-muted py-4">No certificates added yet.</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Editor -->
    <div id="certForm" class="form-slide p-3">
      <form id="form" novalidate>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label required">Certificate Name</label>
            <input id="name" class="form-control" placeholder="e.g., Personal Survival Techniques" required>
          </div>
          <div class="col-md-6">
            <label class="form-label required">STCW Code / Reference</label>
            <input id="stcw" class="form-control" placeholder="e.g., A-VI/1-1" required>
          </div>
          <div class="col-md-6">
            <label class="form-label required">Issue Date</label>
            <input id="issue" type="date" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Expiry Date</label>
            <input id="expiry" type="date" class="form-control">
            <div class="form-check mt-1">
              <input id="noExpiry" class="form-check-input" type="checkbox">
              <label class="form-check-label" for="noExpiry">No expiry date</label>
            </div>
          </div>
        </div>
        <div class="text-end mt-3">
          <button class="btn btn-primary" id="submitBtn">Add</button>
          <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
        </div>
      </form>
    </div>

    <!-- OCR UI -->
    <input id="ocrInput" type="file" accept="image/*" class="d-none">
    <div id="ocrPane" class="form-slide p-3 d-none">
      <div class="p-3 rounded ocr-box">
        <div class="d-flex justify-content-between align-items-center">
          <strong>OCR • Scan from Photo</strong>
          <button class="btn btn-sm btn-light" id="ocrCloseBtn">Close</button>
        </div>
        <div class="progress bg-white mt-2 ocr-progress">
          <div id="ocrProgress" class="progress-bar" role="progressbar" style="width:0%"></div>
        </div>
        <div id="ocrStatus" class="small mt-2">Waiting for image…</div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-md-6">
          <img id="ocrPreview" class="img-fluid rounded border" alt="Preview">
        </div>
        <div class="col-md-6">
          <label class="form-label">Extracted text (raw)</label>
          <div id="ocrText" class="mono small">—</div>
        </div>
      </div>

      <div id="detectedBox" class="mt-3 d-none">
        <div class="d-flex justify-content-between align-items-center">
          <h6 class="mb-2">Detected items</h6>
          <div class="d-flex gap-2">
            <button id="addSelectedBtn" class="btn btn-sm btn-primary">Add selected</button>
            <button id="clearDetectedBtn" class="btn btn-sm btn-outline-secondary">Clear</button>
          </div>
        </div>
        <ul id="detectedList" class="list-unstyled detected"></ul>
        <div class="text-muted small">Tip: “Fill” ile forma atıp düzenleyebilir veya birden fazla satırı seçip “Add selected” ile toplu kaydedebilirsin.</div>
      </div>
    </div>

    <div class="alert alert-light border small mt-3">
      <b>Scan tips:</b> good light, flat document, fill the frame, avoid blur. If the code is misread (<code>A-VI/1</code> → <code>A-V1/1</code> gibi), formda düzeltip kaydedebilirsin.
    </div>
  </div>

  <!-- Firebase & App -->
  <script type="module">
    if ((localStorage.getItem('role')||'').toLowerCase()!=='seafarer') window.top.location.href='/index.html';

    import { auth, db } from '/firebase-config.js';
    import {
      collection, addDoc, updateDoc, deleteDoc, getDocs, doc, query, orderBy
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';

    let userId=null, editId=null;
    const list=document.getElementById('certList');
    const formBox=document.getElementById('certForm');
    const form=document.getElementById('form');
    const submitBtn=document.getElementById('submitBtn');
    const cancelBtn=document.getElementById('cancelBtn');
    const addBtn=document.getElementById('addBtn');
    const noExpiry=document.getElementById('noExpiry');
    const expiryInput=document.getElementById('expiry');

    // OCR elements
    const scanBtn=document.getElementById('scanBtn');
    const ocrInput=document.getElementById('ocrInput');
    const ocrPane=document.getElementById('ocrPane');
    const ocrCloseBtn=document.getElementById('ocrCloseBtn');
    const ocrPreview=document.getElementById('ocrPreview');
    const ocrText=document.getElementById('ocrText');
    const ocrStatus=document.getElementById('ocrStatus');
    const ocrProgress=document.getElementById('ocrProgress');
    const detectedBox=document.getElementById('detectedBox');
    const detectedList=document.getElementById('detectedList');
    const addSelectedBtn=document.getElementById('addSelectedBtn');
    const clearDetectedBtn=document.getElementById('clearDetectedBtn');

    // UX
    noExpiry.addEventListener('change',()=>{ expiryInput.disabled = noExpiry.checked; if(noExpiry.checked) expiryInput.value=''; });
    addBtn.addEventListener('click', ()=> openForm());
    cancelBtn.addEventListener('click', ()=> closeForm());

    // OCR triggers
    scanBtn.addEventListener('click', ()=> ocrInput.click());
    ocrCloseBtn.addEventListener('click', ()=> ocrPane.classList.add('d-none'));
    ocrInput.addEventListener('change', async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      await runOCR(file);
    });

    // Save
    form.addEventListener('submit', async e=>{
      e.preventDefault();
      if(!form.checkValidity()){ form.reportValidity(); return; }
      if(!noExpiry.checked && form.expiry.value && form.issue.value && form.expiry.value < form.issue.value){
        alert('Expiry date cannot be before issue date.'); form.expiry.focus(); return;
      }
      const data = {
        name: form.name.value.trim(),
        stcw: form.stcw.value.trim(),
        issue: form.issue.value,
        expiry: noExpiry.checked ? '' : (form.expiry.value || '')
      };
      const base=collection(db, `seafarers/${userId}/cv/certificates/items`);
      try{
        if(editId) await updateDoc(doc(base,editId),data); else await addDoc(base,data);
        await render(); closeForm();
      }catch(err){ console.error(err); alert('Save failed.'); }
    });

    // Edit/Delete
    function bindRowActions(tr, id, data){
      tr.querySelector('[data-act="edit"]').addEventListener('click',()=>openForm(id,data));
      tr.querySelector('[data-act="del"]').addEventListener('click',()=>delItem(id));
    }
    async function delItem(id){
      if(!confirm('Delete this certificate?')) return;
      const base=collection(db, `seafarers/${userId}/cv/certificates/items`);
      try{ await deleteDoc(doc(base,id)); await render(); }catch(err){ console.error(err); alert('Delete failed.'); }
    }

    // Auth & render
    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href='/index.html';
      userId=user.uid; await render();
    });

    async function render(){
      list.innerHTML='<tr><td colspan="5" class="text-center text-muted py-4">Loading…</td></tr>';
      const base=collection(db, `seafarers/${userId}/cv/certificates/items`);
      const snap=await getDocs(query(base, orderBy('issue','desc')));
      if(snap.empty){ list.innerHTML='<tr><td colspan="5" class="text-center text-muted py-4">No certificates added yet.</td></tr>'; return; }
      list.innerHTML='';
      snap.forEach(s=>{
        const d=s.data();
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td class="text-center">
            <button class="btn btn-sm btn-outline-secondary me-1" data-act="edit">Edit</button>
            <button class="btn btn-sm btn-outline-danger" data-act="del">Delete</button>
          </td>
          <td>${esc(d.name||'')}</td>
          <td>${esc(d.stcw||'')}</td>
          <td>${esc(d.issue||'')}</td>
          <td>${d.expiry ? esc(d.expiry) : '—'}</td>
        `;
        bindRowActions(tr, s.id, d);
        list.appendChild(tr);
      });
    }

    // Editor open/close
    function openForm(id=null,data=null){
      form.reset(); noExpiry.checked=false; expiryInput.disabled=false;
      submitBtn.textContent=id?'Save':'Add'; editId=id;
      if(data){ form.name.value=data.name||''; form.stcw.value=data.stcw||''; form.issue.value=data.issue||''; form.expiry.value=data.expiry||''; if(!data.expiry){ noExpiry.checked=true; expiryInput.disabled=true; } }
      formBox.classList.add('active'); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    }
    function closeForm(){ formBox.classList.remove('active'); editId=null; }

    // Utils
    function esc(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  </script>

  <!-- Tesseract (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <script>
    // === Main OCR pipeline ===
    async function runOCR(file){
      const url = URL.createObjectURL(file);
      const ocrPane = document.getElementById('ocrPane');
      const ocrPreview = document.getElementById('ocrPreview');
      const ocrText = document.getElementById('ocrText');
      const ocrStatus = document.getElementById('ocrStatus');
      const ocrProgress = document.getElementById('ocrProgress');
      const detectedBox=document.getElementById('detectedBox');
      const detectedList=document.getElementById('detectedList');

      ocrPane.classList.remove('d-none'); ocrPane.classList.add('active');
      ocrPreview.src = url; ocrStatus.textContent = 'Recognizing…'; ocrProgress.style.width = '0%';

      try {
        // 0) Raw text (bilgi amaçlı)
        const raw = await Tesseract.recognize(url,'eng+tur',{logger:m=>{
          if(m.status && m.progress!=null){ ocrStatus.textContent=`${m.status}… ${(m.progress*100|0)}%`; ocrProgress.style.width=`${m.progress*100}%`; }
        }});
        const rawText = raw.data.text || '';
        ocrText.textContent = rawText;
        ocrStatus.textContent = 'Parsing rows…';

        // 1) Canvas -> binarize -> yatay projeksiyon ile satır aralıkları
        const img = await loadImage(url);
        const base = imageToCanvas(img);
        const bin = binarize(base);
        const rows = segmentRows(bin); // [{y1,y2}...]

        // 2) Sütun oranları (tahmini): sol(0–22%) tarih, orta(22–74%) ad, sağ(74–100%) STCW
        const W = bin.width;
        const Lw = Math.round(W*0.22), Rx = Math.round(W*0.74);

        // 3) Her satırı ayrı ayrı OCR: tarih / ad / STCW
        const items = [];
        for(const r of rows){
          if (r.y2 - r.y1 < 40) continue; // çok kısa gürültü
          const left  = crop(bin, 0, r.y1, Lw, r.y2-r.y1);
          const mid   = crop(bin, Lw, r.y1, Rx-Lw, r.y2-r.y1);
          const right = crop(bin, Rx, r.y1, W-Rx, r.y2-r.y1);

          const [tDates, tName, tStcw] = await Promise.all([
            Tesseract.recognize(left,  'eng',    {}),
            Tesseract.recognize(mid,   'eng+tur',{}),
            Tesseract.recognize(right, 'eng',    {})
          ]);

          const dates = findDates(tDates.data.text||'');
          const stcw  = findSTCW((tStcw.data.text||'') + ' ' + (tName.data.text||''));
          const name  = extractName(tName.data.text||'', stcw);

          if (dates.length){
            const issue = toISO(dates[0]) || '';
            const expiry = dates[1] ? toISO(dates[1]) : '';
            items.push({name, stcw, issue, expiry});
          }
        }

        // 4) Sonuçları göster
        renderDetected(items);

      } catch (err) {
        console.error(err);
        ocrStatus.textContent = 'OCR failed. Please try another photo.';
      } finally {
        document.getElementById('ocrInput').value='';
        setTimeout(()=>URL.revokeObjectURL(url), 30000);
      }
    }

    // === Detected list & actions ===
    function renderDetected(items){
      const box = document.getElementById('detectedBox');
      const list = document.getElementById('detectedList');
      list.innerHTML='';
      if (!items.length){ box.classList.add('d-none'); return; }

      items.forEach((it, idx)=>{
        const li=document.createElement('li'); const id='pick_'+idx;
        li.innerHTML=`
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="${id}" checked>
                <label for="${id}" class="form-check-label">
                  <b>${esc(it.name || '(name?)')}</b>
                  <div class="text-muted small mt-1">
                    <code>${esc(it.stcw || '(stcw?)')}</code> •
                    Issue: <code>${esc(it.issue || '—')}</code> •
                    Expiry: <code>${esc(it.expiry || '—')}</code>
                  </div>
                </label>
              </div>
            </div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary">Fill</button>
            </div>
          </div>`;
        li.querySelector('button').addEventListener('click', ()=>{
          applyFieldsToForm(it);
          document.getElementById('addBtn').click();
        });
        list.appendChild(li);
      });
      box.classList.remove('d-none');

      document.getElementById('addSelectedBtn').onclick = async ()=>{
        const picks = [...list.querySelectorAll('input[type="checkbox"]')];
        const selected = picks.map((cb,i)=> cb.checked ? items[i] : null).filter(Boolean);
        if (!selected.length) return;
        try{
          const base = collection(db, `seafarers/${userId}/cv/certificates/items`);
          for (const d of selected){ await addDoc(base, { name:d.name||'', stcw:d.stcw||'', issue:d.issue||'', expiry:d.expiry||'' }); }
          await render();
          alert('Selected items added.');
        }catch(e){ console.error(e); alert('Bulk add failed.'); }
      };
      document.getElementById('clearDetectedBtn').onclick = ()=>{
        list.innerHTML=''; box.classList.add('d-none');
      };
    }

    // === Canvas helpers ===
    function loadImage(src){ return new Promise(r=>{ const i=new Image(); i.onload=()=>r(i); i.src=src; }); }
    function imageToCanvas(img){ const c=document.createElement('canvas'); c.width=img.naturalWidth; c.height=img.naturalHeight; const x=c.getContext('2d'); x.drawImage(img,0,0); return c; }
    function binarize(c){
      const x=c.getContext('2d'), {width:w,height:h}=c; const d=x.getImageData(0,0,w,h); const a=d.data;
      // grayscale + global threshold (mean-10)
      let sum=0;
      for(let i=0;i<a.length;i+=4){ const g=(a[i]*0.299+a[i+1]*0.587+a[i+2]*0.114)|0; a[i]=a[i+1]=a[i+2]=g; sum+=g; }
      const mean=(sum/(a.length/4))|0, thr=Math.max(80, mean-10);
      for(let i=0;i<a.length;i+=4){ const v=a[i]<thr?0:255; a[i]=a[i+1]=a[i+2]=v; }
      x.putImageData(d,0,0); return c;
    }
    function segmentRows(c){
      const x=c.getContext('2d'), {width:w,height:h}=c; const d=x.getImageData(0,0,w,h).data;
      const proj=new Array(h).fill(0);
      for(let y=0;y<h;y++){ let s=0; for(let x0=0;x0<w;x0++){ const i=(y*w+x0)*4; s += (d[i]===0)?1:0; } proj[y]=s; }
      const rows=[]; const T=Math.max(...proj)*0.10; // satır aktivasyon eşiği
      let inRow=false, start=0;
      for(let y=0;y<h;y++){
        if(proj[y]>T){ if(!inRow){start=y; inRow=true;} }
        else if(inRow){ const end=y; if(end-start>35) rows.push({y1:start,y2:end}); inRow=false; }
      }
      if(inRow) rows.push({y1:start,y2:h-1});
      return rows;
    }
    function crop(c,x,y,w,h){ const o=document.createElement('canvas'); o.width=w; o.height=h; o.getContext('2d').drawImage(c,x,y,w,h,0,0,w,h); return o; }

    // === Parsing helpers ===
    function findDates(s){
      const re=/\b(\d{2}[./-]\d{2}[./-]\d{4}|\d{4}[./-]\d{2}[./-]\d{2})\b/g;
      const out=[]; let m; while((m=re.exec(s))!==null) out.push(m[1]); return out.slice(0,3);
    }
    function toISO(d){
      const p=d.split(/[./-]/).map(x=>parseInt(x,10)); let y,m,dd;
      if(p[0]>1900){ y=p[0]; m=p[1]; dd=p[2]; } else { y=p[2]; m=p[1]; dd=p[0]; }
      if(m<1||m>12||dd<1||dd>31) return ''; return `${y}-${String(m).padStart(2,'0')}-${String(dd).padStart(2,'0')}`;
    }
    function findSTCW(s){
      const t=s.replace(/\s+/g,' ');
      const rx1=/\bA-[IVX]{1,3}\/\d+(?:-\d+)?\b/i;
      const rx2=/\bReg\.?\s*([IVX]{1,3}\/\d+(?:-\d+)?)/i;
      const rx3=/\bTable\s*A-([IVX]{1,3}\/\d+(?:-\d+)?)/i;
      const fix=t.replace(/V1/g,'VI').replace(/A- ?V1/g,'A-VI');
      const m1=(t.match(rx1)||fix.match(rx1)); if(m1) return m1[0].toUpperCase();
      const m2=t.match(rx2); if(m2) return ('A-'+m2[1]).toUpperCase();
      const m3=t.match(rx3); if(m3) return ('A-'+m3[1]).toUpperCase();
      return '';
    }
    function extractName(mid, stcw){
      let zone=mid;
      if(stcw){
        const i=zone.toUpperCase().indexOf(stcw.toUpperCase());
        if(i>0) zone=zone.slice(0,i);
      }
      // iki dilli ise / sağındaki İngilizce kısmı al
      zone = zone.split('/').pop();
      return zone.replace(/\(\d+\)/g,'')
                 .replace(/\b(CERTIFICATE|BELGESI)\b/ig,'')
                 .replace(/\s{2,}/g,' ')
                 .trim();
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
