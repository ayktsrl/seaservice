<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Personal Details</title>
  <link rel="manifest" href="/site.webmanifest">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="../../style.css"/>
  <style>
    @media (max-width:768px){ .form-label,.form-control,.form-select{font-size:.95rem} h4{font-size:1.25rem} }
    input[type="text"], input[type="email"], textarea { text-transform: none; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <form id="detailsForm" class="shadow-sm rounded p-4 bg-white">
      <h4 class="mb-4">Personal Details</h4>

      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Name</label>
          <input id="firstName" class="form-control only-english" required>
        </div>
        <div class="col-md-4">
          <label class="form-label">Last Name</label>
          <input id="lastName" class="form-control only-english" required>
        </div>

        <div class="col-md-4">
          <label class="form-label d-block">Gender</label>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="gender" id="male" value="Male">
            <label class="form-check-label" for="male">Male</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="gender" id="female" value="Female">
            <label class="form-check-label" for="female">Female</label>
          </div>
        </div>

        <div class="col-md-4">
          <label class="form-label">Marital Status</label>
          <select id="maritalStatus" class="form-select">
            <option value="">Select Status</option>
            <option value="Single">Single</option>
            <option value="Married">Married</option>
            <option value="Divorced">Divorced</option>
            <option value="Widowed">Widowed</option>
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Date of Birth</label>
          <input id="dob" type="date" class="form-control">
        </div>

        <div class="col-md-4">
          <label class="form-label">Place of Birth</label>
          <input id="birthPlace" class="form-control only-english">
        </div>

        <div class="col-md-4">
          <label class="form-label">Nationality</label>
          <select id="nationality" class="form-select"></select>
        </div>

        <div class="col-md-4">
          <label class="form-label">Email</label>
          <input id="email" type="email" class="form-control only-english" required>
        </div>

        <div class="col-md-4">
          <label class="form-label">Phone</label>
          <input id="phone" class="form-control">
        </div>

        <div class="col-md-4">
          <label class="form-label">Country of Residence</label>
          <select id="residence" class="form-select"></select>
        </div>

        <div class="col-md-4">
          <label class="form-label">City</label>
          <input id="city" class="form-control only-english">
        </div>

        <div class="col-md-4">
          <label class="form-label">Zip Code</label>
          <input id="zip" class="form-control">
        </div>

        <div class="col-12">
          <label class="form-label">Address</label>
          <textarea id="address" rows="2" class="form-control only-english"></textarea>
        </div>
      </div>

      <div class="text-end mt-3">
        <button class="btn btn-primary">Save</button>
      </div>
    </form>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:11">
    <div id="toastMsg" class="toast align-items-center text-white bg-primary border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Saved</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script type="module">
    if ((localStorage.getItem('role')||'').toLowerCase()!=='seafarer') window.top.location.href='../../index.html';

    // Options
    fetch('../../options/options-nationality.html').then(r=>r.text()).then(h=>document.getElementById('nationality').innerHTML=h);
    fetch('../../options/options-countries.html').then(r=>r.text()).then(h=>document.getElementById('residence').innerHTML=h);

    import { auth, db } from '../../firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const toast = new bootstrap.Toast(document.getElementById('toastMsg'));
    const tBody = document.getElementById('toastBody');
    const form = document.getElementById('detailsForm');

    onAuthStateChanged(auth, async (user)=>{
      if(!user) return window.location.href='../../index.html';
      const ref = doc(db,'seafarers', user.uid, 'cv', 'personalDetails');
      const snap = await getDoc(ref);
      if (snap.exists()){
        const d = snap.data();
        form.firstName.value = d.firstName || '';
        form.lastName.value  = d.lastName  || '';
        if(d.gender==='Male')   form.querySelector('#male').checked = true;
        if(d.gender==='Female') form.querySelector('#female').checked = true;
        form.maritalStatus.value = d.maritalStatus || '';
        form.dob.value        = d.dob || '';
        form.birthPlace.value = d.birthPlace || '';
        form.nationality.value= d.nationality || '';
        form.email.value      = d.email || '';
        form.phone.value      = d.phone || '';
        form.residence.value  = d.residence || '';
        form.city.value       = d.city || '';
        form.zip.value        = d.zip || '';
        form.address.value    = d.address || '';
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const gender = form.querySelector('input[name="gender"]:checked')?.value || '';
        const data = {
          firstName: form.firstName.value.trim(),
          lastName:  form.lastName.value.trim(),
          gender,
          maritalStatus: form.maritalStatus.value,
          dob: form.dob.value,
          birthPlace: form.birthPlace.value.trim(),
          nationality: form.nationality.value,
          email: form.email.value.trim(),
          phone: form.phone.value.trim(),
          residence: form.residence.value,
          city: form.city.value.trim(),
          zip: form.zip.value.trim(),
          address: form.address.value.trim()
        };
        await setDoc(ref, data);
        tBody.textContent='Saved âœ…'; toast.show();
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
