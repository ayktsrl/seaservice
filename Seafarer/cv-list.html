<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orion • CV List</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#f6f8fb; }
    .card-shadow { box-shadow:0 6px 20px rgba(0,0,0,.08); border:0; }
    .table td, .table th { vertical-align: middle; }
    .hint { font-size:.9rem; color:#6c757d; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div id="navbar-container"></div>
  <script>
    fetch('/shared/common-navbar.html').then(r=>r.text()).then(html=>{
      const c=document.getElementById('navbar-container'); c.innerHTML=html;
      c.querySelectorAll('script').forEach(s=>{const n=document.createElement('script'); if(s.src)n.src=s.src; else n.textContent=s.textContent; document.body.appendChild(n);});
    });
  </script>

  <main class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h3 class="mb-0">CV List</h3>
        <small class="text-muted">Draft CVs are visible only to you until you publish.</small>
      </div>
      <div class="d-flex flex-column align-items-end gap-1">
        <button id="addCvBtn" class="btn btn-success d-none">+ Add CV</button>
        <span id="addHint" class="hint d-none">Creates a new draft and opens the editor.</span>
      </div>
    </div>

    <div class="card card-shadow mb-3">
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-md-5">
            <label class="form-label">Search</label>
            <input type="text" id="searchInput" class="form-control" placeholder="Name, position, skills…">
          </div>
          <div class="col-md-3">
            <label class="form-label">Visibility</label>
            <select id="visibilitySelect" class="form-select">
              <option value="all">All</option>
              <option value="public">Published only</option>
              <option value="private">Draft only</option>
            </select>
          </div>
          <div class="col-md-2 d-grid">
            <button class="btn btn-primary" id="applyFiltersBtn">Apply</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card card-shadow">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="text-muted" id="countText">Loading…</div>
          <div class="spinner-border spinner-border-sm text-primary" id="loadingSpinner" role="status"></div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover align-middle" id="cvTable">
            <thead class="table-light">
              <tr>
                <th style="width: 28%;">Name</th>
                <th style="width: 18%;">Position</th>
                <th style="width: 16%;">Updated</th>
                <th style="width: 14%;">Status</th>
                <th style="width: 24%;">Actions</th>
              </tr>
            </thead>
            <tbody id="cvTbody"></tbody>
          </table>
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3">
          <button class="btn btn-outline-secondary btn-sm" id="prevPageBtn" disabled>Prev</button>
          <button class="btn btn-outline-secondary btn-sm" id="nextPageBtn" disabled>Next</button>
        </div>
      </div>
    </div>

    <div class="alert alert-info mt-3">
      <strong>Tip:</strong> Publish = visible to companies/agencies. Draft = only you can view.
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script type="module">
    if ((localStorage.getItem('role')||'').toLowerCase() !== 'seafarer') location.href='/index.html';

    import { auth, db } from '/firebase-config.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { collection, query, where, orderBy, limit, startAfter, getDocs, deleteDoc, doc, updateDoc, addDoc, serverTimestamp, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    let currentUser = null;
    const role = 'seafarer';
    const pageSize = 10;
    let lastVisible = null;
    let prevStack = [];
    let activeFilters = { text:'', visibility:'all' };

    const loadingSpinner = document.getElementById('loadingSpinner');
    const countText = document.getElementById('countText');
    const tbody = document.getElementById('cvTbody');
    const searchInput = document.getElementById('searchInput');
    const visibilitySelect = document.getElementById('visibilitySelect');
    const applyFiltersBtn = document.getElementById('applyFiltersBtn');
    const prevBtn = document.getElementById('prevPageBtn');
    const nextBtn = document.getElementById('nextPageBtn');
    const addCvBtn = document.getElementById('addCvBtn');
    const addHint = document.getElementById('addHint');

    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    // delete modal elements exist below (created by original file)

    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = "/index.html"; return; }
      currentUser = user;
      addCvBtn.classList.remove('d-none');
      addHint.classList.remove('d-none');
      await loadPage(true);
    });

    applyFiltersBtn.addEventListener('click', async () => {
      activeFilters.text = (searchInput.value || '').trim().toLowerCase();
      activeFilters.visibility = visibilitySelect.value;
      await loadPage(true);
    });

    prevBtn.addEventListener('click', async () => {
      if (prevStack.length === 0) return;
      lastVisible = prevStack.pop() || null;
      await loadPage(false, true);
    });

    nextBtn.addEventListener('click', async () => { await loadPage(false); });

    addCvBtn.addEventListener('click', async () => {
      try {
        toggleLoading(true);
        const meta = await buildMetaFromSubdocs(currentUser.uid);
        const ref = await addDoc(collection(db,'cvs'), {
          ownerUid: currentUser.uid,
          ownerEmail: meta.ownerEmail,
          name: meta.name,
          position: meta.position,
          skills: meta.skills,
          public: false,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        location.href = `/Seafarer/edit-cv-panel.html?cvId=${ref.id}`;
      } catch (e) { console.error(e); alert('Create failed.'); }
      finally { toggleLoading(false); }
    });

    async function buildMetaFromSubdocs(ownerUid) {
      const personalRef = doc(db,"seafarers", ownerUid, "cv", "personalDetails");
      const qualRef     = doc(db,"seafarers", ownerUid, "cv", "qualifications");
      const skillsRef   = doc(db,"seafarers", ownerUid, "cv", "specialSkills");

      const [personalSnap, qualSnap, skillsSnap] = await Promise.all([
        getDoc(personalRef), getDoc(qualRef), getDoc(skillsRef)
      ]);

      let fullName = "-";
      let ownerEmail = currentUser?.email || "-";
      if (personalSnap.exists()) {
        const d = personalSnap.data();
        fullName = ((d.firstName||"")+" "+(d.middleName||"")+" "+(d.lastName||"")).replace(/\s+/g," ").trim() || "-";
        if (d.email) ownerEmail = d.email;
      }
      const position = (qualSnap.exists() && qualSnap.data().rankApplied) ? qualSnap.data().rankApplied : "-";
      const skills = (skillsSnap.exists() && Array.isArray(skillsSnap.data().items)) ? skillsSnap.data().items : [];
      return { name: fullName, ownerEmail, position, skills };
    }

    async function loadPage(reset=false, goingBack=false) {
      if (!currentUser) return;
      toggleLoading(true);
      if (reset) { lastVisible = null; prevStack = []; tbody.innerHTML=''; }

      try {
        const baseRef = collection(db, 'cvs');
        const cons = [ where('ownerUid', '==', currentUser.uid) ];
        if (activeFilters.visibility === 'public')  cons.push(where('public', '==', true));
        if (activeFilters.visibility === 'private') cons.push(where('public', '==', false));
        cons.push(orderBy('updatedAt','desc'), limit(pageSize));
        if (lastVisible && !goingBack) cons.push(startAfter(lastVisible));

        const snap = await getDocs(query(baseRef, ...cons));
        const docsArr = snap.docs;
        if (!goingBack && docsArr.length > 0) {
          const newLast = docsArr[docsArr.length-1];
          if (lastVisible) prevStack.push(lastVisible);
          lastVisible = newLast;
        }

        tbody.innerHTML = '';
        let rendered = 0;
        for (const d of docsArr) {
          const cv = { id:d.id, ...d.data() };
          const hay = [cv.name, cv.position, (cv.skills||[]).join(', '), cv.ownerEmail].join(' ').toLowerCase();
          if (activeFilters.text && !hay.includes(activeFilters.text)) continue;
          appendRow(cv); rendered++;
        }

        countText.textContent = `${rendered} CV listed`;
        nextBtn.disabled = (docsArr.length < pageSize);
        prevBtn.disabled = (prevStack.length === 0);
      } catch (e) {
        console.error(e); countText.textContent = "Failed to load CVs.";
      } finally { toggleLoading(false); }
    }

    function appendRow(cv){
      const tr = document.createElement('tr');
      const updated = cv.updatedAt?.toDate ? cv.updatedAt.toDate() : (cv.updatedAt? new Date(cv.updatedAt): null);
      const updatedStr = updated ? updated.toLocaleString() : '-';
      const statusBadge = cv.public ? '<span class="badge bg-success">Published</span>' : '<span class="badge bg-secondary">Draft</span>';

      tr.innerHTML = `
        <td><div class="fw-semibold">${escapeHtml(cv.name || '—')}</div><div class="text-muted small">${escapeHtml(cv.ownerEmail || '')}</div></td>
        <td>${escapeHtml(cv.position || '—')}</td>
        <td>${updatedStr}</td>
        <td>${statusBadge}</td>
        <td>
          <div class="btn-group" role="group">
            <a class="btn btn-sm btn-outline-primary" href="/shared/view-cv.html?cvId=${cv.id}">View</a>
            <button class="btn btn-sm btn-outline-dark" data-act="pdf" data-id="${cv.id}">Download PDF</button>
            <a class="btn btn-sm btn-outline-secondary" href="/Seafarer/edit-cv-panel.html?cvId=${cv.id}">Edit</a>
            <button class="btn btn-sm btn-outline-warning" data-act="toggle" data-id="${cv.id}">
              ${cv.public ? 'Unpublish' : 'Publish'}
            </button>
            <button class="btn btn-sm btn-outline-danger" data-act="delete" data-id="${cv.id}" data-name="${escapeAttr(cv.name||'CV')}">Delete</button>
          </div>
        </td>
      `;

      tr.querySelectorAll('button').forEach(btn=>{
        const act=btn.dataset.act;

        if (act==='pdf'){
          btn.addEventListener('click', ()=>{
            const url = `/shared/view-cv.html?cvId=${btn.dataset.id}`;
            const w = window.open(url,'_blank');
            const t = setInterval(()=>{ try{ if(!w||w.closed) return clearInterval(t); if(w.document?.readyState==='complete'){ w.focus(); w.print(); clearInterval(t);} }catch{} },700);
          });
        }

        if (act==='toggle'){
          btn.addEventListener('click', async ()=>{
            try{
              toggleLoading(true);
              const ref = doc(db,'cvs', btn.dataset.id);
              const publish = btn.textContent.trim()==='Publish';
              await updateDoc(ref, { public: publish, updatedAt: new Date() });
              await loadPage(true);
            }catch(e){ alert('Action failed'); }
            finally{ toggleLoading(false); }
          });
        }

        if (act==='delete'){
          btn.addEventListener('click', async ()=>{
            if(!confirm(`Delete "${btn.dataset.name}"?`)) return;
            try{
              toggleLoading(true);
              await deleteDoc(doc(db,'cvs', btn.dataset.id));
              await loadPage(true);
            }catch(e){ alert('Delete failed'); }
            finally{ toggleLoading(false); }
          });
        }
      });

      tbody.appendChild(tr);
    }

    function toggleLoading(on){ loadingSpinner.style.display = on ? 'inline-block' : 'none'; }
    function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
  </script>
</body>
</html>
