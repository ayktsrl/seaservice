<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Seafarer CV</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --ink:#0f2437; --muted:#6b7a86; --line:#e9eef3; --chip:#f1f6fb; --brand:#0E6FFF;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:#f6f9fc;color:var(--ink);font:14px/1.5 Inter,system-ui,-apple-system,"Segoe UI",Roboto}
    .page{max-width:780px;margin:48px auto;background:#fff;border-radius:14px;box-shadow:0 6px 28px rgba(15,36,55,.06);padding:36px 36px 28px}
    h1{margin:0 0 4px;font-size:28px;letter-spacing:.1px}
    h2{margin:22px 0 10px;font-size:12px;text-transform:uppercase;letter-spacing:.14em;color:var(--muted)}
    .muted{color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:22px}
    .card{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fafcfe}
    .divider{height:1px;background:var(--line);margin:14px 0}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid #dbe7f3;color:#20507a;padding:4px 10px;border-radius:999px;font-weight:600;font-size:12px}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line)}
    th,td{border-top:1px solid var(--line);padding:8px 10px;text-align:left;font-size:13px}
    th{background:#f3f7fb;font-size:12px;color:#20507a;letter-spacing:.08em;text-transform:uppercase}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
    .list{margin:0;padding-left:16px}
    .list li{margin:4px 0}
    .kpis div{display:flex;justify-content:space-between;padding:4px 0}
    .fab{position:fixed;right:24px;bottom:24px;background:var(--brand);color:#fff;border:none;border-radius:999px;padding:12px 16px;
      font-weight:600;cursor:pointer;box-shadow:0 8px 28px rgba(14,111,255,.35)}
    .fab:active{transform:translateY(1px)}
  </style>
</head>
<body>
  <main class="page" id="cv">
    <header>
      <h1 id="fullName">Full Name</h1>
      <div class="muted" id="appliedRank">Applied Rank</div>
      <div class="divider"></div>
    </header>

    <section>
      <h2>Profile</h2>
      <div class="card"><span id="profileText" class="muted">Experienced seafarer…</span></div>
    </section>

    <section class="row">
      <div>
        <h2>Key Metrics</h2>
        <div class="kpis">
          <div><span>Total verified</span><strong id="kpiTotal">—</strong></div>
          <div><span>Last contract</span><strong id="kpiLast">—</strong></div>
          <div><span>Flags served</span><strong id="kpiFlags">—</strong></div>
        </div>
      </div>
      <div>
        <h2>Special Skills</h2>
        <div class="chips" id="skillsWrap"><span class="chip muted">—</span></div>
      </div>
    </section>

    <section>
      <h2>Sea Service History</h2>
      <table id="tblSea">
        <thead>
          <tr>
            <th>Vessel</th><th>IMO</th><th>Type</th><th>GRT/DWT</th><th>Flag</th><th>Rank</th><th>Start</th><th>End</th><th>Days</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="grid">
      <div>
        <h2>Licenses</h2>
        <ul class="list" id="licensesList"><li class="muted">—</li></ul>
      </div>
      <div>
        <h2>Certificates</h2>
        <ul class="list" id="certsList"><li class="muted">—</li></ul>
      </div>
    </section>
  </main>

  <button class="fab" id="btnPdf">Download PDF</button>

  <!-- html2pdf for PDF -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <!-- Firebase (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getFirestore, doc, getDoc, collection, getDocs, query, orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    // ----------------- CONFIG -----------------
    // Diğer sayfalardaki ile AYNI config'i koy:
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER",
      appId: "YOUR_APPID"
    };
    // ------------------------------------------

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Helpers
    const qs  = (s)=>document.querySelector(s);
    const qsa = (s)=>document.querySelectorAll(s);
    const fmt = (d)=> d ? new Date(d).toLocaleDateString('en-GB') : "—";
    const daysBetween = (a,b)=>{
      if(!a||!b) return 0;
      const ms = (new Date(b) - new Date(a));
      return Math.max(0, Math.round(ms/86400000)+1);
    };

    const url = new URL(location.href);
    const cvId = url.searchParams.get("cvId");

    async function loadCV() {
      if(!cvId) return;

      // 1) cvs/{cvId} -> ownerUid ve basic alanlar
      const cvRef = doc(db, "cvs", cvId);
      const cvSnap = await getDoc(cvRef);
      if(!cvSnap.exists()) { console.warn("CV not found"); return; }
      const cv = cvSnap.data();

      const ownerUid = cv.ownerUid;
      const fullName = cv.name || cv.fullName || "";
      const appliedRank = cv.position || "";

      qs("#fullName").textContent = fullName || "Full Name";
      qs("#appliedRank").textContent = appliedRank ? `Applied Rank • ${appliedRank}` : "Applied Rank";

      // 2) Kişisel detaylar (opsiyonel)
      try {
        const pSnap = await getDoc(doc(db, "seafarers", ownerUid, "cv", cvId, "personalDetails", "profile"));
        if (pSnap.exists() && pSnap.data().profile) {
          qs("#profileText").textContent = pSnap.data().profile;
        }
      } catch(e){ /* yoksa sorun değil */ }

      // 3) Special skills
      const skillsWrap = qs("#skillsWrap");
      skillsWrap.innerHTML = "";
      try {
        const skillsRef = collection(db, "seafarers", ownerUid, "cv", cvId, "specialSkills");
        const skillsSnap = await getDocs(skillsRef);
        if (skillsSnap.size === 0) skillsWrap.innerHTML = '<span class="chip muted">—</span>';
        skillsSnap.forEach(d=>{
          const s = d.data();
          if(!s) return;
          const label = s.skillType || s.type || s.name || "";
          if(!label) return;
          const chip = document.createElement("span");
          chip.className = "chip";
          chip.textContent = label;
          skillsWrap.appendChild(chip);
        });
      } catch(e){
        skillsWrap.innerHTML = '<span class="chip muted">—</span>';
      }

      // 4) Sea Service
      const tbody = qs("#tblSea tbody");
      tbody.innerHTML = "";
      let totalVerifiedDays = 0;
      let lastContractEnd   = null;
      const flags = new Set();

      try {
        const seaRef = query(collection(db, "seafarers", ownerUid, "cv", cvId, "seaService"), orderBy("joined","desc"));
        const seaSnap = await getDocs(seaRef);
        seaSnap.forEach(d=>{
          const s = d.data();
          const tr = document.createElement("tr");

          const vessel = s.vesselName || s.vessel || "";
          const imo    = s.imo || s.IMO || "";
          const type   = s.type || "";
          const grt    = s.grt || s.GRT || s.grtDwt || s.dwt || "";
          const flag   = s.flag || "";
          const rank   = s.rank || "";
          const start  = s.joined || s.start || s.from || "";
          const end    = s.signedOff || s.end || s.to || "";

          // gün hesabı
          const days = daysBetween(start, end);
          if (s.verified === true || s.isVerified === true) totalVerifiedDays += days;
          if (end) {
            const endDt = new Date(end);
            if (!lastContractEnd || endDt > lastContractEnd) lastContractEnd = endDt;
          }
          if (flag) flags.add(flag);

          [vessel,imo,type,grt,flag,rank,fmt(start),fmt(end), days?String(days):"—"].forEach((val)=>{
            const td = document.createElement("td");
            td.textContent = val || "—";
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
      } catch(e){
        console.error(e);
      }

      // KPI'lar
      qs("#kpiTotal").textContent = totalVerifiedDays ? `${totalVerifiedDays} days` : "—";
      qs("#kpiLast").textContent  = lastContractEnd ? lastContractEnd.toLocaleDateString('en-GB') : "—";
      qs("#kpiFlags").textContent = flags.size ? `${flags.size} flags` : "—";

      // 5) Licenses
      const licUL = qs("#licensesList");
      licUL.innerHTML = "";
      try {
        const licSnap = await getDocs(collection(db, "seafarers", ownerUid, "cv", cvId, "licenses"));
        if (licSnap.size === 0) licUL.innerHTML = '<li class="muted">—</li>';
        licSnap.forEach(d=>{
          const L = d.data();
          const li = document.createElement("li");
          const t  = L.type || L.licenseType || "License";
          const num = L.number ? ` • ${L.number}` : "";
          const exp = L.expiry ? ` • Expires: ${fmt(L.expiry)}` : "";
          li.textContent = `${t}${num}${exp}`;
          licUL.appendChild(li);
        });
      } catch(e){
        licUL.innerHTML = '<li class="muted">—</li>';
      }

      // 6) Certificates
      const certUL = qs("#certsList");
      certUL.innerHTML = "";
      try {
        const certSnap = await getDocs(collection(db, "seafarers", ownerUid, "cv", cvId, "certificates"));
        if (certSnap.size === 0) certUL.innerHTML = '<li class="muted">—</li>';
        certSnap.forEach(d=>{
          const C = d.data();
          const li = document.createElement("li");
          const name = C.certificateName || C.certificate || "Certificate";
          const code = C.stcw || C.stcwRef || C.code ? ` (${C.stcw || C.stcwRef || C.code})` : "";
          const iss  = C.issueDate ? ` • Issued: ${fmt(C.issueDate)}` : "";
          const exp  = C.expiryDate ? ` • Expires: ${fmt(C.expiryDate)}` : (C.noExpiry ? " • No expiry" : "");
          li.textContent = `${name}${code}${iss}${exp}`;
          certUL.appendChild(li);
        });
      } catch(e){
        certUL.innerHTML = '<li class="muted">—</li>';
      }
    }

    // PDF
    qs("#btnPdf").addEventListener("click", ()=>{
      const node = qs("#cv");
      const opt = {
        filename: "Seafarer-CV.pdf",
        image:   { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF:   { unit: "pt", format: "a4", orientation: "portrait" },
        pagebreak: { mode: ["avoid-all"] }
      };
      html2pdf().set(opt).from(node).save();
    });

    loadCV();
  </script>
</body>
</html>
