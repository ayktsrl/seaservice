<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Seafarer CV</title>
  <link href="https://unpkg.com/@picocss/pico@2/css/pico.min.css" rel="stylesheet">
  <style>
    body{background:#f7f9fc}
    main{max-width:1080px;margin:32px auto}
    .card{background:#fff;border-radius:12px;padding:18px 18px 10px;border:1px solid #e8eef5;box-shadow:0 6px 18px rgba(17,38,146,.06)}
    .section-title{font-weight:700;letter-spacing:.02em;margin:0 0 .5rem}
    .muted{color:#667085}
    .kpi small{display:block;color:#98a2b3;margin-top:.1rem}
    table{--pico-border-color:#edf2f7}
    thead th{font-size:.76rem;color:#6b7280}
    td,th{white-space:nowrap}
    .empty{color:#98a2b3}
    .header{display:flex;justify-content:space-between;align-items:center;margin:12px 0 24px}
    .name{font-size:1.8rem;font-weight:800;margin:0}
    .rank{font-weight:700;color:#64748b;margin-top:-4px}
    @media print{.btn-print{display:none}}
  </style>
</head>
<body>
<main>

  <div class="header">
    <div>
      <h1 class="name" id="fullName">Full Name</h1>
      <div class="rank" id="appliedRank">—</div>
    </div>
    <button class="btn-print" onclick="window.print()">Download PDF</button>
  </div>

  <!-- Profile -->
  <section class="card">
    <h3 class="section-title">Profile</h3>
    <div class="grid">
      <article>
        <strong>Summary</strong>
        <div id="summary" class="muted">Experienced seafarer...</div>
      </article>
      <article class="kpi">
        <strong>Key metrics</strong>
        <small>
          Total verified: <span id="kpi-total">—</span> &nbsp;—&nbsp;
          Last contract: <span id="kpi-last">—</span> &nbsp;—&nbsp;
          Flags served: <span id="kpi-flags">—</span>
        </small>
      </article>
      <article>
        <strong>Special skills</strong>
        <div id="skills" class="muted">—</div>
      </article>
    </div>
  </section>

  <!-- Sea service -->
  <section class="card">
    <h3 class="section-title">Sea Service History</h3>
    <div class="overflow-auto">
      <table>
        <thead>
          <tr>
            <th>Vessel</th><th>IMO</th><th>Type</th><th>GRT/DWT</th>
            <th>Flag</th><th>Rank</th><th>Start</th><th>End</th><th>Days</th>
          </tr>
        </thead>
        <tbody id="tbody-seaService"><tr><td colspan="9" class="empty">—</td></tr></tbody>
      </table>
    </div>
  </section>

  <div class="grid">
    <!-- Licenses -->
    <section class="card">
      <h3 class="section-title">Licenses</h3>
      <div class="overflow-auto">
        <table>
          <thead>
            <tr>
              <th>Type</th><th>Rank</th><th>Number</th><th>Issued</th>
              <th>Expiry</th><th>Place</th><th>Authority</th>
            </tr>
          </thead>
          <tbody id="tbody-licenses"><tr><td colspan="7" class="empty">—</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- Certificates -->
    <section class="card">
      <h3 class="section-title">Certificates</h3>
      <div class="overflow-auto">
        <table>
          <thead>
            <tr><th>Certificate</th><th>Issue</th><th>Expiry</th></tr>
          </thead>
          <tbody id="tbody-certificates"><tr><td colspan="3" class="empty">—</td></tr></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- Education -->
  <section class="card">
    <h3 class="section-title">Education</h3>
    <div class="overflow-auto">
      <table>
        <thead>
          <tr><th>University</th><th>Department</th><th>City</th><th>From</th><th>To</th><th>GPA</th></tr>
        </thead>
        <tbody id="tbody-education"><tr><td colspan="6" class="empty">—</td></tr></tbody>
      </table>
    </div>
  </section>

  <div class="grid">
    <!-- Travel docs -->
    <section class="card">
      <h3 class="section-title">Travel Documents</h3>
      <div class="overflow-auto">
        <table>
          <thead>
            <tr><th>Type</th><th>Number</th><th>Issue Country</th><th>Issued</th><th>Expiry</th></tr>
          </thead>
          <tbody id="tbody-documents"><tr><td colspan="5" class="empty">—</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- Visas -->
    <section class="card">
      <h3 class="section-title">Visas</h3>
      <div class="overflow-auto">
        <table>
          <thead>
            <tr><th>Country</th><th>Type</th><th>Number</th><th>Issued</th><th>Expiry</th><th>Place</th></tr>
          </thead>
          <tbody id="tbody-visas"><tr><td colspan="6" class="empty">—</td></tr></tbody>
        </table>
      </div>
    </section>
  </div>

</main>

<script type="module">
  // Firebase (CDN)
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import {
    getFirestore, doc, getDoc, collection, getDocs
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // ---- Config (senin projenden) ----
  const firebaseConfig = {
    apiKey: "AIzaSyDuF_HlZYG0v7SUaSzILV584J8b5ybnBUU",
    authDomain: "crewapplication-c37a8.firebaseapp.com",
    projectId: "crewapplication-c37a8",
    storageBucket: "crewapplication-c37a8.firebasestorage.app",
    messagingSenderId: "23423243284",
    appId: "1:23423243284:web:67e22f6ed057c74f4b4301",
    measurementId: "G-DSSJMESQ7Z"
  };

  initializeApp(firebaseConfig);
  const db = getFirestore();

  // ---- Helpers ----
  const $ = s => document.querySelector(s);
  const fmt = v => {
    if (!v) return '—';
    if (v.seconds) return new Date(v.seconds * 1000).toISOString().slice(0, 10);
    if (typeof v === 'string' && /^\d{4}-\d{2}-\d{2}/.test(v)) return v;
    return v;
  };
  const setName = (full, rank) => {
    $('#fullName').textContent = full || '—';
    $('#appliedRank').textContent = rank || '—';
  };
  const fillRows = (tbodyId, rows, cols) => {
    const tb = document.getElementById(tbodyId);
    if (!rows || rows.length === 0) { tb.innerHTML = `<tr><td colspan="${cols}" class="empty">—</td></tr>`; return; }
    tb.innerHTML = rows.join('');
  };

  // ---- Read params ----
  const params = new URLSearchParams(location.search);
  const cvId = params.get('cvid');
  if (!cvId) {
    alert('Missing ?cvid=');
    throw new Error('Missing cvid');
  }

  // 1) cv index dokümanı (ownerUid, ad / rank vs)
  const cvIdxSnap = await getDoc(doc(db, 'cvs', cvId));
  if (!cvIdxSnap.exists()) { alert('CV not found'); throw new Error('cv not found'); }
  const cvIdx = cvIdxSnap.data();
  const ownerUid = cvIdx.ownerUid;
  setName(cvIdx.name || (cvIdx.firstName ? `${cvIdx.firstName} ${cvIdx.lastName}` : '—'), cvIdx.position || cvIdx.appliedRank || '—');

  // Base: seafarers/{uid}/cv/{cvId}
  const base = doc(db, 'seafarers', ownerUid, 'cv', cvId);

  // ---- Section loaders ----
  const loadList = async (sectionDocName) => {
    const secDoc = doc(base, sectionDocName);            // <-- DİKKAT: önce doküman
    const itemsCol = collection(secDoc, 'items');         // <-- altındaki items koleksiyonu
    const snap = await getDocs(itemsCol);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  };

  // Sea Service
  try {
    const list = await loadList('seaService');
    const rows = list.map(x => `
      <tr>
        <td>${fmt(x.vessel)}</td>
        <td>${fmt(x.imo)}</td>
        <td>${fmt(x.type)}</td>
        <td>${fmt(x.grtDwt || x.grt || x.dwt)}</td>
        <td>${fmt(x.flag)}</td>
        <td>${fmt(x.rank)}</td>
        <td>${fmt(x.start)}</td>
        <td>${fmt(x.end)}</td>
        <td>${fmt(x.days)}</td>
      </tr>
    `);
    fillRows('tbody-seaService', rows, 9);
  } catch (e) {
    console.warn('seaService', e);
  }

  // Licenses
  try {
    const list = await loadList('licenses');
    const rows = list.map(x => `
      <tr>
        <td>${fmt(x.type)}</td>
        <td>${fmt(x.rank)}</td>
        <td>${fmt(x.number)}</td>
        <td>${fmt(x.issued || x.issue)}</td>
        <td>${fmt(x.expiry)}</td>
        <td>${fmt(x.place)}</td>
        <td>${fmt(x.authority)}</td>
      </tr>
    `);
    fillRows('tbody-licenses', rows, 7);
  } catch (e) { console.warn('licenses', e); }

  // Certificates
  try {
    const list = await loadList('certificates');
    const rows = list.map(x => `
      <tr>
        <td>${fmt(x.name || x.certificate)}</td>
        <td>${fmt(x.issue || x.issued)}</td>
        <td>${fmt(x.expiry)}</td>
      </tr>
    `);
    fillRows('tbody-certificates', rows, 3);
  } catch (e) { console.warn('certificates', e); }

  // Education
  try {
    const list = await loadList('education');
    const rows = list.map(x => `
      <tr>
        <td>${fmt(x.university)}</td>
        <td>${fmt(x.department)}</td>
        <td>${fmt(x.city)}</td>
        <td>${fmt(x.fromYear || x.from)}</td>
        <td>${fmt(x.toYear || x.to)}</td>
        <td>${fmt(x.gpa)}</td>
      </tr>
    `);
    fillRows('tbody-education', rows, 6);
  } catch (e) { console.warn('education', e); }

  // Travel Documents (documents)
  try {
    const list = await loadList('documents');
    const rows = list.map(x => `
      <tr>
        <td>${fmt(x.type)}</td>
        <td>${fmt(x.number)}</td>
        <td>${fmt(x.issueCountry || x.country)}</td>
        <td>${fmt(x.issueDate || x.issued)}</td>
        <td>${fmt(x.expiryDate || x.expiry)}</td>
      </tr>
    `);
    fillRows('tbody-documents', rows, 5);
  } catch (e) { console.warn('documents', e); }

  // Visas
  try {
    const list = await loadList('visas');
    const rows = list.map(x => `
      <tr>
        <td>${fmt(x.country)}</td>
        <td>${fmt(x.type)}</td>
        <td>${fmt(x.number)}</td>
        <td>${fmt(x.issued || x.issueDate)}</td>
        <td>${fmt(x.expiry || x.expiryDate)}</td>
        <td>${fmt(x.place || x.placeOfIssue)}</td>
      </tr>
    `);
    fillRows('tbody-visas', rows, 6);
  } catch (e) { console.warn('visas', e); }

  // İsteğe bağlı: profil özeti, yetenekler vs için alan eklemek istersen
  // const details = await getDoc(doc(base, 'personalDetails')); ...

</script>
</body>
</html>
