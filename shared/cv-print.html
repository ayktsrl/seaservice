<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Application Form (CV)</title>

<style>
  :root{
    --ink:#0f172a; --muted:#475569; --line:#e2e8f0; --bg:#ffffff;
    --h:#111827;
  }
  *{box-sizing:border-box}
  html,body{background:#f7fafc;margin:0;color:var(--ink);font:14px/1.45 "Inter",system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  main{max-width:1020px;margin:28px auto;background:var(--bg);padding:28px 28px 36px;border:1px solid #e5e7eb;border-radius:10px}
  h1,h2{margin:0 0 .6rem;color:var(--h)}
  h1{font-size:22px;letter-spacing:.2px}
  h2{font-size:16px;border-bottom:2px solid var(--ink);padding-bottom:4px;margin-top:18px}
  .topbar{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .avatar{width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#e2e8f0;font-weight:700}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
  .kv{display:grid;grid-template-columns:220px 1fr;gap:8px;margin:2px 0}
  .card{border:1px solid var(--line);border-radius:8px;padding:10px 12px;background:#fff}
  table{width:100%;border-collapse:collapse;margin-top:6px}
  th,td{border:1px solid var(--line);padding:6px 8px;vertical-align:top}
  th{background:#f3f4f6;text-align:left;font-weight:600}
  .nowrap{white-space:nowrap}
  .center{text-align:center}
  .right{text-align:right}
  .btn-print{all:unset;background:#111827;color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:600}
  .btn-print:hover{background:#0f172a}
  .header-actions{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .subhead{font-weight:700}
  .small{font-size:12px}
  .signature{height:64px;border:1px solid var(--line);border-radius:6px}
  .empty{color:#9ca3af}
  .banner{background:#fff3cd;border:1px solid #ffe69c;color:#594c00;padding:8px 12px;border-radius:6px;margin-bottom:10px;display:none}
  @media print{
    body{background:#fff}
    main{border:none;margin:0;max-width:100%;padding:0}
    .btn-print,.banner{display:none!important}
    a[href]:after{content:""}
    @page { size: A4; margin: 14mm; }
  }
</style>
</head>
<body>
<main>
  <div id="warn" class="banner"></div>

  <div class="header-actions">
    <div class="topbar">
      <div class="avatar"></div>
      <h1>APPLICATION FORM</h1>
    </div>
    <button class="btn-print" onclick="window.print()">Download / Print PDF</button>
  </div>

  <!-- Position Block -->
  <section class="card">
    <div class="grid-2">
      <div class="kv"><div class="subhead">Position applied for</div><div id="pos-applied">—</div></div>
      <div class="kv"><div class="subhead">Lowest rank acceptable</div><div id="pos-lowest">—</div></div>
      <div class="kv"><div class="subhead">Preferred vessel type</div><div id="pos-vessel">—</div></div>
      <div class="kv"><div class="subhead">Readiness date</div><div id="pos-ready">—</div></div>
    </div>
  </section>

  <!-- Personal Details -->
  <h2>Personal Details</h2>
  <section class="card">
    <div class="grid-3">
      <div class="kv"><div class="subhead">Last name</div><div id="pd-last">—</div></div>
      <div class="kv"><div class="subhead">First name</div><div id="pd-first">—</div></div>
      <div class="kv"><div class="subhead">Middle name</div><div id="pd-middle">—</div></div>

      <div class="kv"><div class="subhead">Gender</div><div id="pd-gender">—</div></div>
      <div class="kv"><div class="subhead">Date of birth</div><div id="pd-dob">—</div></div>
      <div class="kv"><div class="subhead">Nationality</div><div id="pd-nationality">—</div></div>

      <div class="kv"><div class="subhead">Place of birth</div><div id="pd-pob">—</div></div>
      <div class="kv"><div class="subhead">Country of Residence</div><div id="pd-cor">—</div></div>
      <div class="kv"><div class="subhead">City of Residence</div><div id="pd-city">—</div></div>

      <div class="kv"><div class="subhead">Phone</div><div id="pd-phone">—</div></div>
      <div class="kv"><div class="subhead">Mobile</div><div id="pd-mobile">—</div></div>
      <div class="kv"><div class="subhead">Zip code</div><div id="pd-zip">—</div></div>

      <div class="kv"><div class="subhead">E-mail</div><div id="pd-email">—</div></div>
      <div class="kv" style="grid-column: span 2;"><div class="subhead">Address</div><div id="pd-address">—</div></div>
    </div>
  </section>

  <!-- Identity Documents -->
  <h2>Identity Documents</h2>
  <section class="card">
    <table>
      <thead>
        <tr>
          <th>Type</th><th class="nowrap">Number</th><th>Issue date</th><th>Expiry date</th><th>Issue country</th>
        </tr>
      </thead>
      <tbody id="tbody-ids">
        <tr><td colspan="5" class="center empty">—</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Education -->
  <h2>Education</h2>
  <section class="card">
    <table>
      <thead>
        <tr>
          <th>Type</th><th>Name</th><th class="nowrap">From year</th><th class="nowrap">To year</th><th>Qualification attained</th>
        </tr>
      </thead>
      <tbody id="tbody-education">
        <tr><td colspan="5" class="center empty">—</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Certificates -->
  <h2>Certificates</h2>
  <section class="card">
    <table>
      <thead>
        <tr>
          <th>Category</th><th class="nowrap">Certificate Number</th><th>Issuing Authority</th><th>Issued</th><th>Expiry</th><th>Place of issue</th>
        </tr>
      </thead>
      <tbody id="tbody-certificates">
        <tr><td colspan="6" class="center empty">—</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Licences -->
  <h2>Licences</h2>
  <section class="card">
    <table>
      <thead>
        <tr>
          <th>Licence</th><th>Capacity</th><th>Rank</th><th>Limitation</th>
          <th>Issuing Authority</th><th>Issued</th><th>Expiry</th><th>Number</th><th>Place of issue</th>
        </tr>
      </thead>
      <tbody id="tbody-licences">
        <tr><td colspan="9" class="center empty">—</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Visas -->
  <h2>Visas</h2>
  <section class="card">
    <table>
      <thead>
        <tr>
          <th>Country</th><th>Number</th><th>Type</th><th>Issued</th><th>Expiry</th><th>Place of issue</th>
        </tr>
      </thead>
      <tbody id="tbody-visas">
        <tr><td colspan="6" class="center empty">—</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Vaccinations -->
  <h2>Vaccinations</h2>
  <section class="card">
    <table>
      <thead>
        <tr>
          <th>Number</th><th>Type</th><th>Issued</th><th>Expires</th><th>Place of issue</th>
        </tr>
      </thead>
      <tbody id="tbody-vaccinations">
        <tr><td colspan="5" class="center empty">—</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Special Skills -->
  <h2>Special Skills</h2>
  <section class="card">
    <table>
      <thead>
        <tr>
          <th>Skill Type</th><th>Vessel</th><th>Rank</th><th>Period</th><th>Charterer / Voyage Info.</th><th>Cargo</th><th>Equipment</th><th>Remarks</th>
        </tr>
      </thead>
      <tbody id="tbody-skills">
        <tr><td colspan="8" class="center empty">—</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Sea Services -->
  <h2>Sea Services</h2>
  <section class="card">
    <table>
      <thead>
        <tr>
          <th>Rank</th><th>Joined</th><th>Signed off</th><th>Period</th>
          <th>Vessel</th><th>Type</th><th>Engine</th>
          <th class="nowrap">GRT</th><th class="nowrap">DWT</th><th class="nowrap">HP</th><th class="nowrap">KW</th>
          <th>Owner / Manager</th>
        </tr>
      </thead>
      <tbody id="tbody-sea">
        <tr><td colspan="12" class="center empty">—</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Pre-Employment Checks -->
  <h2>Pre-Employment Checks</h2>
  <section class="card">
    <div id="preemployment" class="small" style="color:#64748b">No record found</div>
  </section>

  <!-- Experience -->
  <h2>Experience</h2>
  <section class="card">
    <div style="display:flex;gap:16px;flex-wrap:wrap">
      <div style="flex:1;min-width:320px">
        <div class="subhead">Vessel Type</div>
        <table>
          <thead><tr><th>Vessel Type</th><th>Period</th><th>Voyages</th></tr></thead>
          <tbody id="tbody-exp-vessel"><tr><td colspan="3" class="center empty">—</td></tr></tbody>
          <tfoot>
            <tr><th>Total</th><th id="exp-vessel-total-period">—</th><th id="exp-vessel-total-voy">—</th></tr>
          </tfoot>
        </table>
      </div>
      <div style="flex:1;min-width:320px">
        <div class="subhead">Rank</div>
        <table>
          <thead><tr><th>Rank</th><th>Period</th><th>Voyages</th></tr></thead>
          <tbody id="tbody-exp-rank"><tr><td colspan="3" class="center empty">—</td></tr></tbody>
          <tfoot>
            <tr><th>Total</th><th id="exp-rank-total-period">—</th><th id="exp-rank-total-voy">—</th></tr>
          </tfoot>
        </table>
      </div>
    </div>
  </section>

  <!-- Declaration -->
  <h2>Declaration</h2>
  <section class="card">
    <p class="small">
      I hereby certify that the information given above is true and correct to the best of my knowledge and belief.
      Any false declaration may constitute grounds for disqualification.
    </p>
    <div class="grid-3">
      <div>
        <div class="subhead small">Signature:</div>
        <div class="signature"></div>
      </div>
      <div>
        <div class="subhead small">Date:</div>
        <div id="decl-date" class="signature"></div>
      </div>
      <div>
        <div class="subhead small">Rank / Name:</div>
        <div id="decl-rankname" class="signature"></div>
      </div>
    </div>
  </section>
</main>

<script type="module">
  // Firebase (CDN)
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getFirestore, doc, getDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // ---- Config ----
  const firebaseConfig = {
    apiKey: "AIzaSyDuF_HlZYG0v7SUaSzILV584J8b5ybnBUU",
    authDomain: "crewapplication-c37a8.firebaseapp.com",
    projectId: "crewapplication-c37a8",
    storageBucket: "crewapplication-c37a8.firebasestorage.app",
    messagingSenderId: "23423243284",
    appId: "1:23423243284:web:67e22f6ed057c74f4b4301",
    measurementId: "G-DSSJMESQ7Z"
  };

  // ---- Utils ----
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const $  = (s)=>document.querySelector(s);
  const showWarn = (msg)=>{ const b = $('#warn'); b.textContent = msg; b.style.display='block'; };
  const hideWarn = ()=>{ const b=$('#warn'); b.textContent=''; b.style.display='none'; };

  const fmtDate = (v)=>{
    if(!v) return "—";
    if (typeof v === "string") return v;
    if (v.seconds) return new Date(v.seconds*1000).toISOString().slice(0,10);
    if (v instanceof Date) return v.toISOString().slice(0,10);
    return v;
  };
  const safe = (v)=> (v===undefined || v===null || v==="" ? "—" : v);

  // ---- Robust cvid resolver ----
  const resolveCvId = ()=>{
    try{
      const u = new URL(window.location.href);
      let id = u.searchParams.get('cvid') || u.searchParams.get('id');
      if (id) return id;
      // hash like #cvid=...
      if (u.hash && u.hash.length>1){
        const hs = new URLSearchParams(u.hash.replace(/^#/, ''));
        id = hs.get('cvid') || hs.get('id');
        if (id) return id;
      }
      // path like .../cv-print.html/<id>
      const m = u.pathname.match(/cv-print\.html\/([^/?#]+)/i);
      if (m && m[1]) return m[1];
    }catch(e){}
    return null;
  };

  let cvId = resolveCvId();

  if(!cvId){
    showWarn("Tip: Add ?cvid=<CV_ID> to the URL (preview mode shown).");
  }

  // If still no id, stay in preview mode (no throws). We can optionally
  // fill declaration date with today and leave the rest as dashes.
  const fillDeclDate = ()=> { $('#decl-date').textContent = new Date().toISOString().slice(0,10); };
  fillDeclDate();

  // If no cvId, stop fetching but keep the page usable
  if(!cvId){
    // Optional: put a preview name/rank if istersen burayı silebiliriz
    // $('#pos-applied').textContent = "MASTER";
    // $('#pd-first').textContent = "Aykut"; $('#pd-last').textContent="Saral";
  } else {
    hideWarn();

    // Load CV index
    const cvIdxRef = doc(db, 'cvs', cvId);
    const cvIdxSnap = await getDoc(cvIdxRef);
    if(!cvIdxSnap.exists()){
      showWarn("CV not found for ID: "+cvId);
      // continue in empty mode
    }
    const cvIdx = cvIdxSnap.exists()? cvIdxSnap.data() : {};
    const ownerUid = cvIdx.ownerUid;

    // ---- Top / Position
    $('#pos-applied').textContent = safe(cvIdx.position || cvIdx.appliedRank);
    $('#pos-lowest').textContent  = safe(cvIdx.lowestRank || cvIdx.lowestAcceptableRank);
    $('#pos-vessel').textContent  = safe(cvIdx.preferredVesselType || cvIdx.vesselType);
    $('#pos-ready').textContent   = safe(fmtDate(cvIdx.readinessDate || cvIdx.readyDate));

    // Rank/Name for declaration
    const rankName = `${safe(cvIdx.appliedRank || cvIdx.position || '—')} ${safe(cvIdx.lastName ? (cvIdx.lastName + ', ' + (cvIdx.firstName||'')) : (cvIdx.name||''))}`.trim();
    $('#decl-rankname').textContent = rankName!=="—" ? rankName : '—';

    // Base doc ref
    const base = ownerUid ? doc(db, 'seafarers', ownerUid, 'cv', cvId) : null;

    // --- Loaders ---
    const fillTable = (tbodySel, cols, rows)=>{
      const tb = $(tbodySel);
      tb.innerHTML = rows.length? rows.join('') : `<tr><td colspan="${cols}" class="center empty">—</td></tr>`;
    };

    // Personal Details
    try{
      if(base){
        const pdSnap = await getDoc(doc(base,'personalDetails'));
        if(pdSnap.exists()){
          const pd = pdSnap.data();
          $('#pd-last').textContent   = safe(pd.lastName || cvIdx.lastName);
          $('#pd-first').textContent  = safe(pd.firstName || cvIdx.firstName);
          $('#pd-middle').textContent = safe(pd.middleName);
          $('#pd-gender').textContent = safe(pd.gender);
          $('#pd-dob').textContent    = safe(fmtDate(pd.dateOfBirth || pd.dob));
          $('#pd-nationality').textContent = safe(pd.nationality);
          $('#pd-pob').textContent    = safe(pd.placeOfBirth || pd.birthPlace);
          $('#pd-cor').textContent    = safe(pd.countryOfResidence || pd.country);
          $('#pd-city').textContent   = safe(pd.cityOfResidence || pd.city);
          $('#pd-phone').textContent  = safe(pd.phone);
          $('#pd-mobile').textContent = safe(pd.mobile || pd.phone);
          $('#pd-zip').textContent    = safe(pd.zip || pd.postalCode);
          $('#pd-email').textContent  = safe(pd.email);
          $('#pd-address').textContent= safe(pd.address);
        }
      }
    }catch(e){ console.warn('personalDetails', e); }

    const loadItems = async (section)=> {
      if(!base) return [];
      const snap = await getDocs(collection(doc(base,section),'items'));
      return snap.docs.map(d=>({id:d.id, ...d.data()}));
    };

    // Identity docs (documents)
    try{
      const list = await loadItems('documents');
      const rows = list.map(x=>`
        <tr>
          <td>${safe(x.type)}</td>
          <td class="nowrap">${safe(x.number)}</td>
          <td class="nowrap">${safe(fmtDate(x.issueDate || x.issued))}</td>
          <td class="nowrap">${safe(fmtDate(x.expiryDate || x.expiry))}</td>
          <td>${safe(x.issueCountry || x.country)}</td>
        </tr>
      `);
      fillTable('#tbody-ids',5,rows);
    }catch(e){ console.warn('documents', e); }

    // Education
    try{
      const list = await loadItems('education');
      const rows = list.map(x=>`
        <tr>
          <td>${safe(x.type || 'University')}</td>
          <td>${safe(x.name || x.university)}</td>
          <td class="nowrap">${safe(x.fromYear || x.from)}</td>
          <td class="nowrap">${safe(x.toYear || x.to)}</td>
          <td>${safe(x.qualification || x.department)}</td>
        </tr>
      `);
      fillTable('#tbody-education',5,rows);
    }catch(e){ console.warn('education', e); }

    // Certificates
    try{
      const list = await loadItems('certificates');
      const rows = list.map(x=>`
        <tr>
          <td>${safe(x.category || x.name)}</td>
          <td>${safe(x.number)}</td>
          <td>${safe(x.authority || x.issuingAuthority)}</td>
          <td class="nowrap">${safe(fmtDate(x.issue || x.issued))}</td>
          <td class="nowrap">${safe(fmtDate(x.expiry))}</td>
          <td>${safe(x.place || x.placeOfIssue)}</td>
        </tr>
      `);
      fillTable('#tbody-certificates',6,rows);
    }catch(e){ console.warn('certificates', e); }

    // Licences
    try{
      const list = await loadItems('licenses');
      const rows = list.map(x=>`
        <tr>
          <td>${safe(x.licence || x.license || 'CERTIFICATE OF COMPETENCY')}</td>
          <td>${safe(x.capacity)}</td>
          <td>${safe(x.rank)}</td>
          <td>${safe(x.limitation)}</td>
          <td>${safe(x.authority)}</td>
          <td class="nowrap">${safe(fmtDate(x.issued))}</td>
          <td class="nowrap">${safe(fmtDate(x.expiry))}</td>
          <td>${safe(x.number)}</td>
          <td>${safe(x.place)}</td>
        </tr>
      `);
      fillTable('#tbody-licences',9,rows);
    }catch(e){ console.warn('licenses', e); }

    // Visas
    try{
      const list = await loadItems('visas');
      const rows = list.map(x=>`
        <tr>
          <td>${safe(x.country)}</td>
          <td>${safe(x.number)}</td>
          <td>${safe(x.type)}</td>
          <td class="nowrap">${safe(fmtDate(x.issued || x.issueDate))}</td>
          <td class="nowrap">${safe(fmtDate(x.expiry || x.expiryDate))}</td>
          <td>${safe(x.place || x.placeOfIssue)}</td>
        </tr>
      `);
      fillTable('#tbody-visas',6,rows);
    }catch(e){ console.warn('visas', e); }

    // Vaccinations
    try{
      const list = await loadItems('vaccinations');
      const rows = list.map(x=>`
        <tr>
          <td>${safe(x.number || '')}</td>
          <td>${safe(x.type)}</td>
          <td class="nowrap">${safe(fmtDate(x.issued))}</td>
          <td class="nowrap">${safe(fmtDate(x.expires))}</td>
          <td>${safe(x.place)}</td>
        </tr>
      `);
      fillTable('#tbody-vaccinations',5,rows);
    }catch(e){ console.warn('vaccinations', e); }

    // Special Skills
    try{
      const list = await loadItems('specialSkills');
      const rows = list.map(x=>`
        <tr>
          <td>${safe(x.skillType || x.type)}</td>
          <td>${safe(x.vessel)}</td>
          <td>${safe(x.rank)}</td>
          <td class="nowrap">${safe(x.period)}</td>
          <td>${safe(x.charterer || x.voyageInfo)}</td>
          <td>${safe(x.cargo)}</td>
          <td>${safe(x.equipment)}</td>
          <td>${safe(x.remarks)}</td>
        </tr>
      `);
      fillTable('#tbody-skills',8,rows);
    }catch(e){ console.warn('specialSkills', e); }

    // Sea Services + Experience
    const parseDays = (s,e)=>{
      const S = new Date(s), E = new Date(e);
      if(isNaN(+S)||isNaN(+E)) return 0;
      return Math.max(0, Math.round((E-S)/86400000));
    };
    const daysToYMD = (d)=>{
      const y=Math.floor(d/365), m=Math.floor(d%365/30), dd=Math.floor(d%365%30);
      return `${y}Y ${m}M ${dd}D`;
    };

    let expByVessel = new Map(), expByRank = new Map();
    let totalDays=0, totalVoy=0;

    try{
      const list = await loadItems('seaService');
      const rows = list.map(x=>{
        const joined = fmtDate(x.joined || x.start);
        const signed = fmtDate(x.signedOff || x.end);
        const rank   = safe(x.rank);
        const type   = safe(x.type || x.vesselType);
        const dcount = parseDays(joined, signed);
        totalDays += dcount; totalVoy += 1;

        if(!expByVessel.has(type)) expByVessel.set(type,{days:0,voyages:0});
        expByVessel.get(type).days += dcount; expByVessel.get(type).voyages += 1;

        if(!expByRank.has(rank)) expByRank.set(rank,{days:0,voyages:0});
        expByRank.get(rank).days += dcount; expByRank.get(rank).voyages += 1;

        return `
          <tr>
            <td>${rank}</td>
            <td class="nowrap">${joined}</td>
            <td class="nowrap">${signed}</td>
            <td class="nowrap">${daysToYMD(dcount)}</td>
            <td>${safe(x.vessel)}</td>
            <td>${type}</td>
            <td>${safe(x.engine)}</td>
            <td class="right">${safe(x.grt || x.GRT || '')}</td>
            <td class="right">${safe(x.dwt || x.DWT || '')}</td>
            <td class="right">${safe(x.hp  || x.HP  || '')}</td>
            <td class="right">${safe(x.kw  || x.KW  || '')}</td>
            <td>${safe(x.owner || x.manager || x['owner/manager'])}</td>
          </tr>
        `;
      });
      fillTable('#tbody-sea',12,rows);

      const vRows=[]; expByVessel.forEach((v,k)=>vRows.push(`<tr><td>${k}</td><td class="nowrap">${daysToYMD(v.days)}</td><td class="right">${v.voyages}</td></tr>`));
      const rRows=[]; expByRank.forEach((v,k)=>rRows.push(`<tr><td>${k}</td><td class="nowrap">${daysToYMD(v.days)}</td><td class="right">${v.voyages}</td></tr>`));
      $('#tbody-exp-vessel').innerHTML = vRows.length? vRows.join('') : `<tr><td colspan="3" class="center empty">—</td></tr>`;
      $('#tbody-exp-rank').innerHTML   = rRows.length? rRows.join('') : `<tr><td colspan="3" class="center empty">—</td></tr>`;
      $('#exp-vessel-total-period').textContent = daysToYMD(totalDays);
      $('#exp-vessel-total-voy').textContent    = String(totalVoy);
      $('#exp-rank-total-period').textContent   = daysToYMD(totalDays);
      $('#exp-rank-total-voy').textContent      = String(totalVoy);
    }catch(e){ console.warn('seaService/experience', e); }

    // Declaration date
    const declDate = cvIdx.declarationDate ? fmtDate(cvIdx.declarationDate) : new Date().toISOString().slice(0,10);
    $('#decl-date').textContent = declDate;
  }
</script>
</body>
</html>
