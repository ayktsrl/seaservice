<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Seafarer CV</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#f6f8fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
      --pill:#eef2ff; --pill-ink:#3730a3; --accent:#2563eb;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font:14px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    .page{max-width:1040px;margin:24px auto;padding:0 16px 64px}
    .header{display:flex;align-items:flex-end;gap:16px;margin:8px 0 16px}
    .name{font-size:28px;font-weight:700}
    .applied{color:var(--muted);font-weight:600}
    .grid{display:grid;gap:16px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    .card{background:var(--card);border:1px solid var(--line);border-radius:12px;box-shadow:0 1px 1.5px rgba(2,8,20,.04),0 1px 2px rgba(2,8,20,.08)}
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--line);font-weight:700}
    .card .bd{padding:12px 16px}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:6px 12px}
    .kv .k{color:var(--muted)}
    .pill{display:inline-block;background:var(--pill);color:var(--pill-ink);padding:3px 10px;border-radius:999px;font-weight:600;font-size:12px;border:1px solid #dbeafe;margin-right:6px;margin-bottom:4px}
    .table{width:100%;border-collapse:collapse;font-size:13px}
    .table th,.table td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
    .table th{color:var(--muted);font-weight:700;font-size:12px;letter-spacing:.02em}
    .muted{color:var(--muted)}
    .float-btn{position:fixed;right:18px;bottom:18px;background:var(--accent);color:#fff;border:none;border-radius:999px;padding:10px 14px;font-weight:700;box-shadow:0 10px 25px rgba(37,99,235,.25);cursor:pointer}
    @media print{
      .float-btn{display:none}
      body{background:#fff}
      .page{max-width:none;margin:0;padding:0}
      .card{page-break-inside:avoid}
    }
  </style>
</head>
<body>
  <div class="page" id="page">
    <div class="header">
      <div>
        <div class="name" id="fullName">Full Name</div>
        <div class="applied" id="appliedRank">Applied Rank</div>
      </div>
    </div>

    <!-- PROFILE -->
    <div class="card">
      <div class="hd">Profile</div>
      <div class="bd grid cols-2">
        <div class="kv">
          <div class="k">Summary</div><div id="summary" class="muted">Experienced seafarer...</div>
          <div class="k">Key metrics</div>
          <div class="muted">
            Total verified: <span id="totalVerified">—</span> — 
            Last contract: <span id="lastContract">—</span> — 
            Flags served: <span id="flagsServed">—</span>
          </div>
        </div>
        <div>
          <div class="k muted" style="margin-bottom:6px">Special skills</div>
          <div id="skillsWrap">—</div>
        </div>
      </div>
    </div>

    <!-- SEA SERVICE -->
    <div class="card" style="margin-top:16px">
      <div class="hd">Sea Service History</div>
      <div class="bd">
        <table class="table" id="tblSea">
          <thead>
          <tr>
            <th>Vessel</th><th>IMO</th><th>Type</th><th>GRT/DWT</th><th>Flag</th><th>Rank</th>
            <th>Start</th><th>End</th><th>Days</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="muted" id="seaEmpty">—</div>
      </div>
    </div>

    <!-- LICENSES + CERTIFICATES -->
    <div class="grid cols-2" style="margin-top:16px">
      <div class="card">
        <div class="hd">Licenses</div>
        <div class="bd">
          <table class="table" id="tblLic">
            <thead>
            <tr><th>Type</th><th>Rank</th><th>Number</th><th>Issued</th><th>Expiry</th><th>Place</th><th>Authority</th></tr>
            </thead><tbody></tbody>
          </table>
          <div class="muted" id="licEmpty">—</div>
        </div>
      </div>
      <div class="card">
        <div class="hd">Certificates</div>
        <div class="bd">
          <table class="table" id="tblCert">
            <thead><tr><th>Certificate</th><th>Issue</th><th>Expiry</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="muted" id="certEmpty">—</div>
        </div>
      </div>
    </div>

    <!-- EDUCATION -->
    <div class="card" style="margin-top:16px">
      <div class="hd">Education</div>
      <div class="bd">
        <table class="table" id="tblEdu">
          <thead><tr><th>University</th><th>Department</th><th>City</th><th>From</th><th>To</th><th>GPA</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="muted" id="eduEmpty">—</div>
      </div>
    </div>

    <!-- TRAVEL DOCS + VISAS -->
    <div class="grid cols-2" style="margin-top:16px">
      <div class="card">
        <div class="hd">Travel Documents</div>
        <div class="bd">
          <table class="table" id="tblDocs">
            <thead><tr><th>Type</th><th>Number</th><th>Issue Country</th><th>Issued</th><th>Expiry</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="muted" id="docsEmpty">—</div>
        </div>
      </div>
      <div class="card">
        <div class="hd">Visas</div>
        <div class="bd">
          <table class="table" id="tblVisas">
            <thead><tr><th>Country</th><th>Type</th><th>Number</th><th>Issued</th><th>Expiry</th><th>Place</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="muted" id="visasEmpty">—</div>
        </div>
      </div>
    </div>
  </div>

  <button class="float-btn" onclick="window.print()">Download PDF</button>

  <!-- Firebase -->
  <script type="module">
    // Firebase configinizi kök dizindeki /firebase-config.js dosyasına koymuştunuz.
    // Buradan app/auth/db'yi içe aktarıyoruz:
    import { app, auth, db } from '/firebase-config.js';

    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      collection, doc, getDoc, getDocs, query, where, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ---------- Helpers
    const $ = (sel) => document.querySelector(sel);
    const tbodyOf = (id) => $(`#${id} tbody`);
    const fmt = (d) => !d ? "—" : (typeof d === 'string' ? d : new Date(d.seconds*1000).toISOString().slice(0,10));
    const text = (sel, val) => { const el=$(sel); if (el) el.textContent = (val ?? "—"); };

    function addRow(tbody, cells){
      const tr = document.createElement('tr');
      cells.forEach(c=>{
        const td = document.createElement('td');
        td.textContent = (c ?? "—");
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }

    // --------- cvId garantile (param yoksa en güncel CV)
    async function ensureCvId(){
      const sp = new URLSearchParams(location.search);
      let cvId = sp.get('cvId') || sp.get('id');
      if (cvId) return cvId;

      const user = await new Promise(res=>{
        if (auth.currentUser) return res(auth.currentUser);
        onAuthStateChanged(auth, res);
      });
      if (!user){ location.href='/index.html'; return null; }

      const q = query(
        collection(db,'cvs'),
        where('ownerUid','==',user.uid),
        orderBy('updatedAt','desc'),
        limit(1)
      );
      const snap = await getDocs(q);
      if (snap.empty){ alert('Bu kullanıcı için CV bulunamadı.'); return null; }
      cvId = snap.docs[0].id;
      history.replaceState({},'',`${location.pathname}?cvId=${cvId}`);
      return cvId;
    }

    // --------- {collection}/{doc}/items alt koleksiyonunu bul
    async function itemsCollection(ownerUid, cvId, collName){
      // 1) cv/{cvId}/{collName} içindeki kapsayıcı doc'u bul
      const top = collection(db,'seafarers',ownerUid,'cv',cvId,collName);
      const topSnap = await getDocs(top);
      if (topSnap.empty) return null;
      // genelde tek doc var; ilkiyle ilerleyelim
      const containerId = topSnap.docs[0].id;
      // 2) .../{collName}/{containerId}/items alt koleksiyonu
      return collection(db,'seafarers',ownerUid,'cv',cvId,collName,containerId,'items');
    }

    // --------- Ana yükleme
    (async () => {
      const cvId = await ensureCvId();
      if (!cvId) return;

      // CV belgisi
      const cvRef = doc(db,'cvs',cvId);
      const cvSnap = await getDoc(cvRef);
      if (!cvSnap.exists()){ alert('CV bulunamadı'); return; }
      const cv = cvSnap.data();

      text('#fullName', cv.name || cv.fullName || 'Full Name');
      text('#appliedRank', cv.position || cv.appliedRank || 'Applied Rank');

      const ownerUid = cv.ownerUid;

      // ---- Special skills
      try{
        const ics = await itemsCollection(ownerUid, cvId, 'specialSkills');
        const wrap = $('#skillsWrap'); wrap.innerHTML='';
        if (!ics){ wrap.textContent='—'; }
        else {
          const sk = await getDocs(ics);
          if (sk.empty) wrap.textContent='—';
          else sk.forEach(d=>{
            const x=d.data();
            const name = x.skill || x.skillType || x.name;
            const tag = document.createElement('span');
            tag.className='pill'; tag.textContent = name || '—';
            wrap.appendChild(tag);
          });
        }
      }catch(e){ console.warn('specialSkills',e); }

      // ---- Sea service
      try{
        const ics = await itemsCollection(ownerUid, cvId, 'seaService');
        const tb = tbodyOf('tblSea'); let totalDays=0, lastEnd=null, flagsSet=new Set();
        if (!ics){ $('#seaEmpty').style.display='block'; }
        else {
          const snap = await getDocs(ics);
          if (snap.empty) $('#seaEmpty').style.display='block';
          else {
            $('#seaEmpty').style.display='none';
            snap.forEach(d=>{
              const x=d.data();
              addRow(tb,[x.vessel,x.imo,x.type,x.grtDwt||x.grt||x.dwt,x.flag,x.rank,fmt(x.start||x.from),fmt(x.end||x.to),x.days]);
              if (x.days) totalDays += Number(x.days)||0;
              if (x.end) {
                const eDate = new Date(fmt(x.end));
                if (!lastEnd || eDate>new Date(fmt(lastEnd))) lastEnd = x.end;
              }
              if (x.flag) flagsSet.add(x.flag);
            });
          }
        }
        text('#totalVerified', totalDays ? `${totalDays} d` : '—');
        text('#lastContract', fmt(lastEnd));
        text('#flagsServed', flagsSet.size ? Array.from(flagsSet).join(', ') : '—');
      }catch(e){ console.warn('seaService',e); }

      // ---- Licenses
      try{
        const ics = await itemsCollection(ownerUid, cvId, 'licenses');
        const tb = tbodyOf('tblLic');
        if (!ics){ $('#licEmpty').style.display='block'; }
        else {
          const snap = await getDocs(ics);
          if (snap.empty) $('#licEmpty').style.display='block';
          else {
            $('#licEmpty').style.display='none';
            snap.forEach(d=>{
              const x=d.data();
              addRow(tb,[x.type,x.rank,x.number,fmt(x.issued),fmt(x.expiry),x.place,x.authority]);
            });
          }
        }
      }catch(e){ console.warn('licenses',e); }

      // ---- Certificates
      try{
        const ics = await itemsCollection(ownerUid, cvId, 'certificates');
        const tb = tbodyOf('tblCert');
        if (!ics){ $('#certEmpty').style.display='block'; }
        else {
          const snap = await getDocs(ics);
          if (snap.empty) $('#certEmpty').style.display='block';
          else {
            $('#certEmpty').style.display='none';
            snap.forEach(d=>{
              const x=d.data();
              addRow(tb,[x.name,fmt(x.issue||x.issued),fmt(x.expiry)]);
            });
          }
        }
      }catch(e){ console.warn('certificates',e); }

      // ---- Education
      try{
        const ics = await itemsCollection(ownerUid, cvId, 'education');
        const tb = tbodyOf('tblEdu');
        if (!ics){ $('#eduEmpty').style.display='block'; }
        else {
          const snap = await getDocs(ics);
          if (snap.empty) $('#eduEmpty').style.display='block';
          else {
            $('#eduEmpty').style.display='none';
            snap.forEach(d=>{
              const x=d.data();
              addRow(tb,[x.university||x.school,x.department,x.city,fmt(x.from),fmt(x.to),x.gpa]);
            });
          }
        }
      }catch(e){ console.warn('education',e); }

      // ---- Documents (passport, seaman book)
      try{
        const ics = await itemsCollection(ownerUid, cvId, 'documents');
        const tb = tbodyOf('tblDocs');
        if (!ics){ $('#docsEmpty').style.display='block'; }
        else {
          const snap = await getDocs(ics);
          if (snap.empty) $('#docsEmpty').style.display='block';
          else {
            $('#docsEmpty').style.display='none';
            snap.forEach(d=>{
              const x=d.data();
              addRow(tb,[x.type,x.number,x.issueCountry||x.country,fmt(x.issued),fmt(x.expiry)]);
            });
          }
        }
      }catch(e){ console.warn('documents',e); }

      // ---- Visas
      try{
        const ics = await itemsCollection(ownerUid, cvId, 'visas');
        const tb = tbodyOf('tblVisas');
        if (!ics){ $('#visasEmpty').style.display='block'; }
        else {
          const snap = await getDocs(ics);
          if (snap.empty) $('#visasEmpty').style.display='block';
          else {
            $('#visasEmpty').style.display='none';
            snap.forEach(d=>{
              const x=d.data();
              addRow(tb,[x.country,x.type,x.number,fmt(x.issued),fmt(x.expiry),x.place]);
            });
          }
        }
      }catch(e){ console.warn('visas',e); }
    })();
  </script>
</body>
</html>
