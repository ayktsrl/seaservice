<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Seafarer CV</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/style.css" />
  <style>
    @media (max-width: 768px) {
      h2 { font-size: 1.5rem; text-align: center; }
      h4 { font-size: 1.2rem; }
      .card { margin-bottom: 1rem; }
    }
  </style>
</head>
<body class="bg-light">
  <!-- Ortak Navbar -->
  <div id="navbar-container"></div>
  <script>
    fetch('/common-navbar.html')
      .then(res => res.text())
      .then(html => {
        const container = document.getElementById('navbar-container');
        container.innerHTML = html;
        container.querySelectorAll("script").forEach(oldScript => {
          const s = document.createElement("script");
          if (oldScript.src) s.src = oldScript.src; else s.textContent = oldScript.textContent;
          document.body.appendChild(s);
        });
      });
  </script>

  <div class="container py-5">
    <h2 class="mb-4 text-center">Seafarer CV</h2>

    <div class="alert d-none" id="infoBox"></div>

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h4 class="card-title">Personal Details</h4>
        <p><strong>Full Name:</strong> <span id="fullName">Loading...</span></p>
        <p><strong>Email:</strong> <span id="email">Loading...</span></p>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h4 class="card-title">Qualifications</h4>
        <p><strong>Applied Rank:</strong> <span id="rank">Loading...</span></p>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h4 class="card-title">Experience</h4>
        <p><span id="experience">Loading...</span></p>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        <h4 class="card-title">Certificates</h4>
        <ul id="certificatesList"><li>Loading...</li></ul>
      </div>
    </div>

    <div id="errorMsg" class="text-danger text-center mt-4"></div>
  </div>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = window.firebaseConfig ?? { /* your config if not global */ };
    const app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const params = new URLSearchParams(location.search);
    const cvIdParam = params.get('cvId');
    const legacyUidParam = params.get('userId') || params.get('uid'); // eski kullanım

    const fullName = document.getElementById("fullName");
    const email = document.getElementById("email");
    const rank = document.getElementById("rank");
    const experience = document.getElementById("experience");
    const certificatesList = document.getElementById("certificatesList");
    const errorMsg = document.getElementById("errorMsg");
    const infoBox = document.getElementById("infoBox");

    let viewer = null;

    onAuthStateChanged(auth, async (user) => {
      viewer = user;
      try {
        await loadCV();
      } catch (e) {
        errorMsg.textContent = "Error loading CV: " + e.message;
      }
    });

    async function loadCV() {
      // Mode A: cvId üzerinden (önerilen)
      if (cvIdParam) {
        const metaRef = doc(db, 'cvs', cvIdParam);
        const metaSnap = await getDoc(metaRef);
        if (!metaSnap.exists()) throw new Error("CV not found");
        const meta = metaSnap.data(); // { ownerUid, public, ... }

        const isOwner = viewer && meta.ownerUid === viewer.uid;
        if (!meta.public && !isOwner) {
          showInfo('This CV is not published yet. Only the owner can view it.', 'warning');
          throw new Error("Not published");
        }

        await loadSeafarerCvByOwner(meta.ownerUid);
        showInfo(meta.public ? 'This CV is published.' : 'This CV is in draft (only visible to you).', meta.public ? 'success' : 'secondary', isOwner);
        return;
      }

      // Mode B (legacy): userId/uid parametresi ile sadece owner görebilsin
      if (legacyUidParam) {
        if (!viewer || viewer.uid !== legacyUidParam) {
          showInfo('This private draft CV can be viewed only by its owner.', 'warning');
          throw new Error("Not authorized");
        }
        await loadSeafarerCvByOwner(legacyUidParam);
        showInfo('Private draft view (owner only).', 'secondary', true);
        return;
      }

      throw new Error("No CV specified.");
    }

    async function loadSeafarerCvByOwner(ownerUid){
      // Personal Details
      const personalRef = doc(db, "seafarers", ownerUid, "cv", "personalDetails");
      const qualRef = doc(db, "seafarers", ownerUid, "cv", "qualifications");
      const certCol = collection(db, "seafarers", ownerUid, "cv", "certificates/items");
      const seaServiceCol = collection(db, "seafarers", ownerUid, "seaService");

      const personalSnap = await getDoc(personalRef);
      let fName = "-", mail = "-";
      if (personalSnap.exists()) {
        const d = personalSnap.data();
        fName = ((d.firstName || "") + " " + (d.middleName || "") + " " + (d.lastName || "")).replace(/\s+/g, " ").trim();
        mail = d.email || "-";
      }
      fullName.textContent = fName;
      email.textContent = mail;

      const qualSnap = await getDoc(qualRef);
      rank.textContent = (qualSnap.exists() && qualSnap.data().rankApplied) ? qualSnap.data().rankApplied : "-";

      let totalDays = 0;
      const seaSnaps = await getDocs(seaServiceCol);
      seaSnaps.forEach(doc => {
        const d = doc.data();
        if (d.isVerified && d.start && d.end) {
          const s = new Date(d.start), e = new Date(d.end);
          const diff = Math.floor((e - s) / (1000 * 60 * 60 * 24));
          if (!isNaN(diff) && diff > 0) totalDays += diff;
        }
      });
      const years = Math.floor(totalDays / 365), months = Math.floor((totalDays % 365) / 30), days = totalDays % 30;
      experience.textContent = (totalDays > 0) ? `${years}y ${months}m ${days}d (${totalDays} days)` : "-";

      certificatesList.innerHTML = "";
      const certSnaps = await getDocs(certCol);
      if (certSnaps.size === 0) {
        certificatesList.innerHTML = "<li>No certificates listed.</li>";
      } else {
        certSnaps.forEach(doc => {
          const d = doc.data();
          certificatesList.innerHTML += `<li><b>${escapeHtml(d.type || d.category || "Certificate")}</b> - ${escapeHtml(d.number || "")} (${escapeHtml(d.expiry || "No Expiry")})</li>`;
        });
      }
    }

    function showInfo(text, type='info', owner=false){
      infoBox.className = 'alert alert-' + type;
      infoBox.textContent = text + (owner ? ' (Owner view)' : '');
      infoBox.classList.remove('d-none');
    }

    function escapeHtml(s){ return (s??'').toString().replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
