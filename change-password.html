<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Change Password ‚Ä¢ Orion</title>
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="manifest" href="/site.webmanifest">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/style.css" />
  <style>
    body { background:#f6f7fb; }
    .form-box { max-width:520px; margin:48px auto; background:#fff; border-radius:16px; padding:28px 24px; box-shadow:0 8px 26px rgba(0,0,0,.08); }
    .eye-btn { background:none; border:0; cursor:pointer; }
    @media (max-width: 768px) { .form-box { margin:20px; padding:20px; } }
  </style>
</head>
<body class="bg-light">

  <!-- Common Navbar -->
  <div id="navbar-container"></div>
  <script>
    // Load common navbar and EXECUTE any <script> tags inside it
    fetch('/common-navbar.html')
      .then(res => res.text())
      .then(html => {
        const c = document.getElementById('navbar-container');
        c.innerHTML = html;
        c.querySelectorAll('script').forEach(s => {
          const n = document.createElement('script');
          if (s.type) n.type = s.type; // keep type="module"
          if (s.src) n.src = s.src; else n.textContent = s.textContent;
          document.body.appendChild(n);
        });
      });
  </script>

  <div class="form-box shadow-sm">
    <h4 class="mb-3 text-center">Change Password</h4>

    <div id="msg" class="alert d-none" role="alert"></div>

    <form id="changePasswordForm" novalidate>
      <div class="mb-3">
        <label class="form-label" for="currentPassword">Current Password</label>
        <div class="input-group">
          <input type="password" class="form-control" id="currentPassword" autocomplete="current-password" required />
          <button type="button" class="eye-btn input-group-text" data-target="currentPassword" aria-label="Show password" aria-pressed="false">üëÅÔ∏è</button>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label" for="newPassword">New Password</label>
        <div class="input-group">
          <input type="password" class="form-control" id="newPassword" autocomplete="new-password" minlength="6" required />
          <button type="button" class="eye-btn input-group-text" data-target="newPassword" aria-label="Show password" aria-pressed="false">üëÅÔ∏è</button>
        </div>
        <div class="form-text">Minimum 6 characters.</div>
      </div>

      <div class="mb-3">
        <label class="form-label" for="confirmPassword">Confirm New Password</label>
        <div class="input-group">
          <input type="password" class="form-control" id="confirmPassword" autocomplete="new-password" required />
          <button type="button" class="eye-btn input-group-text" data-target="confirmPassword" aria-label="Show password" aria-pressed="false">üëÅÔ∏è</button>
        </div>
      </div>

      <button type="submit" id="submitBtn" class="btn btn-primary w-100">Update Password</button>
    </form>
  </div>

  <script>
    // Show/Hide password toggles
    document.addEventListener('click', (e)=>{
      if (!e.target.matches('.eye-btn')) return;
      const id = e.target.getAttribute('data-target');
      const input = document.getElementById(id);
      const hidden = input.type === 'password';
      input.type = hidden ? 'text' : 'password';
      e.target.setAttribute('aria-pressed', String(hidden));
      e.target.textContent = hidden ? 'üôà' : 'üëÅÔ∏è';
      input.focus({ preventScroll:true });
    });
  </script>

  <script type="module">
    import { auth } from '/firebase-config.js';
    import {
      onAuthStateChanged,
      updatePassword,
      EmailAuthProvider,
      reauthenticateWithCredential
    } from 'https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js';

    const form = document.getElementById("changePasswordForm");
    const msg  = document.getElementById("msg");
    const btn  = document.getElementById("submitBtn");

    const showMsg = (text, type='info') => {
      msg.textContent = text;
      msg.className = `alert alert-${type}`;
      msg.classList.remove('d-none');
    };

    onAuthStateChanged(auth, (user)=>{
      if (!user) {
        showMsg('You must be logged in to change your password.', 'warning');
      }
    });

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      msg.classList.add('d-none');

      const currentPassword = document.getElementById("currentPassword").value;
      const newPassword     = document.getElementById("newPassword").value;
      const confirmPassword = document.getElementById("confirmPassword").value;

      if (!auth.currentUser) { return showMsg("You must be logged in.", "danger"); }
      if (newPassword !== confirmPassword) { return showMsg("New passwords do not match.", "danger"); }
      if (newPassword.length < 6) { return showMsg("New password must be at least 6 characters.", "danger"); }
      if (currentPassword && currentPassword === newPassword) { return showMsg("New password cannot be the same as current password.", "danger"); }

      // lock button
      btn.disabled = true;
      const original = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Updating‚Ä¶';

      try {
        // try direct update
        await updatePassword(auth.currentUser, newPassword);
        showMsg("Password updated successfully.", "success");
        form.reset();
      } catch (err) {
        if (err && err.code === 'auth/requires-recent-login') {
          // do reauth with current password (if provided)
          if (!currentPassword) {
            showMsg("Please enter your current password to continue.", "warning");
          } else {
            try {
              const cred = EmailAuthProvider.credential(auth.currentUser.email, currentPassword);
              await reauthenticateWithCredential(auth.currentUser, cred);
              await updatePassword(auth.currentUser, newPassword);
              showMsg("Password updated successfully.", "success");
              form.reset();
            } catch (reauthErr) {
              console.error(reauthErr);
              const code = reauthErr.code || '';
              let m = 'Reauthentication failed. Please check your current password.';
              if (code.includes('wrong-password')) m = 'Current password is incorrect.';
              showMsg(m, 'danger');
            }
          }
        } else {
          console.error(err);
          let m = 'Update failed. Please try again.';
          const code = err.code || '';
          if (code.includes('weak-password')) m = 'New password is too weak (min 6 characters).';
          showMsg(m, 'danger');
        }
      } finally {
        btn.disabled = false;
        btn.innerHTML = original;
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
