<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDuF_HlZYG0v7SUaSzILV584J8b5ybnBUU",
    authDomain: "crewapplication-c37a8.firebaseapp.com",
    projectId: "crewapplication-c37a8",
    storageBucket: "crewapplication-c37a8.appspot.com",
    messagingSenderId: "23423243284",
    appId: "1:23423243284:web:67e22f6ed057c74f4b4301"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const translations = {
    en: {
      loginTitle: "Log in",
      email: "E-mail",
      password: "Password",
      forgot: "Forgot Password?",
      loginBtn: "Login",
      registerBtn: "Register new application",
      newApps: "New Applications",
      emailRequired: "Please enter your email to reset password.",
      resetSent: "Password reset email sent. Please check your inbox.",
      loginSuccess: "Login successful!",
      loginFail: "Login failed: "
    },
    tr: {
      loginTitle: "Giriş Yap",
      email: "E-posta",
      password: "Şifre",
      forgot: "Şifremi Unuttum?",
      loginBtn: "Giriş Yap",
      registerBtn: "Yeni Başvuru",
      newApps: "Yeni Başvurular",
      emailRequired: "Şifre sıfırlamak için lütfen e-posta girin.",
      resetSent: "Şifre sıfırlama bağlantısı gönderildi. Lütfen e-postanızı kontrol edin.",
      loginSuccess: "Giriş başarılı!",
      loginFail: "Giriş başarısız: "
    }
  };

  function applyLanguage(lang) {
    const t = translations[lang];
    document.getElementById("loginTitle").innerText = t.loginTitle;
    document.getElementById("emailLabel").innerText = t.email;
    document.getElementById("passwordLabel").innerText = t.password;
    document.getElementById("forgotPassword").innerText = t.forgot;
    document.getElementById("loginBtn").innerText = t.loginBtn;
    document.getElementById("newApps").innerText = t.newApps;
    document.getElementById("registerBtn").innerText = t.registerBtn;
    localStorage.setItem("lang", lang);
  }

  function setLanguage(lang) {
    applyLanguage(lang);
  }
  window.setLanguage = setLanguage;

  window.onload = () => {
    const savedLang = localStorage.getItem("lang") || "en";
    document.getElementById("languageSelector").value = savedLang;
    applyLanguage(savedLang);
  };

  window.loginUser = function(e) {
    e.preventDefault();
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    const lang = localStorage.getItem("lang") || "en";
    const t = translations[lang];

    signInWithEmailAndPassword(auth, email, password)
      .then(async (userCredential) => {
        const uid = userCredential.user.uid;
        const seafarerDoc = await getDoc(doc(db, "seafarers", uid));
        const companyDoc = await getDoc(doc(db, "companies", uid));

        if (companyDoc.exists()) {
          window.location.href = "company-dashboard.html";
        } else if (seafarerDoc.exists()) {
          window.location.href = "job-board.html";
        } else {
          alert("Unknown user role.");
        }
      })
      .catch(error => {
        alert(t.loginFail + error.message);
      });
  };

  window.forgotPassword = function() {
    const email = document.getElementById("email").value;
    const lang = localStorage.getItem("lang") || "en";
    const t = translations[lang];
    if (!email) {
      alert(t.emailRequired);
      return;
    }
    sendPasswordResetEmail(auth, email)
      .then(() => alert(t.resetSent))
      .catch(error => alert("Error: " + error.message));
  };
</script>
