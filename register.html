<script type="module">
  import { auth, firestore } from './firebase-config.js';
  import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import {
    doc, setDoc, getDoc, query, collection, where, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const form = document.getElementById("registerForm");
  const errorMsg = document.getElementById("errorMsg");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    errorMsg.textContent = "";

    const userType = document.querySelector('input[name="userType"]:checked')?.value;
    const username = document.getElementById("usernameInput").value.trim();
    const email = document.getElementById("emailInput").value.trim();
    const password = document.getElementById("passwordInput").value;

    if (!userType || !username || !email || !password) {
      errorMsg.textContent = "All fields are required.";
      return;
    }

    const collectionName =
      userType === "seafarer" ? "seafarers" :
      userType === "company" ? "companies" :
      "agencies";

    const redirectURL =
      userType === "seafarer" ? "Seafarer/seafarer-dashboard.html" :
      userType === "company" ? "Company/company-dashboard.html" :
      userType === "agency" ? "Agency/agency-dashboard.html" :
      null;

    if (!redirectURL) {
      errorMsg.textContent = "Invalid user type selected.";
      return;
    }

    try {
      const usernameRef = doc(firestore, collectionName, username);
      const usernameSnap = await getDoc(usernameRef);
      if (usernameSnap.exists()) {
        errorMsg.textContent = "Username already in use.";
        return;
      }

      const q = query(collection(firestore, collectionName), where("email", "==", email));
      const existingEmail = await getDocs(q);
      if (!existingEmail.empty) {
        errorMsg.textContent = "Email already registered.";
        return;
      }

      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const uid = userCredential.user.uid;

      const data = {
        uid: uid,
        email: email,
        username: username,
        userType: userType,
        createdAt: new Date().toISOString()
      };

      await setDoc(usernameRef, data);

      localStorage.setItem("username", username);
      localStorage.setItem("role", userType);

      window.location.href = redirectURL;

    } catch (err) {
      errorMsg.textContent = err.message;
    }
  });
</script>
