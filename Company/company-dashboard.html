<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Company Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    .table-sm td, .table-sm th { padding:.35rem .5rem; font-size:.85rem; }
    .empty-state{ color:#6c757d; font-size:.9rem; }
    .clickable { cursor:pointer; }
  </style>
</head>
<body class="bg-light p-3">

<div id="navbar-host"></div>
<script type="module" src="/shared/navbar-inject.js"></script>

<div class="container py-4">
  <h3 class="mb-4">Open Job Posts</h3>

  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span class="fw-semibold">Open Job Posts</span>
      <a href="/Company/company-job-list.html" class="btn btn-sm btn-outline-secondary">View All</a>
    </div>
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Position</th>
            <th>Ship</th>
            <th>Location</th>
            <th>Applications</th>
            <th>Status</th>
            <th>Posted</th>
            <th style="width:90px">Actions</th>
          </tr>
        </thead>
        <tbody id="openJobs">
          <tr><td colspan="7" class="empty-state text-center">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Applications Modal -->
<div class="modal fade" id="appsModal" tabindex="-1" aria-labelledby="appsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="appsModalLabel">Applications</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="appsJobMeta" class="small text-muted mb-2"></div>
        <ul id="appsList" class="list-group list-group-flush">
          <li class="list-group-item empty-state">Loading…</li>
        </ul>
      </div>
      <div class="modal-footer">
        <a id="appsManageLink" href="/Company/company-applications.html" class="btn btn-outline-primary btn-sm">Manage Applications</a>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  if ((localStorage.getItem('role')||'').toLowerCase() !== 'company') {
    location.href='/index.html';
  }

  import { auth, db } from '/firebase-config.js';
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import {
    collection, getDocs
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // Utils
  function tsToDate(val){
    try{
      if(!val) return null;
      if (typeof val === 'number') return new Date(val);
      if (typeof val === 'string') return new Date(val);
      if (val.toDate) return val.toDate();
    }catch(e){}
    return null;
  }
  function fmtDate(val){
    const d = tsToDate(val); if(!d || isNaN(d)) return '-';
    return d.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'2-digit'});
  }
  function badgeForStatus(s){
    const map = { open:'success', active:'primary', closed:'secondary', draft:'warning' };
    const key = (s||'').toLowerCase(); const cls = map[key] || 'secondary';
    return `<span class="badge text-bg-${cls}">${s||'—'}</span>`;
  }

  // Flexible matcher: try to associate apps with a job by several common fields
  function matchApplicationToJob(app, job){
    const jid = (job.id||'').toString();
    const byId = (app.jobId||'').toString() === jid || (app.jobDocId||'').toString() === jid;
    const byRef = (app.jobRefPath||'').endsWith('/'+jid) ||
                  (app.jobRef && typeof app.jobRef.path==='string' && app.jobRef.path.endsWith('/'+jid));
    return byId || byRef;
  }

  // Render modal
  function openAppsModal(job, apps){
    const listEl = document.getElementById('appsList');
    const metaEl = document.getElementById('appsJobMeta');
    const titleEl = document.getElementById('appsModalLabel');
    const manageLink = document.getElementById('appsManageLink');

    titleEl.textContent = `Applications – ${job.title}`;
    metaEl.textContent = `${job.ship ? job.ship+' • ' : ''}${job.location || '-' } • Posted ${fmtDate(job.createdAt)}`;
    manageLink.href = '/Company/company-applications.html';

    listEl.innerHTML = '';
    if(apps.length === 0){
      listEl.innerHTML = `<li class="list-group-item empty-state">No applications yet.</li>`;
    } else {
      apps.sort((a,b)=> (tsToDate(b.createdAt)?.getTime()||0) - (tsToDate(a.createdAt)?.getTime()||0));
      apps.forEach(a=>{
        const item = document.createElement('li');
        const name = a.applicantName || a.name || a.fullName || a.displayName || a.email || 'Unknown applicant';
        const rank = a.rank || a.position || '';
        const when = fmtDate(a.createdAt || a.appliedAt);
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.innerHTML = `
          <div>
            <div class="fw-semibold">${name}</div>
            <div class="small text-muted">${rank ? rank+' • ' : ''}${when}</div>
          </div>
          <div class="text-end small text-muted">${a.email ? a.email : ''}</div>
        `;
        listEl.appendChild(item);
      });
    }

    const modal = new bootstrap.Modal(document.getElementById('appsModal'));
    modal.show();
  }

  onAuthStateChanged(auth, async user=>{
    if(!user){ location.href='/index.html'; return; }
    const uid = user.uid;

    // Pull jobs, ships, applications in parallel
    const [jobsSnap, shipsSnap, appsSnap] = await Promise.all([
      getDocs(collection(db, `companies/${uid}/jobPosts`)),
      getDocs(collection(db, `companies/${uid}/ships`)),
      getDocs(collection(db, `companies/${uid}/applications`))
    ]);

    // Build ship map: id->name and also allow name directly if job already has it
    const shipMap = {};
    shipsSnap.forEach(d=>{
      const data = d.data()||{};
      shipMap[d.id] = data.name || data.shipName || data.vesselName || '';
    });

    // Collect all applications
    const allApps = [];
    appsSnap.forEach(d=>{
      const a = d.data()||{};
      allApps.push({
        id: d.id,
        jobId: a.jobId,
        jobDocId: a.jobDocId,
        jobRefPath: a.jobRef?.path || a.jobPath || '',
        applicantName: a.applicantName || a.name || a.fullName,
        rank: a.rank || a.position,
        email: a.email,
        createdAt: a.createdAt || a.appliedAt
      });
    });

    // Prepare jobs
    const jobs = [];
    jobsSnap.forEach(d=>{
      const x = d.data()||{};
      // Resolve ship name: direct field or by shipId/shipDocId
      let shipName = x.ship || x.shipName || '';
      const shipId = x.shipId || x.shipDocId || x.shipDocID || '';
      if(!shipName && shipId && shipMap[shipId]) shipName = shipMap[shipId];

      jobs.push({
        id: d.id,
        title: x.title || x.position || 'Untitled',
        ship: shipName || '-',
        shipId: shipId || '',
        location: x.location || x.port || '',
        status: (x.status || '').toString(),
        createdAt: x.createdAt || x.created_on || x.createdAtTs
      });
    });

    // Filter to open/active and sort newest first
    const openJobs = jobs
      .filter(j => ['open','active'].includes((j.status||'').toLowerCase()))
      .sort((a,b)=>(tsToDate(b.createdAt)?.getTime()||0)-(tsToDate(a.createdAt)?.getTime()||0));

    // Precompute application counts for each job
    const appsByJobId = {};
    openJobs.forEach(j=>{
      const list = allApps.filter(a=>matchApplicationToJob(a, j));
      appsByJobId[j.id] = list;
    });

    // Render table
    const tbody = document.getElementById('openJobs');
    tbody.innerHTML = '';
    if(openJobs.length === 0){
      tbody.innerHTML = `<tr><td colspan="7" class="empty-state text-center">No open job posts.</td></tr>`;
      return;
    }

    openJobs.forEach(j=>{
      const apps = appsByJobId[j.id] || [];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${j.title}</td>
        <td>${j.ship||'-'}</td>
        <td>${j.location||'-'}</td>
        <td>
          <span class="badge rounded-pill text-bg-info clickable" data-job-id="${j.id}">${apps.length}</span>
        </td>
        <td>${badgeForStatus(j.status)}</td>
        <td>${fmtDate(j.createdAt)}</td>
        <td class="text-nowrap">
          <a class="btn btn-sm btn-outline-primary" href="/Company/create-job.html?edit=${encodeURIComponent(j.id)}">Edit</a>
        </td>
      `;
      // click handler for applications badge
      tr.querySelector('[data-job-id]').addEventListener('click', ()=>{
        openAppsModal(j, apps);
      });
      tbody.appendChild(tr);
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
