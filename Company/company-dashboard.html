<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Company Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    .table-sm td, .table-sm th { padding:.35rem .5rem; font-size:.85rem; vertical-align:middle; }
    .empty-state{ color:#6c757d; font-size:.9rem; }
    .clickable{ cursor:pointer; }
    .notes-cell{ max-width:420px; }
    .truncate-1{ overflow:hidden; white-space:nowrap; text-overflow:ellipsis; display:block; }
    .icon-btn{ padding:.25rem .4rem; font-size:.95rem; line-height:1; }
    .w-160{ max-width:160px; }
    .w-140{ max-width:140px; }
    .w-120{ max-width:120px; }
    .w-100{ max-width:100px; }
  </style>
</head>
<body class="bg-light p-3">

<div id="navbar-host"></div>
<script type="module" src="/shared/navbar-inject.js"></script>

<div class="container py-4">
  <h3 class="mb-4">Open Job Posts</h3>

  <div class="card shadow-sm">
    <div class="card-header d-flex justify-content-end gap-2">
      <a href="/Company/company-job-list.html" class="btn btn-sm btn-outline-secondary">View All</a>
      <button id="addRowBtn" class="btn btn-sm btn-primary">
        <i class="bi bi-plus-lg me-1"></i>Add
      </button>
    </div>
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Position</th>
            <th>Ship</th>
            <th>Vessel Type</th>
            <th>Joining Date</th>
            <th>Duration</th>
            <th>Location</th>
            <th>Applications</th>
            <th>Status</th>
            <th>Posted</th>
            <th class="notes-cell">Notes</th>
            <th style="width:92px">Actions</th>
          </tr>
        </thead>
        <tbody id="openJobs">
          <tr><td colspan="11" class="empty-state text-center">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Applications Modal -->
<div class="modal fade" id="appsModal" tabindex="-1" aria-labelledby="appsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="appsModalLabel">Applications</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="appsJobMeta" class="small text-muted mb-2"></div>
        <ul id="appsList" class="list-group list-group-flush">
          <li class="list-group-item empty-state">Loading…</li>
        </ul>
      </div>
      <div class="modal-footer">
        <a id="appsManageLink" href="/Company/company-applications.html" class="btn btn-outline-primary btn-sm">Manage Applications</a>
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  if ((localStorage.getItem('role')||'').toLowerCase() !== 'company') {
    location.href='/index.html';
  }

  import { auth, db } from '/firebase-config.js';
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import {
    collection, getDocs, doc, updateDoc, addDoc, deleteDoc, serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  // ---------- Helpers ----------
  const RANKS = [
    "MASTER","CHIEF OFFICER","2ND OFFICER","3RD OFFICER",
    "CHIEF ENGINEER","2ND ENGINEER","3RD ENGINEER","ETO",
    "AB","OILER","COOK"
  ];
  const VESSEL_TYPES = [
    "Oil - Products Tanker","Oil - Crude/Oil Products Tanker",
    "Chemical Tanker","LNG Carrier","Bulk Carrier","Container Ship"
  ];
  const STATUS_OPTS = ["open","active","closed","draft"];

  function tsToDate(val){
    try{
      if(!val) return null;
      if (typeof val === 'number') return new Date(val);
      if (typeof val === 'string') return new Date(val);
      if (val.toDate) return val.toDate();
    }catch(e){}
    return null;
  }
  function fmtDate(val){
    const d = tsToDate(val); if(!d || isNaN(d)) return '-';
    return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'});
  }
  function toInputDate(val){
    const d = tsToDate(val); if(!d || isNaN(d)) return '';
    const yyyy=d.getFullYear(), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }
  function fromInputDate(s){
    if(!s) return null;
    const d = new Date(s+"T12:00:00"); // tz-safe
    return isNaN(d) ? null : d;
  }
  function badgeForStatus(s){
    const map={open:'success',active:'primary',closed:'secondary',draft:'warning'};
    const key=(s||'').toLowerCase(); const cls=map[key]||'secondary';
    return `<span class="badge text-bg-${cls}">${s||'—'}</span>`;
  }
  const text = (v,f='-') => (v===0?'0':(v||'')).toString().trim()||f;
  const first = (...vals) => { for(const v of vals){ if(v!==undefined && v!==null && v!=='') return v; } return ''; };

  // ---------- State ----------
  let SHIPS = [];      // {id,name}
  let JOBS = [];       // job objects
  let APPS = [];       // all applications
  const appsByJobId = id => APPS.filter(a => {
    const byId = (a.jobId||'')===id || (a.jobDocId||'')===id;
    const byRef = (a.jobRefPath||'').endsWith('/'+id);
    return byId || byRef;
  });

  // ---------- Modal ----------
  function openAppsModal(job){
    const listEl = document.getElementById('appsList');
    const metaEl = document.getElementById('appsJobMeta');
    const titleEl = document.getElementById('appsModalLabel');

    const apps = appsByJobId(job.id);
    titleEl.textContent = `Applications – ${job.title}`;
    metaEl.textContent = `${job.ship ? job.ship+' • ' : ''}${job.location || '-' } • Posted ${fmtDate(job.createdAt)}`;

    listEl.innerHTML = '';
    if(!apps.length){
      listEl.innerHTML = `<li class="list-group-item empty-state">No applications yet.</li>`;
    }else{
      apps.sort((a,b)=>(tsToDate(b.createdAt)?.getTime()||0)-(tsToDate(a.createdAt)?.getTime()||0));
      for(const a of apps){
        const name = first(a.applicantName, a.name, a.fullName, a.displayName, a.email, 'Unknown');
        const rank = first(a.rank, a.position, '');
        const when = fmtDate(first(a.createdAt, a.appliedAt));
        const li = document.createElement('li');
        li.className='list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <div>
            <div class="fw-semibold">${name}</div>
            <div class="small text-muted">${rank ? rank+' • ' : ''}${when}</div>
          </div>
          <div class="text-end small text-muted">${a.email||''}</div>
        `;
        listEl.appendChild(li);
      }
    }
    new bootstrap.Modal(document.getElementById('appsModal')).show();
  }

  // ---------- Rendering ----------
  const tbody = document.getElementById('openJobs');

  function render(){
    tbody.innerHTML = '';
    const list = JOBS
      .filter(j => ['open','active'].includes((j.status||'').toLowerCase()))
      .sort((a,b)=>(tsToDate(b.createdAt)?.getTime()||0)-(tsToDate(a.createdAt)?.getTime()||0));

    if(!list.length){
      tbody.innerHTML = `<tr><td colspan="11" class="empty-state text-center">No open job posts.</td></tr>`;
      return;
    }
    list.forEach(j => tbody.appendChild(renderRow(j)));

    // init tooltips only for notes
    document.querySelectorAll('.notes-tip').forEach(el=> new bootstrap.Tooltip(el));
  }

  function renderRow(job){
    const tr = document.createElement('tr');

    if(job._edit){
      // --- Edit mode row ---
      const shipOpts = ['<option value="">—</option>', ...SHIPS.map(s=>`<option value="${s.id}">${s.name}</option>`)].join('');
      const rankOpts = RANKS.map(r=>`<option value="${r}">`).join('');
      const vtypeOpts = VESSEL_TYPES.map(v=>`<option value="${v}">`).join('');
      const statusOpts = STATUS_OPTS.map(s=>`<option ${s===job.status?'selected':''} value="${s}">${s}</option>`).join('');

      tr.innerHTML = `
        <td class="w-160"><input class="form-control form-control-sm" list="rankList" value="${text(job.title,'')}" placeholder="Rank"/></td>
        <td class="w-160">
          <select class="form-select form-select-sm" data-field="shipId">
            ${shipOpts}
          </select>
        </td>
        <td class="w-160"><input class="form-control form-control-sm" list="vtypeList" value="${text(job.vesselType,'')}" placeholder="Vessel Type"/></td>
        <td class="w-140"><input type="date" class="form-control form-control-sm" value="${toInputDate(job.joiningDate)}"/></td>
        <td class="w-100"><input class="form-control form-control-sm" value="${text(job.duration,'')}" placeholder="e.g. 6 months"/></td>
        <td class="w-160"><input class="form-control form-control-sm" value="${text(job.location,'')}" placeholder="Country/Port"/></td>
        <td>—</td>
        <td class="w-120">
          <select class="form-select form-select-sm" data-field="status">
            ${statusOpts}
          </select>
        </td>
        <td>${fmtDate(job.createdAt)}</td>
        <td class="notes-cell"><input class="form-control form-control-sm" value="${(job.notes||'').replace(/"/g,'&quot;')}" placeholder="Notes"/></td>
        <td class="text-nowrap">
          <button class="btn btn-success btn-sm icon-btn me-1" data-save="${job.id}" title="Save"><i class="bi bi-check-lg"></i></button>
          <button class="btn btn-secondary btn-sm icon-btn" data-cancel="${job.id}" title="Cancel"><i class="bi bi-x-lg"></i></button>
        </td>
      `;

      // set current ship selection
      const sel = tr.querySelector('select[data-field="shipId"]');
      sel.value = job.shipId || '';

      // datalists
      ensureDatalist('rankList', rankOpts);
      ensureDatalist('vtypeList', vtypeOpts);

      // listeners save/cancel
      tr.querySelector(`[data-save="${job.id}"]`).addEventListener('click', ()=> saveRow(job, tr));
      tr.querySelector(`[data-cancel="${job.id}"]`).addEventListener('click', ()=> cancelEdit(job));

    }else{
      // --- View mode row ---
      const apps = appsByJobId(job.id);
      const notesPreview = text(job.notes,'').slice(0,140) + (job.notes && job.notes.length>140 ? '…':'');
      tr.innerHTML = `
        <td>${text(job.title)}</td>
        <td>${text(job.ship,'-')}</td>
        <td>${text(job.vesselType,'-')}</td>
        <td>${fmtDate(job.joiningDate)}</td>
        <td>${text(job.duration,'-')}</td>
        <td>${text(job.location,'-')}</td>
        <td><span class="badge rounded-pill text-bg-info clickable" data-apps="${job.id}">${apps.length}</span></td>
        <td>${badgeForStatus(job.status)}</td>
        <td>${fmtDate(job.createdAt)}</td>
        <td class="notes-cell"><span class="truncate-1 ${job.notes?'notes-tip':''}" ${job.notes?`data-bs-toggle="tooltip" data-bs-title="${(job.notes||'').replace(/"/g,'&quot;')}"`:''}>${notesPreview || '-'}</span></td>
        <td class="text-nowrap">
          <button class="btn btn-outline-primary btn-sm icon-btn me-2" data-edit="${job.id}" title="Edit"><i class="bi bi-pencil"></i></button>
          <button class="btn btn-outline-danger btn-sm icon-btn" data-remove="${job.id}" title="Remove"><i class="bi bi-x-lg"></i></button>
        </td>
      `;
      tr.querySelector(`[data-apps="${job.id}"]`)?.addEventListener('click', ()=> openAppsModal(job));
      tr.querySelector(`[data-edit="${job.id}"]`)?.addEventListener('click', ()=> { job._edit=true; render(); });
      tr.querySelector(`[data-remove="${job.id}"]`)?.addEventListener('click', ()=> removeJob(job));
    }
    tr.dataset.jobid = job.id;
    return tr;
  }

  function ensureDatalist(id, optionsHtml){
    if(!document.getElementById(id)){
      const dl = document.createElement('datalist');
      dl.id = id;
      dl.innerHTML = optionsHtml;
      document.body.appendChild(dl);
    }
  }

  // ---------- CRUD ----------
  async function saveRow(job, tr){
    const inputs = tr.querySelectorAll('td');
    const title = inputs[0].querySelector('input').value.trim();
    const shipSel = inputs[1].querySelector('select');
    const shipId = shipSel.value || null;
    const shipName = shipId ? (SHIPS.find(s=>s.id===shipId)?.name || '') : '';
    const vesselType = inputs[2].querySelector('input').value.trim();
    const joiningDate = fromInputDate(inputs[3].querySelector('input').value);
    const duration = inputs[4].querySelector('input').value.trim();
    const location = inputs[5].querySelector('input').value.trim();
    const status = inputs[7].querySelector('select').value;
    const notes = inputs[9].querySelector('input').value.trim();

    const payload = {
      title, position: title,
      ship: shipName || null, shipName: shipName || null, shipId: shipId || null,
      vesselType,
      joiningDate: joiningDate || null,
      duration, location,
      status,
      notes
    };

    try{
      if(job._isNew){
        // create
        const ref = await addDoc(collection(db, `companies/${auth.currentUser.uid}/jobPosts`), {
          ...payload,
          createdAt: serverTimestamp()
        });
        job.id = ref.id;
        job.createdAt = new Date();
        job._isNew = false;
      }else{
        await updateDoc(doc(db, `companies/${auth.currentUser.uid}/jobPosts/${job.id}`), payload);
      }
      // update local
      Object.assign(job, payload, { ship: shipName || '-', _edit:false });
      render();
    }catch(e){
      alert('Save failed: ' + (e?.message||e));
    }
  }

  function cancelEdit(job){
    if(job._isNew){
      // drop the row
      JOBS = JOBS.filter(x=>x!==job);
    }else{
      job._edit=false;
    }
    render();
  }

  async function removeJob(job){
    if(!confirm('Delete this job post?')) return;
    try{
      await deleteDoc(doc(db, `companies/${auth.currentUser.uid}/jobPosts/${job.id}`));
      JOBS = JOBS.filter(x=>x.id!==job.id);
      render();
    }catch(e){
      alert('Delete failed: ' + (e?.message||e));
    }
  }

  // ---------- Boot ----------
  onAuthStateChanged(auth, async user=>{
    if(!user){ location.href='/index.html'; return; }
    const uid = user.uid;

    const [jobsSnap, shipsSnap, appsSnap] = await Promise.all([
      getDocs(collection(db, `companies/${uid}/jobPosts`)),
      getDocs(collection(db, `companies/${uid}/ships`)),
      getDocs(collection(db, `companies/${uid}/applications`))
    ]);

    // ships
    SHIPS = [];
    shipsSnap.forEach(d=>{
      const s = d.data()||{};
      SHIPS.push({ id:d.id, name:first(s.name, s.shipName, s.vesselName, d.id) });
    });

    // apps
    APPS = [];
    appsSnap.forEach(d=>{
      const a=d.data()||{};
      APPS.push({
        id:d.id,
        jobId:a.jobId, jobDocId:a.jobDocId, jobRefPath:a.jobRef?.path || a.jobPath || '',
        applicantName:first(a.applicantName,a.name,a.fullName),
        rank:first(a.rank,a.position),
        email:a.email,
        createdAt:first(a.createdAt,a.appliedAt)
      });
    });

    // jobs
    JOBS = [];
    jobsSnap.forEach(d=>{
      const x=d.data()||{};
      let shipName = first(x.ship, x.shipName, '');
      const shipId = first(x.shipId, x.shipDocId, x.shipDocID, '');
      if(!shipName && shipId){
        const sh = SHIPS.find(s=>s.id===shipId);
        if(sh) shipName = sh.name;
      }
      JOBS.push({
        id:d.id,
        title:first(x.title,x.position,'Untitled'),
        ship: shipName || '-',
        shipId: shipId || '',
        vesselType:first(x.vesselType,x.type,''),
        joiningDate:first(x.joiningDate,x.onboardDate,x.embarkationDate),
        duration:first(x.duration,x.contractDuration,''),
        location:first(x.location,x.port,''),
        notes:first(x.notes,x.description,x.requirements,''),
        status:(x.status||'').toString(),
        createdAt:first(x.createdAt,x.created_on,x.createdAtTs)
      });
    });

    render();

    // Add new row
    document.getElementById('addRowBtn').addEventListener('click', ()=>{
      const j = {
        id: 'new-'+Date.now(),
        title: '', ship:'-', shipId:'',
        vesselType:'', joiningDate:null, duration:'', location:'',
        notes:'', status:'open', createdAt:new Date(),
        _edit:true, _isNew:true
      };
      JOBS.unshift(j);
      render();
      // focus first input
      const row = tbody.querySelector('tr[data-jobid="'+j.id+'"] input');
      if(row) row.focus();
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
