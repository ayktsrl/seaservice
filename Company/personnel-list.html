<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Personnel List</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#f6f7fb}
    .card{border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.05)}
    .table thead th{position:sticky; top:0; background:#fff; z-index:1}
    .table td, .table th{vertical-align:middle}
    .pill{display:inline-block; padding:.25rem .5rem; border-radius:9999px; font-size:.8rem}
    .pill-yellow{background:#fff3cd}
    .pill-red{background:#f8d7da}
    .pill-green{background:#d1e7dd}
    .toolbar .form-select, .toolbar .form-control{min-width:160px}
    .badge-title{font-weight:600; letter-spacing:.3px}
  </style>
</head>
<body class="p-3">

  <div id="navbar-host"></div>
  <script type="module" src="/shared/navbar-inject.js"></script>

  <div class="container py-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h4 class="m-0">Personnel List</h4>
      <div class="d-flex gap-2">
        <button id="btnCsv"   class="btn btn-outline-secondary btn-sm">Export CSV</button>
        <button id="btnExcel" class="btn btn-outline-primary btn-sm">Export Excel</button>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-2 toolbar">
          <div class="col-md-3">
            <input id="q" class="form-control" placeholder="Search (name, email, rank, vessel)"/>
          </div>
          <div class="col-md-3">
            <select id="fltVessel" class="form-select">
              <option value="">All Vessels</option>
            </select>
          </div>
          <div class="col-md-3">
            <select id="fltAgent" class="form-select">
              <option value="">All Manning Agents</option>
            </select>
          </div>
          <div class="col-md-3">
            <select id="fltRank" class="form-select">
              <option value="">All Ranks</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" id="tbl">
          <thead>
            <tr>
              <th>Status</th>
              <th>Manning Agent</th>
              <th>Last Name</th>
              <th>First Name</th>
              <th>Email</th>
              <th>DOB</th>
              <th>Nationality</th>
              <th>Rank</th>
              <th>Vessel</th>
              <th>Sign-On</th>
              <th>Due/Sign-Off</th>
              <th>Last Vessel</th>
              <th>Last Sign-Off</th>
              <th class="text-center">Ctr. Days Left</th>
              <th class="text-center">Assigned</th>
              <th class="text-center">Cert. Days Left</th>
              <th>Remarks</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="17" class="text-center text-muted py-4">Loading…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="d-flex justify-content-between align-items-center p-2">
        <div class="small text-muted"><span id="countShown">0</span> / <span id="countTotal">0</span> records</div>
        <div class="d-flex align-items-center gap-2">
          <label class="small text-muted">Page size</label>
          <select id="pageSize" class="form-select form-select-sm" style="width:90px">
            <option>25</option><option selected>50</option><option>100</option>
          </select>
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" id="prevPage">«</button>
            <button class="btn btn-outline-secondary" id="nextPage">»</button>
          </div>
          <span class="small text-muted" id="pageInfo">Page 1</span>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    if ((localStorage.getItem('role')||'').toLowerCase() !== 'company') location.href='/index.html';

    import { auth, db } from '/firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const q         = document.getElementById('q');
    const fltVessel = document.getElementById('fltVessel');
    const fltAgent  = document.getElementById('fltAgent');
    const fltRank   = document.getElementById('fltRank');
    const tbody     = document.getElementById('tbody');
    const countShown= document.getElementById('countShown');
    const countTotal= document.getElementById('countTotal');
    const pageSize  = document.getElementById('pageSize');
    const prevPage  = document.getElementById('prevPage');
    const nextPage  = document.getElementById('nextPage');
    const pageInfo  = document.getElementById('pageInfo');
    const btnCsv    = document.getElementById('btnCsv');
    const btnExcel  = document.getElementById('btnExcel');

    let allRows = [];    // raw
    let viewRows = [];   // filtered
    let page = 1;

    const fmtDate = (d)=> {
      if(!d) return '';
      const x = (d instanceof Date) ? d : new Date(d);
      if (Number.isNaN(+x)) return '';
      return x.toISOString().slice(0,10);
    };

    const daysLeft = (date)=> {
      if(!date) return null;
      const d = (date instanceof Date) ? date : new Date(date);
      if (Number.isNaN(+d)) return null;
      const ms = d.setHours(0,0,0,0) - new Date().setHours(0,0,0,0);
      return Math.round(ms/86400000);
    };

    const pill = (n, type) => {
      if(n===null || n===undefined || n==='') return '';
      const cls = type==='cert'
        ? (n < 0 ? 'pill-red' : (n <= 60 ? 'pill-yellow' : 'pill-green'))
        : (n < 0 ? 'pill-red' : (n <= 30 ? 'pill-yellow' : 'pill-green'));
      return `<span class="pill ${cls}">${n}</span>`;
    };

    const normalize = (v)=> (v||'').toString().toLowerCase().trim();

    const applyFilters = ()=>{
      const qv = normalize(q.value);
      const fv = normalize(fltVessel.value);
      const fa = normalize(fltAgent.value);
      const fr = normalize(fltRank.value);

      viewRows = allRows.filter(r=>{
        const hitQ = !qv || [
          r.firstName, r.lastName, r.email, r.rank, r.vessel, r.nationality, r.agent
        ].some(x=>normalize(x).includes(qv));
        const hitV = !fv || normalize(r.vessel)===fv;
        const hitA = !fa || normalize(r.agent)===fa;
        const hitR = !fr || normalize(r.rank)===fr;
        return hitQ && hitV && hitA && hitR;
      });

      countTotal.textContent = allRows.length;
      page = 1;
      render();
    };

    const render = ()=>{
      // pagination
      const size = parseInt(pageSize.value,10) || 50;
      const start = (page-1)*size;
      const slice = viewRows.slice(start, start+size);

      tbody.innerHTML = '';
      if(!slice.length){
        tbody.innerHTML = '<tr><td colspan="17" class="text-center text-muted py-4">No records</td></tr>';
      } else {
        for (const r of slice){
          const ctr = daysLeft(r.dueSignOff);
          const cert = (typeof r.certDaysLeft==='number') ? r.certDaysLeft : '';
          const assigned = r.assignedToVessel ? 'Yes' : 'No';
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${r.status||'—'}</td>
            <td>${r.agent||'—'}</td>
            <td class="text-nowrap">${r.lastName||''}</td>
            <td class="text-nowrap">${r.firstName||''}</td>
            <td class="text-nowrap">${r.email||''}</td>
            <td>${fmtDate(r.dob)}</td>
            <td>${r.nationality||''}</td>
            <td>${r.rank||''}</td>
            <td>${r.vessel||''}</td>
            <td>${fmtDate(r.signOn)}</td>
            <td>${fmtDate(r.dueSignOff)}</td>
            <td>${r.lastVesselName||''}</td>
            <td>${fmtDate(r.lastSignOffDate)}</td>
            <td class="text-center">${pill(ctr,'ctr')}</td>
            <td class="text-center">${assigned}</td>
            <td class="text-center">${cert!=='' ? pill(cert,'cert') : ''}</td>
            <td>${r.remarks||''}</td>
          `;
          tbody.appendChild(row);
        }
      }
      countShown.textContent = viewRows.length;
      const totalPages = Math.max(1, Math.ceil(viewRows.length / (parseInt(pageSize.value,10)||50)));
      pageInfo.textContent = `Page ${Math.min(page,totalPages)} / ${totalPages}`;
      prevPage.disabled = page<=1;
      nextPage.disabled = page>=totalPages;
    };

    const toCsv = (rows)=>{
      const head = ['Status','Manning Agent','Last Name','First Name','Email','DOB','Nationality','Rank','Vessel','Sign-On','Due/Sign-Off','Last Vessel','Last Sign-Off','CtrDaysLeft','Assigned','CertDaysLeft','Remarks'];
      const lines = [head.join(',')];
      for (const r of rows){
        const ctr = daysLeft(r.dueSignOff);
        const cert = (typeof r.certDaysLeft==='number') ? r.certDaysLeft : '';
        const vals = [
          r.status||'',
          r.agent||'',
          r.lastName||'',
          r.firstName||'',
          r.email||'',
          fmtDate(r.dob),
          r.nationality||'',
          r.rank||'',
          r.vessel||'',
          fmtDate(r.signOn),
          fmtDate(r.dueSignOff),
          r.lastVesselName||'',
          fmtDate(r.lastSignOffDate),
          (ctr??''),
          r.assignedToVessel ? 'Yes':'No',
          cert,
          (r.remarks||'').replace(/\n/g,' ').replace(/,/g,';')
        ];
        lines.push(vals.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','));
      }
      return lines.join('\n');
    };

    const download = (blob, filename)=>{
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=filename;
      a.click();
      URL.revokeObjectURL(a.href);
    };

    btnCsv.addEventListener('click', ()=>{
      const csv = toCsv(viewRows);
      download(new Blob([csv], {type:'text/csv;charset=utf-8'}), 'personnel-list.csv');
    });

    btnExcel.addEventListener('click', ()=>{
      // Simple Excel-compatible CSV
      const csv = toCsv(viewRows);
      download(new Blob([csv], {type:'application/vnd.ms-excel'}), 'personnel-list.xls');
    });

    q.addEventListener('input', applyFilters);
    [fltVessel, fltAgent, fltRank, pageSize].forEach(el=>el.addEventListener('change', applyFilters));
    prevPage.addEventListener('click', ()=>{ if(page>1){ page--; render(); }});
    nextPage.addEventListener('click', ()=>{ const size=parseInt(pageSize.value,10)||50; if(page*size<viewRows.length){ page++; render(); }});

    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href='/index.html';
      // Fleet ships -> crew aggregate
      // Assumption: companies/{companyId}/ships/{shipId}/crew/{crewUserId}
      const shipsSnap = await getDocs(collection(db, `companies/${user.uid}/ships`));

      const uniqueVessels = new Set();
      const uniqueAgents  = new Set();
      const uniqueRanks   = new Set();
      allRows = [];

      for (const sDoc of shipsSnap.docs){
        const ship = sDoc.data();
        const crewSnap = await getDocs(collection(db, `companies/${user.uid}/ships/${sDoc.id}/crew`));
        crewSnap.forEach(c=>{
          const d = c.data();
          const row = {
            status: d.status || 'On Board',
            agent: d.manningAgent || ship.manningAgent || '',
            lastName: d.lastName || '',
            firstName: d.firstName || '',
            email: d.email || '',
            dob: d.dob || '',
            nationality: d.nationality || '',
            rank: d.rank || '',
            vessel: ship.name || d.vessel || '',
            signOn: d.signOn || '',
            dueSignOff: d.dueSignOff || '',
            lastVesselName: d.lastVesselName || '',
            lastSignOffDate: d.lastSignOffDate || '',
            assignedToVessel: !!d.assignedToVessel,
            certDaysLeft: typeof d.certDaysLeft==='number' ? d.certDaysLeft : '',
            remarks: d.remarks || ''
          };
          allRows.push(row);
          if (row.vessel) uniqueVessels.add(row.vessel);
          if (row.agent)  uniqueAgents.add(row.agent);
          if (row.rank)   uniqueRanks.add(row.rank);
        });
      }

      // Populate filters
      fltVessel.innerHTML = '<option value="">All Vessels</option>' + [...uniqueVessels].sort().map(v=>`<option>${v}</option>`).join('');
      fltAgent.innerHTML  = '<option value="">All Manning Agents</option>' + [...uniqueAgents].sort().map(v=>`<option>${v}</option>`).join('');
      fltRank.innerHTML   = '<option value="">All Ranks</option>' + [...uniqueRanks].sort().map(v=>`<option>${v}</option>`).join('');

      applyFilters();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
