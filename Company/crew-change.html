<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Crew Change</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{
      --grid-bg:#f6f7fb;
      --panel-bg:#fff;
      --panel-shadow:0 8px 24px rgba(0,0,0,.06);
      --line:#e7e9ef;
      --head:#f2f4f7;
    }
    body{background:var(--grid-bg)}
    .layout{display:grid; grid-template-columns: 260px 1fr; gap:14px; padding:14px}
    .panel{background:var(--panel-bg); border-radius:14px; box-shadow:var(--panel-shadow)}
    .vessel-list{padding:10px 0; height:calc(100vh - 120px); overflow:auto}
    .vessel-item{display:block; padding:8px 14px; color:#2b3; color:#334; text-decoration:none; border-left:3px solid transparent}
    .vessel-item:hover{background:#f6f8ff}
    .vessel-item.active{background:#eef3ff; border-left-color:#0d6efd; font-weight:600}
    .toolbar{padding:10px; border-bottom:1px solid var(--line); display:flex; flex-wrap:wrap; gap:8px}
    .toolbar .btn{white-space:nowrap}
    .grid-wrap{padding:8px}
    .table-grid{width:100%; border-collapse:separate; border-spacing:0}
    .table-grid th, .table-grid td{border:1px solid var(--line); padding:6px 8px; font-size:.92rem; vertical-align:middle}
    .table-grid thead th{position:sticky; top:0; background:var(--head); z-index:2}
    .table-grid tbody tr:hover{background:#fafcff}
    .table-grid .num{text-align:center; white-space:nowrap}
    .muted{color:#8a93a2}
    .link{color:#0d6efd; text-decoration:none}
    .link:hover{text-decoration:underline}
    .days-pill{
      display:inline-block; padding:.2rem .45rem; border-radius:9999px; font-size:.78rem;
      background:#d1e7dd; /* green */
    }
    .days-pending{background:#fff3cd} /* yellow */
    .days-over{background:#f8d7da}    /* red */
    .row-selected{outline:2px solid #0d6efd; outline-offset:-2px}
    .head-title{padding:10px 12px; border-bottom:1px solid var(--line); font-weight:600}
    .sticky-left{position:sticky; left:0; background:#fff; z-index:1}
    .small-note{padding:8px 12px; border-top:1px dashed var(--line); color:#6c757d; font-size:.86rem}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <div id="navbar-host"></div>
  <script type="module" src="/shared/navbar-inject.js"></script>

  <div class="layout">
    <!-- LEFT: VESSEL LIST -->
    <aside class="panel">
      <div class="head-title">Fleet</div>
      <div class="vessel-list" id="vesselList">
        <div class="p-3 text-muted">Loading…</div>
      </div>
      <div class="small-note">
        Sadece bu şirkete ait gemiler gösterilir. Bir gemiyi seçerek mürettebat durumunu izleyin.
      </div>
    </aside>

    <!-- RIGHT: GRID + TOOLBAR -->
    <section class="panel">
      <div class="toolbar">
        <button class="btn btn-sm btn-outline-primary" id="btnAssign" disabled>Assign</button>
        <button class="btn btn-sm btn-outline-primary" id="btnRelease" disabled>Release Reliever</button>
        <button class="btn btn-sm btn-outline-secondary" id="btnChange" disabled>Change</button>
        <button class="btn btn-sm btn-outline-secondary" id="btnPlan" disabled>Plan Update</button>
        <button class="btn btn-sm btn-outline-secondary" id="btnContract" disabled>Contract Update</button>
        <button class="btn btn-sm btn-outline-secondary" id="btnReliefReq" disabled>Relief Request</button>
        <button class="btn btn-sm btn-outline-secondary" id="btnSwapPlan" disabled>Swap Planned</button>
        <button class="btn btn-sm btn-outline-secondary" id="btnSwapOB" disabled>Swap O/B</button>
        <button class="btn btn-sm btn-outline-danger ms-auto" id="btnCancel" disabled>Cancel</button>
      </div>

      <div class="grid-wrap">
        <div class="table-responsive" style="max-height: calc(100vh - 240px);">
          <table class="table-grid" id="grid">
            <thead>
              <tr>
                <th class="sticky-left">Rank</th>
                <th class="sticky-left">Current Personnel</th>
                <th>Ctr. Start</th>
                <th>SignOn</th>
                <th>Due Sign Off</th>
                <th>Vsl Sign Off</th>
                <th>Days Left</th>
                <th>Reliever</th>
                <th>Plan Date</th>
                <th>Comment</th>
                <th>CV</th>
                <th>Status</th>
                <th>Grade</th>
                <th>Cert.</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="14" class="text-center text-muted py-4">Select a vessel</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    if ((localStorage.getItem('role')||'').toLowerCase() !== 'company') location.href='/index.html';

    import { auth, db } from '/firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { collection, getDocs, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const vesselListEl = document.getElementById('vesselList');
    const tbody = document.getElementById('tbody');
    const grid = document.getElementById('grid');

    const actionBtns = [
      'btnAssign','btnRelease','btnChange','btnPlan','btnContract','btnReliefReq','btnSwapPlan','btnSwapOB','btnCancel'
    ].map(id => document.getElementById(id));

    let currentVessel = null;
    let selectedRowIdx = -1;
    let rows = [];

    const rankOrder = [
      'Master','Trainee Master',
      'Chief Officer','2nd Officer','3rd Officer','4th Officer','Junior Officer','Deck Cadet',
      'Chief Engineer','2nd Engineer','3rd Engineer','4th Engineer','Junior Engineer','Engine Cadet',
      'Bosun','Pumpman',
      'Able Seaman','Ordinary Seaman','Fitter','Wiper','Oiler','Cook','Steward'
    ];

    const rankWeight = r => {
      const i = rankOrder.findIndex(x => (x||'').toLowerCase() === (r||'').toLowerCase());
      return i === -1 ? 999 : i;
    };

    const dstr = v => {
      if(!v) return '';
      const d = (v instanceof Date)? v : new Date(v);
      if(Number.isNaN(+d)) return '';
      return d.toISOString().slice(0,10);
    };

    const calcDaysLeft = d => {
      if(!d) return null;
      const t = (d instanceof Date)? d : new Date(d);
      if(Number.isNaN(+t)) return null;
      const ms = t.setHours(0,0,0,0) - new Date().setHours(0,0,0,0);
      return Math.round(ms/86400000);
    };

    const pill = n => {
      if(n==null) return '';
      let cls = 'days-pill';
      if(n < 0) cls += ' days-over';
      else if(n <= 30) cls += ' days-pending';
      return `<span class="${cls}">${n}</span>`;
    };

    function setActionsEnabled(on){
      actionBtns.forEach(btn => btn.disabled = !on);
    }

    function clearSelection(){
      grid.querySelectorAll('tbody tr').forEach(tr => tr.classList.remove('row-selected'));
      selectedRowIdx = -1;
      setActionsEnabled(false);
    }

    function selectRow(idx){
      clearSelection();
      const tr = grid.querySelector(`tbody tr[data-idx="${idx}"]`);
      if(tr){
        tr.classList.add('row-selected');
        selectedRowIdx = idx;
        setActionsEnabled(true);
      }
    }

    function renderRows(){
      tbody.innerHTML = '';
      if(!rows.length){
        tbody.innerHTML = '<tr><td colspan="14" class="text-center text-muted py-4">No crew records</td></tr>';
        return;
      }
      rows
        .sort((a,b)=> rankWeight(a.rank) - rankWeight(b.rank) || (a.lastName||'').localeCompare(b.lastName||''))
        .forEach((r, idx) => {
          const dLeft = calcDaysLeft(r.dueSignOff);
          const tr = document.createElement('tr');
          tr.dataset.idx = idx;
          tr.innerHTML = `
            <td class="sticky-left nowrap">${r.rank || ''}</td>
            <td class="sticky-left">
              ${ (r.cvUrl)
                  ? `<a class="link" href="${r.cvUrl}" target="_blank">${(r.lastName||'').toUpperCase()}, ${(r.firstName||'')}</a>`
                  : `<span class="link">${(r.lastName||'').toUpperCase()}, ${(r.firstName||'')}</span>`
                }
            </td>
            <td class="num">${dstr(r.contractStart) || ''}</td>
            <td class="num">${dstr(r.signOn) || ''}</td>
            <td class="num">${dstr(r.dueSignOff) || ''}</td>
            <td class="num">${dstr(r.vslSignOff) || ''}</td>
            <td class="num">${pill(dLeft)}</td>
            <td>${r.reliever || ''}</td>
            <td class="num">${dstr(r.planDate) || ''}</td>
            <td>${r.comment || ''}</td>
            <td>${r.cvRef || ''}</td>
            <td>${r.status || ''}</td>
            <td class="num">${r.grade || ''}</td>
            <td class="num">${r.cert || ''}</td>
          `;
          tr.addEventListener('click', ()=> selectRow(idx));
          tbody.appendChild(tr);
        });
      setActionsEnabled(false);
    }

    async function loadVessels(user){
      const snap = await getDocs(collection(db, `companies/${user.uid}/ships`));
      const items = [];
      snap.forEach(doc=>{
        const d = doc.data()||{};
        items.push({ id: doc.id, name: d.name || '(No name)' });
      });
      items.sort((a,b)=> a.name.localeCompare(b.name));
      vesselListEl.innerHTML = items.map(v =>
        `<a href="#" class="vessel-item" data-id="${v.id}">${v.name}</a>`
      ).join('') || `<div class="p-3 text-muted">No ships</div>`;

      vesselListEl.querySelectorAll('.vessel-item').forEach(a=>{
        a.addEventListener('click', async (e)=>{
          e.preventDefault();
          vesselListEl.querySelectorAll('.vessel-item').forEach(x=>x.classList.remove('active'));
          a.classList.add('active');
          currentVessel = a.dataset.id;
          await loadCrew(user.uid, currentVessel);
        });
      });
    }

    async function loadCrew(companyUid, shipId){
      clearSelection();
      rows = [];
      tbody.innerHTML = '<tr><td colspan="14" class="text-center text-muted py-4">Loading…</td></tr>';
      const crewSnap = await getDocs(collection(db, `companies/${companyUid}/ships/${shipId}/crew`));
      crewSnap.forEach(doc=>{
        const d = doc.data()||{};
        rows.push({
          rank: d.rank,
          lastName: d.lastName, firstName: d.firstName,
          cvUrl: d.cvUrl || '', cvRef: d.cvRef || '',
          contractStart: d.contractStart || '',
          signOn: d.signOn || '',
          dueSignOff: d.dueSignOff || '',
          vslSignOff: d.vslSignOff || '',
          reliever: d.reliever || '',
          planDate: d.planDate || '',
          comment: d.comment || '',
          status: d.status || '',
          grade: d.grade || '',
          cert: d.cert || ''
        });
      });
      renderRows();
    }

    // Placeholder: aksiyonlar
    actionBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(selectedRowIdx < 0){ return; }
        const r = rows[selectedRowIdx];
        alert(`${btn.textContent} → ${r.rank || ''} ${r.lastName || ''}, ${r.firstName || ''}`);
      });
    });

    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href='/index.html';
      await loadVessels(user);
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
