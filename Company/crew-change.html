<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Crew Change</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    :root{
      --grid-bg:#f6f7fb; --panel-bg:#fff; --panel-shadow:0 8px 24px rgba(0,0,0,.06);
      --line:#e7e9ef; --head:#f2f4f7;
    }
    /* Küçük genel font */
    html,body{font-size:13px; background:var(--grid-bg)}
    .layout{display:grid; grid-template-columns:260px 1fr; gap:14px; padding:14px}
    .panel{background:var(--panel-bg); border-radius:14px; box-shadow:var(--panel-shadow)}
    .head-title{padding:10px 12px; border-bottom:1px solid var(--line); font-weight:600}
    .vessel-list{padding:10px 0; height:calc(100vh - 120px); overflow:auto}
    .vessel-item{display:block; padding:8px 14px; color:#334; text-decoration:none; border-left:3px solid transparent}
    .vessel-item:hover{background:#f6f8ff}
    .vessel-item.active{background:#eef3ff; border-left-color:#0d6efd; font-weight:600}
    .toolbar{padding:8px 10px; border-bottom:1px solid var(--line); display:flex; flex-wrap:wrap; gap:8px}
    .toolbar .btn{white-space:nowrap}

    .grid-wrap{padding:8px}
    .table-grid{width:100%; border-collapse:separate; border-spacing:0; font-size:12px} /* tablo font küçültüldü */
    .table-grid th,.table-grid td{border:1px solid var(--line); padding:5px 6px; vertical-align:middle}
    .table-grid thead th{position:sticky; top:0; background:var(--head); z-index:2}
    .table-grid tbody tr:hover{background:#fafcff}
    .num{text-align:center; white-space:nowrap}
    .nowrap{white-space:nowrap}
    .sticky-left{position:sticky; left:0; background:#fff; z-index:1}
    .sticky-left-2{position:sticky; left:150px; background:#fff; z-index:1} /* 2. sabit kolon (Current Personnel) */
    .row-selected{outline:2px solid #0d6efd; outline-offset:-2px}

    .days-pill{display:inline-block; padding:.15rem .4rem; border-radius:9999px; font-size:11px; background:#d1e7dd}
    .days-pending{background:#fff3cd}
    .days-over{background:#f8d7da}

    /* Çok küçük buton */
    .btn-xxs{padding:.1rem .35rem; font-size:11px; line-height:1; border-radius:6px}
    .small-note{padding:8px 12px; border-top:1px dashed var(--line); color:#6c757d; font-size:.86rem}
  </style>
</head>
<body>
  <div id="navbar-host"></div>
  <script type="module" src="/shared/navbar-inject.js"></script>

  <div class="layout">
    <!-- LEFT: VESSELS -->
    <aside class="panel">
      <div class="head-title">Fleet</div>
      <div class="vessel-list" id="vesselList"><div class="p-3 text-muted">Loading…</div></div>
      <div class="small-note">Bir gemiyi seçince sağdaki grid dolacaktır.</div>
    </aside>

    <!-- RIGHT: GRID + TOOLBAR -->
    <section class="panel">
      <div class="toolbar">
        <button class="btn btn-sm btn-outline-primary"   id="btnAssign"    disabled>Assign</button>
        <button class="btn btn-sm btn-outline-primary"   id="btnRelease"   disabled>Release Reliever</button>
        <button class="btn btn-sm btn-outline-secondary" id="btnChange"    disabled>Change</button>
        <button class="btn btn-sm btn-outline-secondary" id="btnPlan"      disabled>Plan Update</button>
        <button class="btn btn-sm btn-outline-secondary" id="btnContract"  disabled>Contract Update</button>
        <button class="btn btn-sm btn-outline-secondary" id="btnReliefReq" disabled>Relief Request</button>
        <button class="btn btn-sm btn-outline-secondary" id="btnSwapPlan"  disabled>Swap Planned</button>
        <button class="btn btn-sm btn-outline-secondary" id="btnSwapOB"    disabled>Swap O/B</button>
        <button class="btn btn-sm btn-outline-danger ms-auto" id="btnCancel" disabled>Cancel</button>
      </div>

      <div class="grid-wrap">
        <div class="table-responsive" style="max-height: calc(100vh - 240px);">
          <table class="table-grid" id="grid">
            <thead>
              <tr>
                <th class="sticky-left">Rank</th>
                <th class="sticky-left-2">Current Personnel</th>
                <th style="width:70px;">Act</th>
                <th>Ctr. Start</th>
                <th>SignOn</th>
                <th>Due Sign Off</th>
                <th>Vsl Sign Off</th>
                <th>Days Left</th>
                <th>Reliever</th>
                <th>Plan Date</th>
                <th>Comment</th>
                <th>CV</th>
                <th>Status</th>
                <th>Grade</th>
                <th>Cert.</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="15" class="text-center text-muted py-4">Select a vessel</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <script type="module">
    if ((localStorage.getItem('role')||'').toLowerCase() !== 'company') location.href='/index.html';

    import { auth, db } from '/firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const vesselListEl = document.getElementById('vesselList');
    const tbody  = document.getElementById('tbody');
    const grid   = document.getElementById('grid');

    const actionBtns = ['btnAssign','btnRelease','btnChange','btnPlan','btnContract','btnReliefReq','btnSwapPlan','btnSwapOB','btnCancel']
      .map(id => document.getElementById(id));

    /* ===== Rank master list (ekrandaki takıma göre genişletildi) ===== */
    const RANKS = [
      'Master','Trainee Master',
      'Chief Officer','Trainee Chief Officer','2nd Officer','3rd Officer','4th Officer','Junior Officer','Deck Cadet',
      'Chief Engineer','2nd Engineer','3rd Engineer','4th Engineer','Junior Engineer','Engine Cadet',
      'Electrician','Junior Electrician',
      'Bosun','Pumpman',
      'Able Seaman','Ordinary Seaman','Fitter','Wiper','Oiler',
      'Cook','Steward'
    ];
    const rankWeight = r => {
      const i = RANKS.findIndex(x => (x||'').toLowerCase() === (r||'').toLowerCase());
      return i === -1 ? 999 : i;
    };

    // Helpers
    const dstr  = v => { if(!v) return ''; const d=new Date(v); return Number.isNaN(+d)?'':d.toISOString().slice(0,10); };
    const dleft = v => { if(!v) return null; const d=new Date(v); if(Number.isNaN(+d)) return null;
      return Math.round((d.setHours(0,0,0,0) - new Date().setHours(0,0,0,0))/86400000); };
    const pill  = n => n==null ? '' : `<span class="days-pill ${n<0?'days-over':(n<=30?'days-pending':'')}">${n}</span>`;

    function setActionsEnabled(on){ actionBtns.forEach(b=>b.disabled=!on); }
    function clearSelection(){ grid.querySelectorAll('tbody tr').forEach(tr=>tr.classList.remove('row-selected')); setActionsEnabled(false); }
    function selectRow(idx){
      clearSelection();
      const tr = grid.querySelector(`tbody tr[data-idx="${idx}"]`);
      tr?.classList.add('row-selected');
      setActionsEnabled(true);
    }

    let currentVesselId = null;
    let rows = [];      // final visible rows (with placeholders)
    let rawCrew = [];   // fetched crew docs

    function render(){
      tbody.innerHTML = '';
      if(!rows.length){
        tbody.innerHTML = '<tr><td colspan="15" class="text-center text-muted py-4">No crew records</td></tr>';
        return;
      }
      rows
        .sort((a,b)=> rankWeight(a.rank) - rankWeight(b.rank) || (a.lastName||'').localeCompare(b.lastName||''))
        .forEach((r, idx)=>{
          const tr = document.createElement('tr');
          tr.dataset.idx = idx;
          tr.innerHTML = `
            <td class="sticky-left nowrap">${r.rank||''}</td>
            <td class="sticky-left-2">${r.lastName ? `<span class="nowrap">${(r.lastName||'').toUpperCase()}, ${r.firstName||''}</span>` : ''}</td>
            <td class="num">
              <button class="btn btn-outline-primary btn-xxs" data-activate="${idx}" title="Activate row">Activate</button>
            </td>
            <td class="num">${dstr(r.contractStart)||''}</td>
            <td class="num">${dstr(r.signOn)||''}</td>
            <td class="num">${dstr(r.dueSignOff)||''}</td>
            <td class="num">${dstr(r.vslSignOff)||''}</td>
            <td class="num">${pill(dleft(r.dueSignOff))}</td>
            <td>${r.reliever||''}</td>
            <td class="num">${dstr(r.planDate)||''}</td>
            <td>${r.comment||''}</td>
            <td>${r.cvRef||''}</td>
            <td>${r.status||''}</td>
            <td class="num">${r.grade||''}</td>
            <td class="num">${r.cert||''}</td>
          `;
          // satır tıklamayla da seçilebilir
          tr.addEventListener('click', (e)=>{ if(!(e.target && e.target.getAttribute('data-activate')!=null)) selectRow(idx); });
          tbody.appendChild(tr);
        });

      // Activate butonları
      tbody.querySelectorAll('[data-activate]').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.stopPropagation();
          const i = +btn.getAttribute('data-activate');
          selectRow(i);
        });
      });

      setActionsEnabled(false);
    }

    function buildRowsWithPlaceholders(){
      const counts = rawCrew.reduce((m,r)=> (m[r.rank]=(m[r.rank]||0)+1, m), {});
      rows = [...rawCrew];
      // Her rank için en az 1 satır
      RANKS.forEach(rank=>{ if(!counts[rank]) rows.push({ rank }); });
    }

    async function loadFleet(uid){
      const snap = await getDocs(collection(db, `companies/${uid}/ships`));
      const ships = snap.docs.map(d=>({id:d.id, name:(d.data()?.name)||'(No name)'})).sort((a,b)=>a.name.localeCompare(b.name));
      vesselListEl.innerHTML = ships.length
        ? ships.map(s=>`<a href="#" class="vessel-item" data-id="${s.id}">${s.name}</a>`).join('')
        : '<div class="p-3 text-muted">No ships</div>';

      vesselListEl.querySelectorAll('.vessel-item').forEach(a=>{
        a.addEventListener('click', async (e)=>{
          e.preventDefault();
          vesselListEl.querySelectorAll('.vessel-item').forEach(x=>x.classList.remove('active'));
          a.classList.add('active');
          currentVesselId = a.dataset.id;
          await loadCrew(uid, currentVesselId);
        });
      });

      // İlk gemiyi otomatik seç
      if (ships[0]) vesselListEl.querySelector(`[data-id="${ships[0].id}"]`)?.click();
    }

    async function loadCrew(uid, shipId){
      clearSelection();
      tbody.innerHTML = '<tr><td colspan="15" class="text-center text-muted py-4">Loading…</td></tr>';

      rawCrew = [];
      const crewSnap = await getDocs(collection(db, `companies/${uid}/ships/${shipId}/crew`));
      crewSnap.forEach(doc=>{
        const d = doc.data()||{};
        rawCrew.push({
          rank: d.rank,
          firstName: d.firstName, lastName: d.lastName,
          contractStart: d.contractStart, signOn: d.signOn, dueSignOff: d.dueSignOff, vslSignOff: d.vslSignOff,
          reliever: d.reliever, planDate: d.planDate, comment: d.comment,
          cvRef: d.cvRef, status: d.status, grade: d.grade, cert: d.cert
        });
      });

      buildRowsWithPlaceholders();
      render();
    }

    // Placeholder aksiyonlar (iş mantığını sonra bağlarız)
    actionBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const sel = grid.querySelector('tbody tr.row-selected');
        if(!sel) return;
        const r = rows[+sel.dataset.idx] || {};
        alert(`${btn.textContent} → ${r.rank||''} ${r.lastName||''} ${r.firstName||''}`);
      });
    });

    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href='/index.html';
      await loadFleet(user.uid);
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
