<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Job Details - Company</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    .box{background:#fff;border-radius:12px;padding:22px;box-shadow:0 8px 24px rgba(0,0,0,.06)}
  </style>
</head>
<body class="bg-light p-3">

  <!-- NAVBAR -->
  <div id="navbar-host"></div>
  <script type="module" src="/shared/navbar-inject.js"></script>

  <div class="container py-4">
    <div class="box">
      <h4 id="title" class="mb-3">Job Post Details</h4>
      <div id="details" class="mb-3">Loading...</div>
      <div class="d-flex flex-wrap gap-2">
        <a class="btn btn-secondary" href="/Company/company-dashboard.html">Back</a>
        <button class="btn btn-outline-primary" onclick="window.print()">Print</button>
        <button class="btn btn-warning" id="btnClose">Close Job</button>
        <a class="btn btn-info text-white" id="btnApps">Applications</a>
      </div>
    </div>
  </div>

  <script type="module">
    if ((localStorage.getItem('role')||'').toLowerCase() !== 'company') location.href='/index.html';

    import { auth, db } from '/firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const params=new URLSearchParams(location.search); const jobId=params.get('id');
    const title=document.getElementById('title'); const details=document.getElementById('details');
    const appsBtn=document.getElementById('btnApps'); const closeBtn=document.getElementById('btnClose');

    let jobRef=null;

    function fmtDate(v){ try{ if(v?.toDate) return v.toDate().toLocaleString(); if(v) return new Date(v).toLocaleString(); }catch{} return '-'; }

    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href='/index.html';
      jobRef=doc(db, `companies/${user.uid}/jobPosts`, jobId);
      const snap=await getDoc(jobRef);
      const job=snap.data();
      if(!job){ details.innerHTML=`<div class="text-danger">Job not found.</div>`; return; }
      title.textContent = `${job.position || 'Position'} â€¢ Details`;
      details.innerHTML=`
        <div class="row g-2">
          <div class="col-md-6"><b>Position:</b> ${job.position||'-'}</div>
          <div class="col-md-6"><b>Vessel:</b> ${job.vesselName||'-'} (${job.vesselType||'-'})</div>
          <div class="col-md-6"><b>Joining Date:</b> ${job.joiningDate||'-'}</div>
          <div class="col-md-6"><b>Duration:</b> ${job.duration||'-'}</div>
          <div class="col-md-6"><b>Location:</b> ${job.location||'-'}</div>
          <div class="col-md-6"><b>Status:</b> <span class="badge text-bg-${(job.status||'open')==='open'?'success':(job.status==='closed'?'secondary':'warning')}">${job.status||'-'}</span></div>
          <div class="col-12"><b>Notes:</b><br>${(job.notes||'-').replace(/\n/g,'<br>')}</div>
          <div class="col-12"><b>Created At:</b> ${fmtDate(job.createdAt)}</div>
        </div>`;

      appsBtn.href = `/Company/company-applications.html?jobId=${jobId}`;
    });

    closeBtn?.addEventListener('click', async ()=>{
      if(!jobRef) return; if(!confirm('Close this job?')) return;
      closeBtn.disabled=true; closeBtn.textContent='Closing...';
      try{ await updateDoc(jobRef, { status:'closed' }); location.reload(); }
      catch(e){ alert('Failed: '+(e.message||'unknown')); closeBtn.disabled=false; closeBtn.textContent='Close Job'; }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>