<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Create Job - Company</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/style.css"/>
</head>
<body class="bg-light p-3">

  <!-- NAVBAR -->
  <div id="navbar-host"></div>
  <script type="module" src="/shared/navbar-inject.js"></script>

  <div class="container py-4">
    <h3 class="mb-4">Create Job</h3>
    <form id="jobForm" class="bg-white p-3 rounded shadow-sm" style="max-width:720px">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Position / Rank</label>
          <select id="position" class="form-select" required></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Vessel (from your fleet)</label>
          <select id="vesselName" class="form-select" required></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Vessel Type</label>
          <select id="vesselType" class="form-select" required></select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Joining Date</label>
          <input type="date" id="joiningDate" class="form-control" required/>
        </div>
        <div class="col-md-6">
          <label class="form-label">Duration</label>
          <input type="text" id="duration" class="form-control" placeholder="e.g. 6 months" required/>
        </div>
        <div class="col-md-6">
          <label class="form-label">Location</label>
          <select id="location" class="form-select" required></select>
        </div>
        <div class="col-12">
          <label class="form-label">Notes</label>
          <textarea id="notes" class="form-control" rows="3" placeholder="Requirements, trading area, etc."></textarea>
        </div>
      </div>
      <div class="d-grid d-md-flex gap-2 justify-content-end mt-3">
        <button class="btn btn-primary" type="submit" id="submitBtn">Create</button>
        <a class="btn btn-outline-secondary" href="/Company/company-dashboard.html">Cancel</a>
      </div>
    </form>
  </div>

  <!-- Toast -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:11">
    <div id="toastMsg" class="toast text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toastBody">Ready</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script type="module">
    if ((localStorage.getItem('role')||'').toLowerCase() !== 'company') location.href='/index.html';

    import { auth, db } from '/firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { collection, getDocs, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const tEl = document.getElementById('toastMsg'); const tBody=document.getElementById('toastBody');
    const toast = (m,ok=true)=>{ tBody.textContent=m; tEl.classList.toggle('text-bg-success',ok); tEl.classList.toggle('text-bg-danger',!ok); new bootstrap.Toast(tEl).show(); };

    const selPosition = document.getElementById('position');
    const selVessel   = document.getElementById('vesselName');
    const selVType    = document.getElementById('vesselType');
    const selLoc      = document.getElementById('location');
    const form        = document.getElementById('jobForm');

    let companyId = null;

    async function loadOptions() {
      const [ranks, vtypes, countries] = await Promise.all([
        fetch('/options/options-ranks.html').then(r=>r.text()),
        fetch('/options/options-vessels.html').then(r=>r.text()),
        fetch('/options/options-countries.html').then(r=>r.text())
      ]);
      selPosition.innerHTML = ranks;
      selVType.innerHTML    = vtypes;
      selLoc.innerHTML      = countries;
    }

    async function loadFleet(uid){
      selVessel.innerHTML = `<option value="" disabled selected>Select a ship</option>`;
      const snap = await getDocs(collection(db, `companies/${uid}/ships`));
      const opts = [];
      snap.forEach(s=>{ const d=s.data(); opts.push(`<option value="${d.name}">${d.name}</option>`); });
      if(!opts.length) opts.push(`<option disabled>No ships found</option>`);
      selVessel.innerHTML += opts.join('');
    }

    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href='/index.html';
      companyId = user.uid;
      await loadOptions();
      await loadFleet(companyId);
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = {
        position:    selPosition.value,
        vesselName:  selVessel.value,
        vesselType:  selVType.value,
        joiningDate: document.getElementById('joiningDate').value,
        duration:    document.getElementById('duration').value.trim(),
        location:    selLoc.value,
        notes:       document.getElementById('notes').value.trim(),
        status:      'open',
        createdAt:   serverTimestamp()
      };

      // Validation
      const jd = new Date(data.joiningDate);
      const today = new Date(); today.setHours(0,0,0,0);
      if (isNaN(jd) || jd < today) return toast('Joining Date must be today or later', false);
      if (!/^\d+\s+(day|days|week|weeks|month|months)$/i.test(data.duration))
        return toast('Duration like "6 months" or "12 weeks"', false);

      try{
        // 1) company scoped
        const ref = await addDoc(collection(db, `companies/${companyId}/jobPosts`), data);
        // 2) global listing (optional)
        await addDoc(collection(db, 'jobPosts'), { ...data, creatorId:companyId, creatorType:'company' });

        toast('Job created successfully âœ…', true);
        setTimeout(()=> location.href = `/Company/view-job.html?id=${ref.id}`, 500);
      }catch(err){
        console.error(err);
        toast('Failed: '+(err.message||'unknown'), false);
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>