<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Applications - Company</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/style.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    .card .badge{align-self:flex-start}
  </style>
</head>
<body class="bg-light">

  <!-- NAVBAR -->
  <div id="navbar-host"></div>
  <script type="module" src="/shared/navbar-inject.js"></script>

  <div class="container py-4">
    <div class="d-flex flex-wrap justify-content-between gap-2 mb-3">
      <input id="searchInput" class="form-control form-control-sm w-100 w-md-50" placeholder="Search applications..."/>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-success" id="btnExcel">Export to Excel</button>
        <button class="btn btn-sm btn-outline-danger"  id="btnPdf">Export to PDF</button>
      </div>
    </div>
    <div id="applicationList" class="row g-3"></div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Application Details</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body" id="modalContent">Loading...</div>
        <div class="modal-footer flex-wrap gap-2">
          <a id="viewCvBtn" class="btn btn-info text-white" target="_blank">View CV</a>
          <select id="shipSelect" class="form-select form-select-sm w-auto"></select>
          <input id="hrNote" class="form-control form-control-sm" placeholder="HR Note"/>
          <button class="btn btn-success" id="approveBtn">Approve</button>
          <button class="btn btn-danger"  id="rejectBtn">Reject</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    if ((localStorage.getItem('role')||'').toLowerCase() !== 'company') location.href='/index.html';

    import { auth, db } from '/firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { collection, getDocs, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    let me=null, applications=[], selectedId=null;

    const listEl = document.getElementById('applicationList');
    const shipSelect = document.getElementById('shipSelect');
    const modalContent = document.getElementById('modalContent');
    const hrNote = document.getElementById('hrNote');

    const params = new URLSearchParams(location.search);
    const filterJobId = params.get('jobId');

    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href='/index.html';
      me=user;

      // Load applications
      const aSnap = await getDocs(collection(db, `companies/${me.uid}/applications`));
      applications = aSnap.docs.map(d=>({ id:d.id, ...d.data() }));
      if (filterJobId) applications = applications.filter(a => (a.jobId||'') === filterJobId);

      // Enrich with seafarer names
      applications = await enrichWithSeafarerNames(applications);
      render(applications);

      // Load fleet
      const sSnap = await getDocs(collection(db, `companies/${me.uid}/ships`));
      const ships = sSnap.docs.map(d=>d.data());
      shipSelect.innerHTML = ships.map(s=>`<option value="${s.name}">${s.name}</option>`).join('') || `<option disabled>No ships</option>`;
    });

    async function enrichWithSeafarerNames(arr){
      const out=[];
      for (const a of arr){
        try{
          const pRef = doc(db, 'seafarers', a.seafarerId, 'cv', 'personalDetails');
          const pSnap = await getDoc(pRef);
          out.push({ ...a, fullName:(pSnap.data()?.fullName||'Seafarer') });
        }catch{ out.push({ ...a, fullName:'Seafarer' }); }
      }
      return out;
    }

    function card(a){
      const badge = (a.status||'pending')==='approved' ? 'success' : (a.status==='rejected' ? 'danger' : 'secondary');
      return `
        <div class="col-md-4">
          <div class="card shadow-sm h-100">
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-start">
                <h6 class="mb-1">${a.fullName||'Seafarer'}</h6>
                <span class="badge text-bg-${badge}">${a.status||'pending'}</span>
              </div>
              <div class="small text-muted mb-2">${a.position||'Position'}</div>
              <button class="btn btn-sm btn-primary mt-auto" data-id="${a.id}" data-act="view">View Details</button>
            </div>
          </div>
        </div>`;
    }

    function render(arr){
      if(!arr.length){ listEl.innerHTML=`<p class="text-muted text-center">No applications found.</p>`; return; }
      listEl.innerHTML = arr.map(card).join('');
    }

    document.addEventListener('click', async (e)=>{
      const b=e.target.closest('button'); if(!b) return;
      if(b.getAttribute('data-act')==='view'){
        selectedId=b.getAttribute('data-id');
        const snap=await getDoc(doc(db, `companies/${me.uid}/applications`, selectedId));
        const data=snap.data();
        modalContent.innerText = `Seafarer: ${applications.find(x=>x.id===selectedId)?.fullName||'Seafarer'}\nSeafarer ID: ${data.seafarerId}\nStatus: ${data.status || 'pending'}\nApplied Position: ${data.position||'-'}`;
        document.getElementById('viewCvBtn').href = `/Seafarer/view-cv.html?uid=${data.seafarerId}`;
        hrNote.value = data.hrNote || '';
        new bootstrap.Modal(document.getElementById('detailsModal')).show();
      }
    });

    document.getElementById('approveBtn').addEventListener('click', ()=>updateStatus('approved'));
    document.getElementById('rejectBtn').addEventListener('click',  ()=>updateStatus('rejected'));

    async function updateStatus(status){
      const assignedShip = shipSelect.value || '';
      const note = hrNote.value.trim();
      await updateDoc(doc(db, `companies/${me.uid}/applications`, selectedId), { status, assignedShip, hrNote:note });
      applications = applications.map(x=> x.id===selectedId ? { ...x, status, assignedShip, hrNote:note } : x );
      render(applications);
      bootstrap.Modal.getInstance(document.getElementById('detailsModal')).hide();
    }

    // Export
    document.getElementById('btnExcel').addEventListener('click', ()=>{
      if(!applications.length) return alert('No data');
      const data = applications.map(a=>({ Name:a.fullName||'Seafarer', Position:a.position, Status:a.status||'pending', AssignedShip:a.assignedShip||'', Note:a.hrNote||'' }));
      const ws=XLSX.utils.json_to_sheet(data); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Applications'); XLSX.writeFile(wb,'applications.xlsx');
    });

    document.getElementById('btnPdf').addEventListener('click', ()=>{
      if(!applications.length) return alert('No data');
      const { jsPDF } = window.jspdf; const pdf=new jsPDF(); let y=10;
      applications.forEach(a=>{ pdf.text(`Name: ${a.fullName||'Seafarer'}`,10,y); y+=6; pdf.text(`Position: ${a.position||'-'}`,10,y); y+=6; pdf.text(`Status: ${a.status||'pending'}`,10,y); y+=6; pdf.text(`Assigned Ship: ${a.assignedShip||'-'}`,10,y); y+=6; pdf.text(`Note: ${a.hrNote||'-'}`,10,y); y+=10; });
      pdf.save('applications.pdf');
    });

    // Search
    document.getElementById('searchInput').addEventListener('input', e=>{
      const t=e.target.value.toLowerCase();
      const f=applications.filter(a=>
        (a.fullName||'').toLowerCase().includes(t)||
        (a.position||'').toLowerCase().includes(t)||
        (a.status||'').toLowerCase().includes(t)||
        (a.assignedShip||'').toLowerCase().includes(t)||
        (a.hrNote||'').toLowerCase().includes(t)
      );
      render(f);
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>