<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Seafarer CV Browser - Company</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/style.css"/>
  <style>
    .cv-card{border:1px solid #e7e9ee;background:#fff;border-radius:12px;padding:16px;margin-bottom:14px;transition:box-shadow .2s}
    .cv-card:hover{box-shadow:0 8px 24px rgba(0,0,0,.06)}
    @media(max-width:768px){ .btn-sm{width:100%} }
  </style>
</head>
<body class="bg-light p-3">
  <!-- Navbar -->
  <div id="navbar-container"></div>
  <script>
    fetch('/shared/common-navbar.html').then(r=>r.text()).then(h=>{
      const c=document.getElementById('navbar-container'); c.innerHTML=h;
      c.querySelectorAll('script').forEach(s=>{const n=document.createElement('script'); if(s.src)n.src=s.src; else n.textContent=s.textContent; document.body.appendChild(n);});
    });
  </script>

  <div class="container py-3">
    <h4 class="mb-3">Seafarer CVs</h4>
    <input id="searchInput" class="form-control mb-3" placeholder="Search by name, nationality, or rank..."/>
    <div id="cvList"></div>
    <div id="emptyBox" class="text-center text-muted d-none">No seafarers found.</div>
  </div>

  <script type="module">
    if ((localStorage.getItem('role')||'').toLowerCase() !== 'company') location.href='/index.html';

    import { auth, db } from '/firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { collection, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const list = document.getElementById('cvList'); const emptyBox=document.getElementById('emptyBox');
    let all = [];

    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href='/index.html';
      const snap = await getDocs(collection(db,'seafarers'));
      all = [];
      for (const d of snap.docs) {
        const personalRef = doc(db, 'seafarers', d.id, 'cv', 'personalDetails');
        const personal = (await getDoc(personalRef)).data() || {};
        all.push({ id:d.id, ...personal });
      }
      render(all);
    });

    function card(s){
      return `
        <div class="cv-card">
          <h5 class="mb-1">${s.fullName || 'Unnamed'}</h5>
          <div class="row">
            <div class="col-md-6">
              <p class="mb-1"><b>Rank:</b> ${s.rank||'-'}</p>
              <p class="mb-1"><b>DOB:</b> ${s.dob||'-'}</p>
              <p class="mb-1"><b>Nationality:</b> ${s.nationality||'-'}</p>
            </div>
            <div class="col-md-6">
              <p class="mb-1"><b>Phone:</b> ${s.phone||'-'}</p>
              <p class="mb-1"><b>Email:</b> ${s.email||'-'}</p>
              <a class="btn btn-primary btn-sm mt-1" target="_blank" href="/Seafarer/view-cv.html?seafarerId=${s.id}">View Full CV</a>
            </div>
          </div>
        </div>`;
    }

    function render(arr){
      list.innerHTML='';
      if(!arr.length){ emptyBox.classList.remove('d-none'); return; }
      emptyBox.classList.add('d-none');
      list.innerHTML = arr.map(card).join('');
    }

    document.getElementById('searchInput').addEventListener('input', e=>{
      const t=e.target.value.toLowerCase();
      const f=all.filter(s=>
        (s.fullName||'').toLowerCase().includes(t)||
        (s.rank||'').toLowerCase().includes(t)||
        (s.nationality||'').toLowerCase().includes(t)
      );
      render(f);
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
